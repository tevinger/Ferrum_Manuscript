---
title: "Ferrum_Temporal Analysis"
output: html_document
date: "2025-03-14"
editor_options: 
  chunk_output_type: console
---

# Load Packages
```{r}
#install.packages("dataRetrieval")
library(dataRetrieval)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(lubridate)
library(emmeans)
library(lme4)
library(ggeasy)
library(lattice)
library(rstatix)
library(ggsignif)
library(outliers)
library(ggpmisc)
library(ggpubr)
library(r2symbols)
library(stargazer)
library(ggbreak)
library(writexl)
library(ggrepel)
library(stringr)
library(ggthemes)
library(reshape)
library(RColorBrewer)
library(readxl)
library(dplyr)
library(gridExtra)
library(scales)
library(dbscan)
library(mclust)
library(devtools)
library(factoextra)
library(corrplot)
library(ggbiplot)
library(ggcorrplot)
library(GGally)
library(Hmisc)
library(ggbiplot)
library(ggfortify)
library(emmeans)
library(lme4)
library(lmerTest)
library(multcomp)
library(PLS205)
library(readxl)
library(learnr)
library(scatterplot3d)
library(vegan)
library(ggtern)
library(plotrix)
library(smwrBase)
library(smwrData)
library(smwrGraphs)
library(colorBlindness)
library(flextable)
library(officer)
library(dunn.test)
library(multcompView)
library(patchwork)
library(ggpattern)
```

# Download Discharge Data
```{r}
# Set site numbers for the 4 water stations we want to pull data for
site_numbers <- c("15564879", "15743850", "15744500", "15747000")

sites <- whatNWISsites(sites = site_numbers)

view(sites)

write_xlsx(sites, "C:/Users/tayta/Downloads/USGS water stations.xlsx")

# Define the time period
start_date <- "2015-01-01"
end_date <- "2024-12-31"

# Retrieve daily discharge data for all sites
discharge_data <- readNWISdv(
  siteNumbers = site_numbers, 
  parameterCd = "00060", 
  startDate = start_date, 
  endDate = end_date
)

# add site names to site numbers
site_names <- sites %>% 
  dplyr::select(site_no, station_nm)

discharge_data <- left_join(discharge_data, site_names, by = join_by(site_no))

discharge_data <- discharge_data %>%
  mutate(Year = year(Date)) %>%
  dplyr::rename(discharge_cfs = X_00060_00003)

# plot the Q data
library(ggplot2)

q.p <- ggplot(discharge_data, aes(x = Date, y = discharge_cfs, color = station_nm)) +
  geom_line() +
  facet_wrap(station_nm~., scales = "free", ncol = 2)+
  labs(x = "Date",
       y = "Discharge (cfs)") +
  theme_minimal() +
  theme(
    legend.position = "none"
  )

q.p

ggsave(q.p, filename = "02_Hydrographs_Available_Data_2015to2025.png",
       width = 11, height = 7)
```

```{r}


str(discharge_data)

discharge_summary <- discharge_data %>%
  mutate(Period = case_when(
    Year >= 2000 & Year <= 2018 ~ "2000-2018",
    Year >= 2019 & Year <= 2024 ~ "2019-2024",
    TRUE ~ NA_character_  # Assign NA to other years
  )) %>%
  filter(!is.na(Period)) %>%  # Filter only for relevant periods
  group_by(station_nm, Period) %>%
  summarise(
    Mean_Discharge = round(mean(discharge_cfs, na.rm = TRUE), 2),
    SD_Discharge = round(sd(discharge_cfs, na.rm = TRUE), 2),
    .groups = "drop"
  )

view(discharge_summary)

discharge_summary_wide <- discharge_summary %>%
  dplyr::select(-SD_Discharge) %>%
  pivot_wider(
    names_from = Period,
    values_from = Mean_Discharge
  ) %>%
  mutate(difference = .[[3]] - .[[2]])

view(discharge_summary_wide)

write_xlsx(discharge_summary_wide, "C:/Users/tayta/Downloads/Brooks Range Pre and Post Discharge Averages.xlsx")
```



```{r}
# Download data from Wulik station
wulik <- "15747000"

# Define the time period
start_date <- "2000-01-01"
end_date <- "2024-12-31"

# Retrieve daily discharge data for all sites
wulik_discharge_data <- readNWISdv(
  siteNumbers = wulik, 
  parameterCd = "00060", 
  startDate = start_date, 
  endDate = end_date
)

wulik_discharge_data <- wulik_discharge_data %>%
  mutate(Year = year(Date)) %>%
  dplyr::rename(discharge_cfs = X_00060_00003)

# Create period groups and summarize
discharge_summary <- wulik_discharge_data %>%
  mutate(Period = case_when(
    Year >= 2000 & Year <= 2018 ~ "2000-2018",
    Year >= 2019 & Year <= 2024 ~ "2019-2024",
    TRUE ~ NA_character_  # Assign NA to other years
  )) %>%
  filter(!is.na(Period)) %>%  # Filter only for relevant periods
  summarise(
    Mean_Discharge = round(mean(discharge_cfs, na.rm = TRUE), 2),
    SD_Discharge = round(sd(discharge_cfs, na.rm = TRUE), 2),
    .by = Period
  )

view(discharge_summary)

write_xlsx(wulik_discharge_data, "C:/Users/tayta/Downloads/raw Wulik Discharge.xlsx")
write_xlsx(discharge_summary, "C:/Users/tayta/Downloads/Wulik Discharge Summary.xlsx")
```

```{r}
# Download data from Wulik station
Kobuk <- "15744500"

# Define the time period
start_date <- "2000-01-01"
end_date <- "2024-12-31"

# Retrieve daily discharge data for all sites
Kobuk_discharge_data <- readNWISdv(
  siteNumbers = Kobuk, 
  parameterCd = "00060", 
  startDate = start_date, 
  endDate = end_date
)

Kobuk_discharge_data <- Kobuk_discharge_data %>%
  mutate(Year = year(Date)) %>%
  dplyr::rename(discharge_cfs = X_00060_00003)

# Create period groups and summarize
Kobuk_discharge_summary <- Kobuk_discharge_data %>%
  mutate(Period = case_when(
    Year >= 2000 & Year <= 2018 ~ "2000-2018",
    Year >= 2019 & Year <= 2024 ~ "2019-2024",
    TRUE ~ NA_character_  # Assign NA to other years
  )) %>%
  filter(!is.na(Period)) %>%  # Filter only for relevant periods
  summarise(
    Mean_Discharge = round(mean(discharge_cfs, na.rm = TRUE), 2),
    SD_Discharge = round(sd(discharge_cfs, na.rm = TRUE), 2),
    .by = Period
  )

view(Kobuk_discharge_summary)

write_xlsx(Kobuk_discharge_data, "C:/Users/tayta/Downloads/raw Kobuk Discharge.xlsx")
write_xlsx(Kobuk_discharge_summary, "C:/Users/tayta/Downloads/Kobuk Discharge Summary.xlsx")
```

```{r}
Wulik_q.p <- ggplot(wulik_discharge_data, aes(x = Date, y = X_00060_00003, color = site_no)) +
  geom_line() +
  #facet_grid(station_nm~., scales = "free")+
  labs(x = "Date",
       y = "Discharge (cfs)") +
  theme_minimal()

Wulik_q.p
```

# Load Aggie Data
```{r}
Agashashok_River_Data <- read_excel("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Datasheets/Ferrum Manuscript Datasheets/Agashashok_Temporal_Data.xlsx",
                                    sheet = "all_data")
View(Agashashok_River_Data)
```

## Add column for year and season
```{r}
Agashashok_River_Data <- Agashashok_River_Data %>%
mutate(
    sample_collection_year = year(as.Date(sample_collection_date_mm_dd_yy)),
    sample_collection_month = month(as.Date(sample_collection_date_mm_dd_yy), label = TRUE, abbr = FALSE)
  ) %>%
  mutate(
    sample_collection_season = case_when(
      sample_collection_month %in% c("May", "June") ~ "early",
      sample_collection_month == "July" ~ "middle",
      sample_collection_month %in% c("August", "September") ~ "late",
      TRUE ~ NA_character_
    )
  ) %>%
  relocate(sample_collection_year, sample_collection_month, sample_collection_season, .after = SamplingEventID)

View(Agashashok_River_Data)
```

```{r}
# Add a column for the count of each sample site
Aggie_SiteID_counts <- Agashashok_River_Data %>%
  count(SiteID_mod, name = "SiteID_total_count")

view(Aggie_SiteID_counts)

# join the count column to the total df
Agashashok_River_Data_with_counts <- Agashashok_River_Data %>%
 left_join(Aggie_SiteID_counts, by = "SiteID_mod") %>%
  relocate(SiteID_total_count, .after = SiteID_mod)

view(Agashashok_River_Data_with_counts)

# select site ID's that have been sampled at least 5 times
Agashashok_River_Data_filtered <- Agashashok_River_Data_with_counts %>%
  filter(SiteID_total_count > 4)

# list of sites that have been sampled since 2015
site_counts_by_year <- Agashashok_River_Data_filtered %>%
  count(sample_collection_year, SiteID_mod, name = "count_per_year") %>%
  filter(sample_collection_year == "2015")

view(site_counts_by_year)

write_xlsx(site_counts_by_year, "C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Results and Discussion/Aggie temporal sites per subcatchment.xlsx")
```

## Plot SiteID by year
```{r}
sampling_count <- 
  ggplot(Agashashok_River_Data_filtered, aes(x = SiteID_mod, y = SiteID_total_count)) +
  geom_point(aes(color = SiteID_mod)) +
  labs(
    title = "Total Sample Count per Site",
    x = "Site ID",
    y = "Total Count"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)  # tilt labels if many sites
  )

sampling_count
```

## Data for plots
```{r}
Agashashok_for_plots <- Agashashok_River_Data %>%
  #filter(SiteID_mod %in% site_counts_by_year$SiteID_mod) %>% # this was for when I was selecting only a certain set of sites to plot
  dplyr::select(ParkID,
                Watershed,
                #Subcatchment,
                #New_Groups,
                #New_Grouping,
                Field_label,
                SiteID_mod,
                #SiteID_total_count,
                Latitude,
                Longitude,
                sample_collection_year,
                sample_collection_month,
                sample_collection_season,
                #Watershed_Area,
                #Relative_MS_Watershed_Area,
                SamplingEventID,
                #VisualDescription,
                #Site_Classification,
                #Hyd_Classification,
                #Distance_km,
                #Elevation_ft,
                pH,
                Temp_deg_celsius,
                Diss_oxy_mg_per_l,
                Diss_oxy_percent_sat,
                Spec_Cond_microS_per_cm,
                DIC_mgC_per_l,
                Alk_mgCaCO3_per_l,
                DOC_mgC_per_l,
                f_Cl_mg_per_l,
                f_NO3_mgN_per_l,
                f_SO4_mg_per_l,
                f_Ca_mg_l,
                f_Mg_mg_l,
                f_Na_mg_l,
                f_K_mg_l,
                f_SiO2_mg_per_l,
                f_Pb_mcg_per_l,
f_Ag_mcg_per_l,
f_Al_mcg_per_l,
f_As_mcg_per_l,
f_Ba_mcg_per_l,
#f_Be_mcg_per_l,
f_Cd_mcg_per_l,
f_Ce_mcg_per_l,
f_Co_mcg_per_l,
f_Cr_mcg_per_l,
f_Cu_mcg_per_l,
f_Dy_mcg_per_l,
f_Fe_mcg_per_l,
f_La_mcg_per_l,
f_Mn_mcg_per_l,
f_Nd_mcg_per_l,
f_Ni_mcg_per_l,
f_Pr_mcg_per_l,
f_Se_mcg_per_l,
#f_Th_mcg_per_l,
f_Tl_mcg_per_l,
f_U_mcg_per_l,
f_V_mcg_per_l,
f_Y_mcg_per_l,
f_Zn_mcg_per_l
)

Agashashok_for_plots <- Agashashok_for_plots %>%
  mutate(across(11:49, as.numeric))

view(Agashashok_for_plots)
```

# Temporal Analysis with all sites

```{r}
Sulfate_temporal_bp <- Agashashok_for_plots %>%
  filter(sample_collection_season %in% c("early", "late")) %>%
  ggplot(aes(x = as.factor(sample_collection_year), y = f_SO4_mg_per_l, fill = sample_collection_season)) +
  geom_boxplot() +
  scale_y_log10() +
  scale_fill_manual(
    values = c("early" = "#A1E3F9", "late" = "#0a7ea4")
  ) +
  # Add means as text
  #geom_text(data = chloride_season_stats, aes(x = as.factor(Year), y = 0.5, 
                                     #label = paste0("mean =", mean_value), group = Season),
           # position = position_dodge(width = 0.75), size = 3) +
  # Add counts as text
  #geom_vline(xintercept = 4.5, linetype = "dashed", color = "red", size = 1) +
  labs(
    title = "Boxplot of Sulfate Concentration\nby Year and Season",  # Add \n for line break
    x = "Year",
    y = "Sulfate Concentration (mg/L)",
    fill = "Season"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(hjust = 1, size = 24, color = "black", face = "bold", angle = 45),  # Rotate x-axis labels
    plot.title = element_blank(),  # Center and style title
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 25, color = "black", face = "bold"),
    legend.position = "none",
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 17, face = "bold"),
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    panel.background = element_rect(fill = "transparent"), # Panel background
    plot.background = element_rect(fill = "transparent", color = NA) # Plot background
  ) 

Sulfate_temporal_bp
```


## Add Subcatchment Column
```{r}
Agashashok_for_plots <- Agashashok_for_plots %>%
  mutate(
    Subcatchment = case_when(
      startsWith(SiteID_mod, "AN") ~ "North Fork",
      startsWith(SiteID_mod, "AS") ~ "South Fork",
      startsWith(SiteID_mod, "AM") ~ "Main",
      TRUE ~ NA_character_  # Optional: sets others to NA
    )
  ) %>%
  relocate(Subcatchment, .after = Field_label)

Agashashok_for_plots <- Agashashok_for_plots %>%
  mutate(Subcatchment_year = paste(Subcatchment, sample_collection_year, sep = "_")) %>%
  relocate(Subcatchment_year, .after = Subcatchment)
```

# Summary Stats by Subcatment_year
```{r}
elements <- c(
  "pH", "Temp", "Diss_oxy", "Diss_oxy_percent_sat", "Spec_Cond", "DIC", 
  "Alk", "DOC", "f_Cl", "f_NO3", "f_SO4", "f_Ca", "f_Mg", "f_Na", "f_K",
  "f_SiO2",
  "f_Pb", 
  "f_Ag",
  "f_Al",
  "f_As",
  "f_Ba",
  #"f_Be",
  "f_Cd",
  "f_Ce",
  "f_Co",
  "f_Cr",
  "f_Cu",
  "f_Dy",
  "f_Fe",
  "f_La",
  "f_Mn",
  "f_Nd",
  "f_Ni",
  "f_Pr",
  "f_Se",
  #"f_Th",
  "f_Tl",
  "f_U",
  "f_V",
  "f_Y",
  "f_Zn"
)

columns <- c(
  "pH", "Temp_deg_celsius", "Diss_oxy_mg_per_l", "Diss_oxy_percent_sat", "Spec_Cond_microS_per_cm", 
  "DIC_mgC_per_l", "Alk_mgCaCO3_per_l", "DOC_mgC_per_l", "f_Cl_mg_per_l", "f_NO3_mgN_per_l", 
  "f_SO4_mg_per_l", "f_Ca_mg_l", "f_Mg_mg_l", "f_Na_mg_l", "f_K_mg_l",
  "f_SiO2_mg_per_l",
  "f_Pb_mcg_per_l", 
  "f_Ag_mcg_per_l",
  "f_Al_mcg_per_l",
  "f_As_mcg_per_l",
  "f_Ba_mcg_per_l",
  #"f_Be_mcg_per_l",
  #"f_Br_mcg_per_l",
  "f_Cd_mcg_per_l",
  "f_Ce_mcg_per_l",
  "f_Co_mcg_per_l",
  "f_Cr_mcg_per_l",
  "f_Cu_mcg_per_l",
  "f_Dy_mcg_per_l",
  "f_Fe_mcg_per_l",
  "f_La_mcg_per_l",
  "f_Mn_mcg_per_l",
  "f_Nd_mcg_per_l",
  "f_Ni_mcg_per_l",
  "f_Pr_mcg_per_l",
  "f_Se_mcg_per_l",
  #"f_Th_mcg_per_l",
  "f_Tl_mcg_per_l",
  "f_U_mcg_per_l",
  "f_V_mcg_per_l",
  "f_Y_mcg_per_l",
  "f_Zn_mcg_per_l"
)
```

```{r}
# loop for summary stats using rstatix instead of base R
library(dplyr)
library(rstatix)

# Initialize an empty list to store results
summary_stats_list <- list()
quartiles_list <- list()

# Loop through elements and columns
for (i in seq_along(elements)) {
  element <- elements[i]
  column <- columns[i]
  
  # Perform summary operation with a default empty tibble if an error occurs
  summary <- 
    Agashashok_for_plots %>% # to group by New Grouping (seeps included)
    dplyr::select(5,14:52) %>% # all data
    #dplyr::select(2,4,19:82) %>% # New Grouping
    filter(!is.na(.data[[column]])) %>%
     group_by(Subcatchment_year) %>% #This is where you can change what variable you want to group the data by
      get_summary_stats(vars = column, type = "common")

  
  # Calculate Q1 and Q3
  q1_q3 <- 
    Agashashok_for_plots %>% # to group by New Grouping (seeps included)
    dplyr::select(5,14:52) %>% # all data
    #dplyr::select(2,4,19:82) %>% # New Grouping
    filter(!is.na(.data[[column]])) %>%
     group_by(Subcatchment_year) %>% #This is where you can change what variable you want to group the data by
      summarise(
        variable = column,
        Q1 = round(quantile(.data[[column]], probs = 0.25, na.rm = TRUE), 2),
        Q3 = round(quantile(.data[[column]], probs = 0.75, na.rm = TRUE), 2),
        .groups = "drop"
      )
  
  # Combine summary with Q1 and Q3
  #summary_combined <- summary %>%
    #left_join(q1_q3, by = c("New_Grouping", "variable"))
  
  # Store result
  summary_stats_list[[i]] <- summary
  quartiles_list[[i]] <- q1_q3
}

# Combine into one dataframe
summary_df <- do.call(rbind, summary_stats_list)
quartiles_df <- do.call(rbind, quartiles_list)

quartiles_df <- quartiles_df %>%
  mutate(joining = paste(Subcatchment_year, variable, sep = "_"))

summary_df <- summary_df %>%
  mutate(joining = paste(Subcatchment_year, variable, sep = "_"))

view(summary_df) # Grouped by New_Grouping and Watershed
view(quartiles_df)

summary_combined <- summary_df %>%
  left_join(quartiles_df, by = "joining") %>%
  dplyr::select(-joining, -Subcatchment_year.y, -variable.y)

summary_combined <-  summary_combined %>%
  dplyr::rename(variable = variable.x) %>%
  dplyr::rename(Subcatchment_year = Subcatchment_year.x)
view(summary_combined)
#view(summary_df) # grouped by New_Grouping only

#write_xlsx(summary_combined, "C:/Users/tevinger/Downloads/Group with Watersheds summary stats_rstatix.xlsx")
```


# Stats - Pre vs Post onset comparison
```{r}
onset_df <- Agashashok_for_plots %>%
  mutate(temporal_status = case_when(
    sample_collection_year %in% c("2015", "2016", "2017", "2018") ~ "pre",
    sample_collection_year %in% c("2019", "2020", "2021","2022","2023","2024") ~ "post",
    TRUE ~ NA_character_
  )) %>%
  relocate(temporal_status, .after = Subcatchment_year) %>%
  mutate(sub_temp = paste(Subcatchment, temporal_status, sep = "_")) %>%
  relocate(sub_temp, .after = temporal_status)

view(onset_df)
```

```{r}
onset_means <- onset_df %>%
  group_by(Subcatchment, temporal_status) %>%
  summarise(across(
    .cols = where(is.numeric) & !any_of(c("sample_collection_year")),  # exclude non-data numeric columns if needed
    .fns = \(x) mean(x, na.rm = TRUE)
  ), .groups = "drop") %>% # to return an ungrouped data frame 
  dplyr::select(-SiteID_total_count)
  
view(onset_means)

write_xlsx(onset_means, "C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Results and Discussion/Aggie temporal sulfate pre vs post means.xlsx")
```

```{r}
# specific data frames for each subcatchment for statistics
Aggie_Main_onset_df <- onset_df %>%
  filter(Subcatchment == "Main")

Aggie_SF_onset_df <- onset_df %>%
  filter(Subcatchment == "South Fork")

Aggie_NF_onset_df <- onset_df %>%
  filter(Subcatchment == "North Fork")
```

## Sulfate Stats
```{r}
# use onset_df with sub_temp column that has pre and post
library(lme4)
library(emmeans)

AMS_SO4_model <- lm(f_SO4_mg_per_l ~ temporal_status, data = Aggie_Main_onset_df)
AMS_SO4_emm <- emmeans(AMS_SO4_model, ~ temporal_status)
AMS_SO4_contrast <- contrast(AMS_SO4_emm, method = "pairwise")
print(AMS_SO4_contrast)

ANF_SO4_model <- lm(f_SO4_mg_per_l ~ temporal_status, data = Aggie_NF_onset_df)
ANF_SO4_emm <- emmeans(ANF_SO4_model, ~ temporal_status)
ANF_SO4_contrast <- contrast(ANF_SO4_emm, method = "pairwise")
print(ANF_SO4_contrast)

ASF_SO4_model <- lm(f_SO4_mg_per_l ~ temporal_status, data = Aggie_SF_onset_df)
ASF_SO4_emm <- emmeans(ASF_SO4_model, ~ temporal_status)
ASF_SO4_contrast <- contrast(ASF_SO4_emm, method = "pairwise")
print(ASF_SO4_contrast)

# Convert to data frames
df1 <- as.data.frame(AMS_SO4_contrast)
df2 <- as.data.frame(ANF_SO4_contrast)
df3 <- as.data.frame(ASF_SO4_contrast)

# Add a column to identify the model or variable
df1$Subcatchment <- "Main"
df2$Subcatchment <- "NF"
df3$Subcatchment <- "SF"

df1$Variable <- "f_SO4_mg_l"
df2$Variable <- "f_SO4_mg_l"
df3$Variable <- "f_SO4_mg_l"

# Combine them into one data frame
combined_contrasts_SO4 <- bind_rows(df1, df2, df3)

# View the result
view(combined_contrasts_SO4)

write_xlsx(combined_contrasts_SO4, "C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Results and Discussion/Aggie temporal sulfate pre vs post.xlsx")
```

## Alkalinity Stats
```{r}
# use onset_df with sub_temp column that has pre and post
library(lme4)
library(emmeans)

# Models for Alkalinity instead of Sulfate
AMS_Alk_model <- lm(Alk_mgCaCO3_per_l ~ temporal_status, data = Aggie_Main_onset_df)
AMS_Alk_emm <- emmeans(AMS_Alk_model, ~ temporal_status)
AMS_Alk_contrast <- contrast(AMS_Alk_emm, method = "pairwise")
print(AMS_Alk_contrast)

ANF_Alk_model <- lm(Alk_mgCaCO3_per_l ~ temporal_status, data = Aggie_NF_onset_df)
ANF_Alk_emm <- emmeans(ANF_Alk_model, ~ temporal_status)
ANF_Alk_contrast <- contrast(ANF_Alk_emm, method = "pairwise")
print(ANF_Alk_contrast)

ASF_Alk_model <- lm(Alk_mgCaCO3_per_l ~ temporal_status, data = Aggie_SF_onset_df)
ASF_Alk_emm <- emmeans(ASF_Alk_model, ~ temporal_status)
ASF_Alk_contrast <- contrast(ASF_Alk_emm, method = "pairwise")
print(ASF_Alk_contrast)

# Convert to data frames
df1 <- as.data.frame(AMS_Alk_contrast)
df2 <- as.data.frame(ANF_Alk_contrast)
df3 <- as.data.frame(ASF_Alk_contrast)

# Add a column to identify the model or variable
df1$Subcatchment <- "Main"
df2$Subcatchment <- "NF"
df3$Subcatchment <- "SF"

df1$Variable <- "Alk_mgCaCO3_per_l"
df2$Variable <- "Alk_mgCaCO3_per_l"
df3$Variable <- "Alk_mgCaCO3_per_l"

# Combine them into one data frame
combined_contrasts_Alk <- bind_rows(df1, df2, df3)

# View the result
view(combined_contrasts_Alk)

write_xlsx(combined_contrasts_Alk, "C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Results and Discussion/Aggie temporal alkalinity pre vs post.xlsx")
```


# Subcatchment specific Temporal Boxplots
## df
```{r}
temporal_df <- summary_combined %>%
  separate(Subcatchment_year, into = c("Subcatchment", "year"), sep = "_") %>%
  mutate(year = as.integer(year))  # Ensure year is an integer
```

```{r}
# Add missing years
temporal_filled <- temporal_df %>%
  complete(
    Subcatchment,
    variable,
    year = 2015:2024
  ) %>%
  mutate(
    Subcatchment = factor(Subcatchment, levels = c("South Fork", "North Fork", "Main")),
    year = as.character(year),  # ensure year is treated as categorical if needed
    year_sub = interaction(year, Subcatchment, sep = "_")
  ) 
  
```

```{r}
temporal_filled$year_sub <- factor(
  temporal_filled$year_sub,
  levels = c(
    "2015_South Fork", "2015_North Fork", "2015_Main",
    "2016_South Fork", "2016_North Fork", "2016_Main",
    "2017_South Fork", "2017_North Fork", "2017_Main",
    "2018_South Fork", "2018_North Fork", "2018_Main",
    "2019_South Fork", "2019_North Fork", "2019_Main",
    "2020_South Fork", "2020_North Fork", "2020_Main",
    "2021_South Fork", "2021_North Fork", "2021_Main",
    "2022_South Fork", "2022_North Fork", "2022_Main",
    "2023_South Fork", "2023_North Fork", "2023_Main",
    "2024_South Fork", "2024_North Fork", "2024_Main"
  )
)

view(temporal_filled)

temporal_df <- temporal_filled
```

```{r}
temporal_df <- temporal_df %>%
  mutate(year = as.integer(year)) %>%
  complete(
    Subcatchment,
    variable,
    year = seq(2015, 2024, by = 0.5)  # Adds 2015, 2015.5, 2016, ..., 2024
  ) %>%
  mutate(
    Subcatchment = factor(Subcatchment, levels = c("South Fork", "North Fork", "Main")),
    year = as.character(year),  # Optional: only if treating year as a discrete axis
    year_sub = interaction(year, Subcatchment, sep = "_")
  )


temporal_df$year_sub <- factor(
  temporal_df$year_sub,
  levels = c(
  "2015_South Fork", "2015_North Fork", "2015_Main",
  "2015.5_South Fork", "2015.5_North Fork", "2015.5_Main",
  "2016_South Fork", "2016_North Fork", "2016_Main",
  "2016.5_South Fork", "2016.5_North Fork", "2016.5_Main",
  "2017_South Fork", "2017_North Fork", "2017_Main",
  "2017.5_South Fork", "2017.5_North Fork", "2017.5_Main",
  "2018_South Fork", "2018_North Fork", "2018_Main",
  "2018.5_South Fork", "2018.5_North Fork", "2018.5_Main",
  "2019_South Fork", "2019_North Fork", "2019_Main",
  "2019.5_South Fork", "2019.5_North Fork", "2019.5_Main",
  "2020_South Fork", "2020_North Fork", "2020_Main",
  "2020.5_South Fork", "2020.5_North Fork", "2020.5_Main",
  "2021_South Fork", "2021_North Fork", "2021_Main",
  "2021.5_South Fork", "2021.5_North Fork", "2021.5_Main",
  "2022_South Fork", "2022_North Fork", "2022_Main",
  "2022.5_South Fork", "2022.5_North Fork", "2022.5_Main",
  "2023_South Fork", "2023_North Fork", "2023_Main",
  "2023.5_South Fork", "2023.5_North Fork", "2023.5_Main",
  "2024_South Fork", "2024_North Fork", "2024_Main"
)
)

view(temporal_df)
```

## regression data frames
Make a data frame for each subcatchment 
```{r}
Aggie_Main <- temporal_filled %>%
  filter(Subcatchment == "Main")

Aggie_SF <- temporal_filled %>%
  filter(Subcatchment == "South Fork")

Aggie_NF <- temporal_filled %>%
  filter(Subcatchment == "North Fork")
```

## Labels
```{r}
ylab_DOC <- expression(bold(DOC)~(mg~L^-1))
ylab_DIC <- expression(bold(DIC)~(mgC~L^-1))

ylab_Ca <- expression(bold(Ca)~bold((mg~L^-1)))
ylab_Mg <- expression(bold(Mg)~bold((mg~L^-1)))
ylab_Chloride <- expression(bold(Chloride)~bold((mg~L^-1)))
ylab_Sulfate <- expression(bold(SO[4]^-2)~bold((mg~L^-1)))
ylab_SpC <- expression(bold(Specific~Conductivity)~bold((μS~cm^-1)))
ylab_Alk <- expression(bold(Alkalinity~bold((mgCaCO[3]~L^-1))))

north_fork_ticks <- levels(temporal_filled$year_sub)[grepl("North Fork$", levels(temporal_filled$year_sub))]
north_fork_labels <- gsub("_North Fork", "", north_fork_ticks)
```

##Theme
```{r}
temporal_theme <- 
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 16, color = "black", face = "bold"),
    axis.text.x = element_text(size = 12, color = "black", face = "bold"),
    axis.ticks.y = element_line(linewidth = 0.9, color = "black"),  # Thicker y-axis ticks
    axis.ticks.length.y = unit(0.1, "cm"),  # Longer tick marks
    
    axis.ticks.x = element_line(linewidth = 0.9, color = "black"),  # Thicker y-axis ticks
    #axis.ticks.length.x = unit(0.15, "cm"),  # Longer tick marks
    
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "black"),
    legend.position = "top",
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 17, face = "bold", hjust = 0.5),
    
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    #panel.background = element_rect(fill = "white"),
    panel.border = element_rect(fill = NA, color = "black", size = 1.25),
    panel.background = element_rect(fill = "transparent"), # Panel background
    plot.background = element_rect(fill = "transparent", color = NA) # Plot background

  )
```

## Statistics
Regressions to evaluate concentrations over time
```{r}
AMS_sulfate_df <- Aggie_Main %>%
  filter(variable == "f_SO4_mg_per_l") %>%
  mutate(year = as.integer(as.character(year))) # make year continuous 

AMS_sulfate_model <- lm(mean ~ year, data = AMS_sulfate_df)
summary(AMS_sulfate_model)


ANF_sulfate_df <- Aggie_NF %>%
  filter(variable == "f_SO4_mg_per_l") %>%
  mutate(year = as.integer(as.character(year))) # make year continuous 

ANF_sulfate_model <- lm(mean ~ year, data = ANF_sulfate_df)
summary(ANF_sulfate_model)


ASF_sulfate_df <- Aggie_SF %>%
  filter(variable == "f_SO4_mg_per_l") %>%
  mutate(year = as.integer(as.character(year))) # make year continuous 

ASF_sulfate_model <- lm(mean ~ year, data = ASF_sulfate_df)
summary(ASF_sulfate_model)
  
```

```{r}
library(dplyr)
library(purrr)

# Vectors of variable names
elements_2 <- c(
  "pH",  "Spec_Cond", "DIC", "Alk", "DOC", "f_Cl", "f_NO3", "f_SO4", "f_Ca", "f_Mg", "f_Na", "f_K",
  "f_SiO2", "f_Al", "p_Al", "f_As", "p_As", "f_Ba", "p_Ba", "f_Cd", "p_Cd", "f_Ce", "p_Ce",
  "f_Co", "p_Co", "f_Cr", "p_Cr", "f_Cu", "p_Cu", "f_Dy", "p_Dy", "f_Fe", "p_Fe", "f_La", "p_La",
  "f_Mn", "p_Mn", "f_Nd", "p_Nd", "f_Ni", "p_Ni", "f_Pb", "p_Pb", "f_Pr", "p_Pr", "f_Se", "p_Se",
  "f_Tl", "p_Tl", "f_U", "p_U", "f_Y", "p_Y", "f_Zn", "p_Zn", "f_REE", "p_REE"
)

columns_2 <- c(
  "pH", "Spec_Cond_microS_per_cm", "DIC_mgC_per_l", "Alk_mgCaCO3_per_l", "DOC_mgC_per_l", "f_Cl_mg_per_l", "f_NO3_mgN_per_l", 
  "f_SO4_mg_per_l", "f_Ca_mg_l", "f_Mg_mg_l", "f_Na_mg_l", "f_K_mg_l", "f_SiO2_mg_per_l",
  "f_Al_mcg_per_l", "p_Al_mcg_per_l", "f_As_mcg_per_l", "p_As_mcg_per_l", "f_Ba_mcg_per_l", "p_Ba_mcg_per_l",
  "f_Cd_mcg_per_l", "p_Cd_mcg_per_l", "f_Ce_mcg_per_l", "p_Ce_mcg_per_l", "f_Co_mcg_per_l", "p_Co_mcg_per_l",
  "f_Cr_mcg_per_l", "p_Cr_mcg_per_l", "f_Cu_mcg_per_l", "p_Cu_mcg_per_l", "f_Dy_mcg_per_l", "p_Dy_mcg_per_l",
  "f_Fe_mcg_per_l", "p_Fe_mcg_per_l", "f_La_mcg_per_l", "p_La_mcg_per_l", "f_Mn_mcg_per_l", "p_Mn_mcg_per_l",
  "f_Nd_mcg_per_l", "p_Nd_mcg_per_l", "f_Ni_mcg_per_l", "p_Ni_mcg_per_l", "f_Pb_mcg_per_l", "p_Pb_mcg_per_l",
  "f_Pr_mcg_per_l", "p_Pr_mcg_per_l", "f_Se_mcg_per_l", "p_Se_mcg_per_l", "f_Tl_mcg_per_l", "p_Tl_mcg_per_l",
  "f_U_mcg_per_l", "p_U_mcg_per_l", "f_Y_mcg_per_l", "p_Y_mcg_per_l", "f_Zn_mcg_per_l", "p_Zn_mcg_per_l",
  "f_REE", "p_REE"
)

site_dfs <- list(Aggie_Main = Aggie_Main, Aggie_NF = Aggie_NF, Aggie_SF = Aggie_SF)

results_list <- list()

for (i in seq_along(elements_2)) {
  element <- elements_2[i]
  column <- columns_2[i]
  
  for (site_name in names(site_dfs)) {
    site_df <- site_dfs[[site_name]] %>%
      filter(variable == column) %>%
      mutate(year = as.integer(as.character(year)))
    
    if (nrow(site_df) >= 3) {
      model <- lm(mean ~ year, data = site_df)
      model_sum <- summary(model)
      
      results_list[[paste0(site_name, "_", element)]] <- data.frame(
        Site = site_name,
        Variable = element,
        Intercept = coef(model_sum)[1, 1],
        Intercept_SE = coef(model_sum)[1, 2],
        Estimate = coef(model_sum)[2, 1],
        Std_Error = coef(model_sum)[2, 2],
        t_value = coef(model_sum)[2, 3],
        p_value = coef(model_sum)[2, 4],
        R_squared = model_sum$r.squared
      )
    }
  }
}

# Combine all into one dataframe
final_results <- dplyr::bind_rows(results_list)

view(final_results)

write_xlsx(final_results, "C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Results and Discussion/Aggie temporal regression results.xlsx")
```

## Sulfate
regression equations
```{r}
sulfate_equation_df <- final_results %>%
  filter(Variable == "f_SO4") %>%
  group_by(Site) %>%
  mutate(
    intercept = round(Intercept,1),
    slope     = round(Estimate,1),
    r2        = round(R_squared,2),
    eq_label  = paste0("y = ", slope, "x + ", intercept, "\nR² = ", r2),
    x = 1,
    y = 250
  ) %>%
  mutate(
    Subcatchment = case_when(
      Site == "Aggie_Main" ~ "Main",
      Site == "Aggie_NF" ~ "North Fork",
      Site == "Aggie_SF" ~ "South Fork"
    )
  ) %>%
  mutate( # set the y axis position for each equation
  y = case_when(
    Subcatchment == "North Fork" ~ 250,
    Subcatchment == "South Fork" ~ 240,
    Subcatchment == "Main" ~ 230
  )
)

view(sulfate_equation_df)
```

```{r}
# SO4 by subcatchment
SO4_aggie <- temporal_df %>%
  filter(variable == "f_SO4_mg_per_l") %>%
  ggplot(aes(x = year_sub, y = mean, fill = Subcatchment, shape = Subcatchment)) +
  
  geom_smooth(method = "lm", se = FALSE, formula = y ~ x, aes(group = Subcatchment, color = Subcatchment)) +
  
  labs(
    x = "Year",
    y = "Mean Value",
    color = "Subcatchment"
  ) +
  
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.2) +
  geom_point(aes(size = Subcatchment), color = "black", stroke = 1.1) +
  
  scale_fill_manual(values = c("Main" = "#71d5f6", "North Fork" = "#f67192", "South Fork" = "#f1c029")) +
  scale_color_manual(values = c("Main" = "#71d5f6", "North Fork" = "#f67192", "South Fork" = "#efb911")) +
  scale_shape_manual(values = c("Main" = 23, "North Fork" = 21, "South Fork" = 24)) +
  scale_size_manual(values = c("Main" = 3, "North Fork" = 4, "South Fork" = 3)) +
  
   geom_vline(xintercept = 23, linetype = "dashed", color = "black", size = 1, alpha = 0.6) +
  
  scale_x_discrete(
    breaks = north_fork_ticks,
    labels = north_fork_labels,
    expand = expansion(mult = c(0.03, 0.03))
  ) +
  
  scale_y_continuous(
    breaks = c(0,25,50,75,100,125,150,175,200,225,250,275),
    labels = c(0,"",50,"",100,"",150,"",200,"",250,""),
    expand = expansion(mult = c(0.01, 0.03))
  ) +
  
  labs(
    title = NULL,
    x = "Year",
    y = "Mean SO4",
    color = "Subcatchment"
  ) +
  theme_minimal() +
  temporal_theme +
  theme(legend.position = "none",
        #axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1),
        plot.background = element_rect(fill = "transparent", color = NA),
        panel.background = element_rect(fill = "transparent", color = NA))

SO4_aggie

#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/04_Agashashok Temporal Analysis/SO4_V6 angled labels darker yellow labels.png", SO4_aggie, width = 4, height = 5, dpi = 300, bg = "transparent")
```

```{r}
sulfate_temporal <- Agashashok_for_plots %>%
ggplot(aes(x = factor(sample_collection_year), y = f_SO4_mg_per_l, fill = sample_collection_season)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  labs(
    title = "Concentration by Year and Season",
    x = "Year",
    y = "Concentration (units)",  # replace with actual units
    fill = "Season"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

sulfate_temporal
```

## Calcium
```{r}
# SO4 by subcatchment
Ca_aggie <- temporal_df %>%
  filter(variable == "f_Ca_mg_l") %>%
  ggplot(aes(x = year_sub, y = mean, fill = Subcatchment, shape = Subcatchment)) +
  
  geom_smooth(method = "lm", se = FALSE, formula = y ~ x, aes(group = Subcatchment, color = Subcatchment)) +
  
  labs(
    x = "Year",
    y = "Mean Value",
    color = "Subcatchment"
  ) +
  
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.2) +
  geom_point(aes(size = Subcatchment), color = "black", stroke = 1.1) +
  
  scale_fill_manual(values = c("Main" = "#71d5f6", "North Fork" = "#f67192", "South Fork" = "#f6d571")) +
  scale_color_manual(values = c("Main" = "#71d5f6", "North Fork" = "#f67192", "South Fork" = "#f6d571")) +
  scale_shape_manual(values = c("Main" = 23, "North Fork" = 21, "South Fork" = 24)) +
  scale_size_manual(values = c("Main" = 3, "North Fork" = 4, "South Fork" = 3)) +
  
   geom_vline(xintercept = 23, linetype = "dashed", color = "black", size = 1, alpha = 0.6) +
  
  scale_x_discrete(
    breaks = north_fork_ticks,
    labels = north_fork_labels,
    expand = expansion(mult = c(0.03, 0.03))
  ) +
  
  scale_y_continuous(
    breaks = c(0,25,50,75,100,125,150,175,200,225,250,275),
    labels = c(0,25,50,75,100,125,150,"",200,"",250,""),
    expand = expansion(mult = c(0.01, 0.03))
  ) +
  
  labs(
    title = NULL,
    x = "Year",
    y = "Mean SO4",
    color = "Subcatchment"
  ) +
  theme_minimal() +
  temporal_theme +
  theme(legend.position = "none"
        ,axis.text.y = element_blank()
        )

Ca_aggie

#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/04_Agashashok Temporal Analysis/Ca_V2 no labels.png",Ca_aggie, width = 4, height = 5, dpi = 300)
```

## DOC
```{r}
# SO4 by subcatchment
DOC_aggie <- temporal_df %>%
  filter(variable == "DOC_mgC_per_l") %>%
  ggplot(aes(x = year_sub, y = mean, fill = Subcatchment, shape = Subcatchment)) +
  
  geom_smooth(method = "lm", se = FALSE, formula = y ~ x, aes(group = Subcatchment, color = Subcatchment)) +
  
  labs(
    x = "Year",
    y = "Mean Value",
    color = "Subcatchment"
  ) +
  
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.2) +
  geom_point(aes(size = Subcatchment), color = "black", stroke = 1.1) +
  
  scale_fill_manual(values = c("Main" = "#71d5f6", "North Fork" = "#f67192", "South Fork" = "#f6d571")) +
  scale_color_manual(values = c("Main" = "#71d5f6", "North Fork" = "#f67192", "South Fork" = "#f6d571")) +
  scale_shape_manual(values = c("Main" = 23, "North Fork" = 21, "South Fork" = 24)) +
  scale_size_manual(values = c("Main" = 3, "North Fork" = 4, "South Fork" = 3)) +
  
   geom_vline(xintercept = 23, linetype = "dashed", color = "black", size = 1, alpha = 0.6) +
  
  scale_x_discrete(
    breaks = north_fork_ticks,
    labels = north_fork_labels,
    expand = expansion(mult = c(0.03, 0.03))
  ) +
  
  scale_y_continuous(
    #breaks = c(0,5,10,15,20,25,30,35,40,45),
    #labels = c(0,"",10,"",20,"",30,"",40,45),
    expand = expansion(mult = c(0.01, 0.03))
  ) +
  
  labs(
    title = NULL,
    x = "Year",
    y = "Mean SO4",
    color = "Subcatchment"
  ) +
  theme_minimal() +
  temporal_theme +
  theme(legend.position = "none"
        ,axis.text.y = element_blank()
        )

DOC_aggie

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/04_Agashashok Temporal Analysis/DOC_V2 no labels.png",DOC_aggie, width = 4, height = 5, dpi = 300)
```

## Magnesium
```{r}
# SO4 by subcatchment
Mg_aggie <- temporal_df %>%
  filter(variable == "f_Mg_mg_l") %>%
  ggplot(aes(x = year_sub, y = mean, fill = Subcatchment, shape = Subcatchment)) +
  
  geom_smooth(method = "lm", se = FALSE, formula = y ~ x, aes(group = Subcatchment, color = Subcatchment)) +
  
  labs(
    x = "Year",
    y = "Mean Value",
    color = "Subcatchment"
  ) +
  
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.2) +
  geom_point(aes(size = Subcatchment), color = "black", stroke = 1.1) +
  
  scale_fill_manual(values = c("Main" = "#71d5f6", "North Fork" = "#f67192", "South Fork" = "#f6d571")) +
  scale_color_manual(values = c("Main" = "#71d5f6", "North Fork" = "#f67192", "South Fork" = "#f6d571")) +
  scale_shape_manual(values = c("Main" = 23, "North Fork" = 21, "South Fork" = 24)) +
  scale_size_manual(values = c("Main" = 3, "North Fork" = 4, "South Fork" = 3)) +
  
   geom_vline(xintercept = 23, linetype = "dashed", color = "black", size = 1, alpha = 0.6) +
  
  scale_x_discrete(
    breaks = north_fork_ticks,
    labels = north_fork_labels,
    expand = expansion(mult = c(0.03, 0.03))
  ) +
  
  scale_y_continuous(
    breaks = c(0,5,10,15,20,25,30,35,40,45),
    labels = c(0,"",10,"",20,"",30,"",40,45),
    expand = expansion(mult = c(0.01, 0.03))
  ) +
  
  labs(
    title = NULL,
    x = "Year",
    y = "Mean SO4",
    color = "Subcatchment"
  ) +
  theme_minimal() +
  temporal_theme +
  theme(legend.position = "none"
        #,axis.text.y = element_blank()
        )

Mg_aggie

#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/04_Agashashok Temporal Analysis/Ca_V2 no labels.png",Ca_aggie, width = 4, height = 5, dpi = 300)
```

## SpC
```{r}
SpC_aggie <- temporal_df %>%
  filter(variable == "Spec_Cond_microS_per_cm") %>%
  ggplot(aes(x = year_sub, y = median, color = Subcatchment)) +
   geom_vline(xintercept = 12.5, linetype = "dashed", color = "black", size = 1, alpha = 0.5) +
  #geom_line(size = 1) +
  geom_point(size = 3) +
  #geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.2) +
  geom_errorbar(aes(ymin = Q1, ymax = Q3), width = 0.2) +
  scale_x_discrete(
    breaks = north_fork_ticks,
    labels = north_fork_labels
  ) +
  #scale_x_discrete(labels = x_labels) +
  labs(
    title = "Median SpC by Year and Subcatchment",
    x = "Year",
    y = "Median SpC",
    color = "Subcatchment"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  temporal_theme

SpC_aggie

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/04_Agashashok Temporal Analysis/SO4.png", SO4_aggie, width = 4, height = 5, dpi = 300)
```

## pH
```{r}
# pH by subcatchment
pH_aggie <- temporal_df %>%
  filter(variable == "pH") %>%
  ggplot(aes(x = year_sub, y = mean, fill = Subcatchment, shape = Subcatchment)) +
  
  #geom_smooth(method = "lm", se = FALSE, formula = y ~ x, aes(group = Subcatchment, color = Subcatchment)) +
  
  labs(
    x = "Year",
    y = "Mean Value",
    color = "Subcatchment"
  ) +
  
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.2) +
  geom_point(aes(size = Subcatchment), color = "black", stroke = 1.1) +
  
  scale_fill_manual(values = c("Main" = "#71d5f6", "North Fork" = "#f67192", "South Fork" = "#f6d571")) +
  scale_color_manual(values = c("Main" = "#71d5f6", "North Fork" = "#f67192", "South Fork" = "#f6d571")) +
  scale_shape_manual(values = c("Main" = 23, "North Fork" = 21, "South Fork" = 24)) +
  scale_size_manual(values = c("Main" = 3, "North Fork" = 4, "South Fork" = 3)) +
  
   geom_vline(xintercept = 23, linetype = "dashed", color = "black", size = 1, alpha = 0.6) +
  
  scale_x_discrete(
    breaks = north_fork_ticks,
    labels = north_fork_labels,
    expand = expansion(mult = c(0.03, 0.03))
  ) +
  
  scale_y_continuous(
    #breaks = c(0,25,50,75,100,125,150,175,200,225,250,275),
    #labels = c(0,"",50,"",100,"",150,"",200,"",250,""),
    expand = expansion(mult = c(0.01, 0.03))
  ) +
  
  labs(
    title = NULL,
    x = "Year",
    y = "Mean pH",
    color = "Subcatchment"
  ) +
  theme_minimal() +
  temporal_theme +
  theme(legend.position = "none"
        ,axis.text.y = element_blank()
        )

pH_aggie

#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/04_Agashashok Temporal Analysis/pH_V2 no labels.png", pH_aggie, width = 4, height = 5, dpi = 300)
```

```{r}
# pH by season
pH_temporal <- Agashashok_for_plots %>%
ggplot(aes(x = factor(sample_collection_year), y = pH, fill = sample_collection_season)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  labs(
    title = "Concentration by Year and Season",
    x = "Year",
    y = "Concentration (units)",  # replace with actual units
    fill = "Season"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

pH_temporal
```

## DIC
```{r}
DIC_aggie <- temporal_df %>%
  filter(variable == "DIC_mgC_per_l") %>%
  ggplot(aes(x = year_sub, y = median, color = Subcatchment)) +
  geom_vline(xintercept = 9.5, linetype = "dashed", color = "black", size = 1, alpha = 0.5) +
  #geom_line(size = 1) +
  geom_point(size = 3) +
  #geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.2) +
  geom_errorbar(aes(ymin = Q1, ymax = Q3), width = 0.2) +
  scale_x_discrete(
    breaks = north_fork_ticks,
    labels = north_fork_labels
  ) +
  #scale_x_discrete(labels = x_labels) +
  labs(
    title = "Median DIC by Year and Subcatchment",
    x = "Year",
    y = "Median DIC",
    color = "Subcatchment"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  temporal_theme

DIC_aggie
```


```{r}
DIC_temporal <- Agashashok_for_plots %>%
ggplot(aes(x = factor(sample_collection_year), y = DIC_mgC_per_l, fill = sample_collection_season)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  labs(
    title = "Concentration by Year and Season",
    x = "Year",
    y = "Concentration (units)",  # replace with actual units
    fill = "Season"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

DIC_temporal
```

## Alk
```{r}
Alk_aggie <- temporal_df %>%
  filter(variable == "Alk_mgCaCO3_per_l") %>%
  ggplot(aes(x = year_sub, y = mean, fill = Subcatchment, shape = Subcatchment)) +
  
  geom_smooth(method = "lm", se = FALSE, formula = y ~ x, aes(group = Subcatchment, color = Subcatchment)) +
  
  labs(
    x = "Year",
    y = "Mean Value",
    color = "Subcatchment"
  ) +
  
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.2) +
  geom_point(aes(size = Subcatchment), color = "black", stroke = 1.1) +
  
  scale_fill_manual(values = c("Main" = "#71d5f6", "North Fork" = "#f67192", "South Fork" = "#f1c029")) +
  scale_color_manual(values = c("Main" = "#71d5f6", "North Fork" = "#f67192", "South Fork" = "#efb911")) +
  scale_shape_manual(values = c("Main" = 23, "North Fork" = 21, "South Fork" = 24)) +
  scale_size_manual(values = c("Main" = 3, "North Fork" = 4, "South Fork" = 3)) +
  
   geom_vline(xintercept = 23, linetype = "dashed", color = "black", size = 1, alpha = 0.6) +
  
  scale_x_discrete(
    breaks = north_fork_ticks,
    labels = north_fork_labels,
    expand = expansion(mult = c(0.03, 0.03))
  ) +
  
  scale_y_continuous(
    breaks = c(0,25,50,75,100,125,150,175,200,225,250,275),
    labels = c(0,"",50,"",100,"",150,"",200,"",250,""),
    expand = expansion(mult = c(0.01, 0.03))
  ) +
  
  labs(
    title = NULL,
    x = "Year",
    y = "Mean Alk",
    color = "Subcatchment"
  ) +
  theme_minimal() +
  temporal_theme +
  theme(legend.position = "none",
        #axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1),
        plot.background = element_rect(fill = "transparent", color = NA),
        panel.background = element_rect(fill = "transparent", color = NA))

Alk_aggie

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/04_Agashashok Temporal Analysis/Alk_V6 angled labels darker yellow with labels.png",Alk_aggie, width = 4, height = 5, dpi = 300, bg = "transparent")
```


```{r}
Alk_temporal <- Agashashok_for_plots %>%
ggplot(aes(x = factor(sample_collection_year), y = Alk_mgCaCO3_per_l, fill = sample_collection_season)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  labs(
    title = "Concentration by Year and Season",
    x = "Year",
    y = "Concentration (units)",  # replace with actual units
    fill = "Season"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

Alk_temporal
```

## Fe
```{r}
Fe_temporal <- temporal_df %>%
  filter(variable == "f_Fe_mcg_per_l") %>%
  ggplot(aes(x = year_sub, y = mean, fill = Subcatchment, shape = Subcatchment)) +
  
  #geom_smooth(method = "lm", se = FALSE, formula = y ~ x, aes(group = Subcatchment, color = Subcatchment)) +
  
  labs(
    x = "Year",
    y = "Mean Value",
    color = "Subcatchment"
  ) +
  
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.2) +
  geom_point(aes(size = Subcatchment), color = "black", stroke = 1.1) +
  
  scale_fill_manual(values = c("Main" = "#71d5f6", "North Fork" = "#f67192", "South Fork" = "#f6d571")) +
  scale_color_manual(values = c("Main" = "#71d5f6", "North Fork" = "#f67192", "South Fork" = "#f6d571")) +
  scale_shape_manual(values = c("Main" = 23, "North Fork" = 21, "South Fork" = 24)) +
  scale_size_manual(values = c("Main" = 3, "North Fork" = 4, "South Fork" = 3)) +
  
   geom_vline(xintercept = 23, linetype = "dashed", color = "black", size = 1, alpha = 0.6) +
  
  scale_x_discrete(
    breaks = north_fork_ticks,
    labels = north_fork_labels,
    expand = expansion(mult = c(0.03, 0.03))
  ) +
  
  scale_y_continuous(
    #breaks = c(0,25,50,75,100,125,150,175,200,225,250,275),
    #labels = c(0,"",50,"",100,"",150,"",200,"",250,""),
    expand = expansion(mult = c(0.01, 0.03))
  ) +
  
  labs(
    title = NULL,
    x = "Year",
    y = "Mean pH",
    color = "Subcatchment"
  ) +
  theme_minimal() +
  temporal_theme +
  theme(legend.position = "none"
        #,axis.text.y = element_blank()
        )

Fe_temporal

#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/04_Agashashok Temporal Analysis/pH_V2 no labels.png", Fe_temporal, width = 4, height = 5, dpi = 300)


```

## Ni
```{r}
Cd_temporal <- Agashashok_for_plots %>%
ggplot(aes(x = factor(sample_collection_year), y = f_Cd_mcg_per_l, fill = sample_collection_season)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  labs(
    title = "Concentration by Year and Season",
    x = "Year",
    y = "Concentration (units)",  # replace with actual units
    fill = "Season"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

Cd_temporal
```


# stats
```{r}
library(dplyr)
library(purrr)
library(broom)
library(rstatix)

# List of columns to analyze
columns_to_model <- c("pH", "Spec_Cond_microS_per_cm", 
  "DIC_mgC_per_l", "Alk_mgCaCO3_per_l", "DOC_mgC_per_l", "f_Cl_mg_per_l", "f_NO3_mgN_per_l", 
  "f_SO4_mg_per_l", "f_Ca_mg_l", "f_Mg_mg_l", "f_Na_mg_l", "f_K_mg_l",
  "f_SiO2_mg_per_l",
  "f_Al_mcg_per_l",
  "f_As_mcg_per_l",
  "f_Ba_mcg_per_l",
  "f_Cd_mcg_per_l",
  "f_Ce_mcg_per_l",
  "f_Co_mcg_per_l",
  "f_Cr_mcg_per_l",
  "f_Cu_mcg_per_l",
  "f_Dy_mcg_per_l",
  "f_Fe_mcg_per_l",
  "f_La_mcg_per_l",
  "f_Mn_mcg_per_l",
  "f_Nd_mcg_per_l",
  "f_Ni_mcg_per_l",
  "f_Pb_mcg_per_l", 
  "f_Pr_mcg_per_l",
  "f_Se_mcg_per_l",
  "f_Tl_mcg_per_l",
  "f_U_mcg_per_l",
  "f_Y_mcg_per_l",
  "f_Zn_mcg_per_l")


pdf("Aggie_temporal_residuals_plots.pdf")  # Start a new PDF file

# Initialize a results list
model_results <- list()

# Loop through each variable
for (col in columns_to_model) {

  # Get the relevant subset
  df_sub <- onset_df %>%
    dplyr::select(sub_temp, all_of(col)) %>%
    filter(!is.na(.data[[col]]), !is.na(sub_temp))

  # Check if temporal_status and the variable both have enough data
  if (n_distinct(df_sub$sub_temp) < 2 || nrow(df_sub) < 3) {
    model_results[[col]] <- data.frame(
      Variable = col,
      W = NA,
      p_value = NA,
      Interpretation = "Insufficient data or sub_temp lacks ≥2 levels"
    )
    next
  }

  # Fit the model
  model <- lm(df_sub[[col]] ~ df_sub$sub_temp)

  # Extract residuals
  residuals <- resid(model)

  # Plot histogram
  hist(residuals, main = paste("Residuals Histogram:", col), xlab = "Residuals")

  # QQ plot
  qqnorm(residuals, main = paste("QQ Plot of Residuals:", col))
  qqline(residuals)

  # Shapiro-Wilk test
  test_result <- tryCatch(
    shapiro.test(residuals),
    error = function(e) NULL
  )

  interpretation <- if (!is.null(test_result) && test_result$p.value > 0.05) {
    "Residuals likely normally distributed (fail to reject H0)."
  } else if (!is.null(test_result)) {
    "Residuals not normally distributed (reject H0); consider non-parametric test."
  } else {
    "Shapiro test failed or insufficient data."
  }

  # Save results
  model_results[[col]] <- data.frame(
    Variable = col,
    W = if (!is.null(test_result)) test_result$statistic else NA,
    p_value = if (!is.null(test_result)) test_result$p.value else NA,
    Interpretation = interpretation
  )
}

dev.off()  # Close the PDF device

# Combine all results into a single data frame
shapiro_results <- bind_rows(model_results)

# Print results
view(shapiro_results)

#write_xlsx(shapiro_results, "C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Results and Discussion/Aggie temporal - pre vs post dataset shapiro.xlsx")
```



```{r}
# List of columns to analyze - variables removed from the list because shapiro showed normality
nonparametric_columns <- c("pH", "Spec_Cond_microS_per_cm", 
  "DIC_mgC_per_l", 
  #"Alk_mgCaCO3_per_l", 
  "DOC_mgC_per_l", "f_Cl_mg_per_l", "f_NO3_mgN_per_l", 
  "f_SO4_mg_per_l", 
  #"f_Ca_mg_l", 
  #"f_Mg_mg_l", 
  "f_Na_mg_l", "f_K_mg_l")

# set the data to be used as stats_data
stats_data <- Aggie_Main_onset_df
#stats_data <- Aggie_SF_onset_df
#stats_data <- Aggie_NF_onset_df

# Initialize a results list
kruskal_results_list <- list()

# Loop through each variable in your list
for (col in nonparametric_columns) {
  
  # Filter out NAs for the current variable
  df_filtered <- onset_df %>%
    filter(!is.na(.data[[col]]))
  
  # Perform Kruskal-Wallis test
  test_result <- tryCatch(
    {
      kruskal_test(as.formula(paste(col, "~ sub_temp")), data = df_filtered)
    },
    error = function(e) {
      # Return a default result if test fails
      data.frame(
        variable = col,
        statistic = NA,
        p = NA,
        df = NA
      )
    }
  )
  
  # Create interpretation
  interpretation <- if (!is.null(test_result$p) && test_result$p < 0.05) {
    "Significant difference among groups (reject H0)."
  } else if (!is.null(merged_result$p)) {
    "No significant difference among groups (fail to reject H0)."
  } else {
    "Test could not be performed due to insufficient data or errors."
  }
  
  test_result$Interpretation <- interpretation
  
  # Store the result
  kruskal_results_list[[col]] <- test_result
}

# Combine all results into a single dataframe
kruskal_results_df <- bind_rows(kruskal_results_list)

# Print the results
view(kruskal_results_df)
```


```{r}

columns_for_dunn <- c(
  #"pH", 
  "Spec_Cond_microS_per_cm", 
  "DIC_mgC_per_l", 
  "DOC_mgC_per_l", 
  "f_Cl_mg_per_l", 
  #"f_NO3_mgN_per_l", 
  "f_SO4_mg_per_l", 
  "f_Na_mg_l", 
  "f_K_mg_l")


# Initialize a results list
dunn_results_list <- list()

# Loop through each variable in columns_for_dunn
for (col in columns_for_dunn) {
  
  # Filter out NAs for the current variable
  df_filtered <- onset_df %>%
    filter(!is.na(.data[[col]]))
  
  # Try performing Dunn's test with Bonferroni adjustment
  test_result <- tryCatch(
    {
      df_filtered %>%
        dunn_test(as.formula(paste(col, "~ sub_temp")), p.adjust.method = "bonferroni")
    },
    error = function(e) {
      # Return a default result if test fails
      data.frame(
        Variable = col,
        group1 = NA,
        group2 = NA,
        Z = NA,
        p = NA,
        p.adj = NA
      )
    }
  )
  
  # Add the variable name to each row
  test_result$Variable <- col
  
  # Store the result
  dunn_results_list[[col]] <- test_result
  
  # If there is at least one valid pairwise comparison, generate the CLD
  if (!all(is.na(test_result$p.adj))) {
     # Build a matrix of p-values manually
    groups <- unique(c(test_result$group1, test_result$group2))
    pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                          dimnames = list(groups, groups))
    
    for (i in seq_len(nrow(test_result))) {
      g1 <- as.character(test_result$group1[i])
      g2 <- as.character(test_result$group2[i])
      pval <- test_result$p.adj[i]
      
      pval_matrix[g1, g2] <- pval
      pval_matrix[g2, g1] <- pval  # symmetric
    }
    
    # Generate CLD using multcompView
    cld <- multcompLetters(pval_matrix)
    
    # Convert to a tidy data frame
    cld_df <- data.frame(
      Variable = col,
      Group = names(cld$Letters),
      Letters = cld$Letters
    )
    
    # Store the CLD result
    cld_results_list[[col]] <- cld_df
  }
}

# Combine all Dunn's test results into a single dataframe
dunn_results_df <- bind_rows(dunn_results_list)

# Combine all CLD results into a single dataframe
cld_results_df <- bind_rows(cld_results_list)

# Print the results
view(dunn_results_df)
view(cld_results_df)
```