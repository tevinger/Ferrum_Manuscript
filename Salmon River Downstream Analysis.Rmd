---
title: "Ferrum_Downstream Analysis"
output: html_document
date: "2025-01-29"
editor_options: 
  chunk_output_type: console
---

# Load Packages

```{r}
library(tidyverse)
library(cowplot)
library(ggplot2)
library(lubridate)
library(emmeans)
library(lme4)
library(ggeasy)
library(lattice)
library(rstatix)
library(ggsignif)
library(outliers)
library(ggpmisc)
library(ggpubr)
library(r2symbols)
library(stargazer)
library(ggbreak)
library(writexl)
library(ggrepel)
library(stringr)
library(ggthemes)
library(reshape)
library(RColorBrewer)
library(readxl)
library(dplyr)
library(gridExtra)
library(scales)
library(dbscan)
library(mclust)
library(devtools)
library(factoextra)
library(corrplot)
library(ggbiplot)
library(ggcorrplot)
library(GGally)
library(Hmisc)
library(ggbiplot)
library(ggfortify)
library(emmeans)
library(lme4)
library(lmerTest)
library(multcomp)
library(readxl)
library(learnr)
library(scatterplot3d)
library(vegan)
library(ggtern)
library(plotrix)
library(colorBlindness)
library(flextable)
library(officer)
library(dunn.test)
library(multcompView)
library(patchwork)
library(ggbreak)
library(ggpattern)
library(imputeTS)
library(zoo)
```

# Load Data
```{r}
Alaska_DataRelease_2022_2023_Ferrum_V10 <- read_excel("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Datasheets/Ferrum Manuscript Datasheets/Alaska_DataRelease_2022_2023_Ferrum_V10.xlsx")
```

```{r}
# Select data for Salmon River July 2023 trip
SalmonR_2023_river_data <-  Alaska_DataRelease_2022_2023_Ferrum_V10 %>%
  dplyr::filter(Watershed == "Salmon River" | Field_label == "Anaktok_1") %>%
  dplyr::filter(sample_collection_year == "2023") %>%
  dplyr::filter(sample_collection_month == "July") %>%
  arrange(Distance_km)

view(SalmonR_2023_river_data)

write_xlsx(SalmonR_2023_river_data, "C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Datasheets/Ferrum Manuscript Datasheets/Salmon River July 2023 Data_V2.xlsx")
```

```{r}
# Modified in excel:
#distance downstream values 
#classification value for Anaktok to reflect this sample site as a tributary on the Salmon 
# Updated Site Classification for tributaries

SalmonR_2023_river_data <- read_excel("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Datasheets/Ferrum Manuscript Datasheets/Salmon River July 2023 Data_v2_updated.xlsx")

```

## Filter Data
```{r}
SalmonR_filtered_MS <- SalmonR_2023_river_data %>%
  filter(Hyd_Classification == "Mainstem") %>%
  mutate(New_Grouping = ifelse(is.na(New_Grouping), "normal", New_Grouping)) # fill in the groups that don't have a site_group with normal

SalmonR_filtered_Trib <- SalmonR_2023_river_data %>%
  filter(Hyd_Classification == "Tributary") %>%
  mutate(New_Grouping = ifelse(New_Grouping == "Downstream MS", "Impaired Tributary", New_Grouping)) # this fixes the group that Anaktok_1 is in for the Salmon River

Salmon_impaired_tribs <- SalmonR_2023_river_data %>%
  dplyr::filter(Site_Classification == "Impaired")

Salmon_unimpaired_tribs <- SalmonR_2023_river_data %>%
  dplyr::filter(Site_Classification == "Unimpaired")
```

## Downstream Difference Calculation
```{r}
Salmon_downstream_difference <- SalmonR_filtered_MS %>%
  dplyr::select(SiteID, Distance_km, pH,
                Temp_deg_celsius,
                Diss_oxy_mg_per_l,
                Diss_oxy_percent_sat,
                Spec_Cond_microS_per_cm,
                DIC_mgC_per_l,
                Alk_mgCaCO3_per_l,
                DOC_mgC_per_l,
                f_Cl_mg_per_l,
                f_NO3_mgN_per_l,
                f_SO4_mg_per_l,
                f_Ca_mg_l,
                f_Mg_mg_l,
                f_Na_mg_l,
                f_K_mg_l,
                f_SiO2_mg_per_l,
                f_Pb_mcg_per_l, p_Pb_mcg_per_l,
                f_Ag_mcg_per_l, p_Ag_mcg_per_l,
f_Al_mcg_per_l, p_Al_mcg_per_l,
f_As_mcg_per_l, p_As_mcg_per_l,
f_Ba_mcg_per_l, p_Ba_mcg_per_l,
#f_Be_mcg_per_l, p_Be_mcg_per_l,
f_Cd_mcg_per_l, p_Cd_mcg_per_l,
f_Ce_mcg_per_l, p_Ce_mcg_per_l,
f_Co_mcg_per_l, p_Co_mcg_per_l,
f_Cr_mcg_per_l, p_Cr_mcg_per_l,
f_Cu_mcg_per_l, p_Cu_mcg_per_l,
f_Dy_mcg_per_l, p_Dy_mcg_per_l,
f_Fe_mcg_per_l, p_Fe_mcg_per_l,
f_La_mcg_per_l, p_La_mcg_per_l,
f_Mn_mcg_per_l, p_Mn_mcg_per_l,
f_Nd_mcg_per_l, p_Nd_mcg_per_l,
f_Ni_mcg_per_l, p_Ni_mcg_per_l,
f_Pr_mcg_per_l, p_Pr_mcg_per_l,
f_Se_mcg_per_l, p_Se_mcg_per_l,
#f_Th_mcg_per_l, p_Th_mcg_per_l,
f_Tl_mcg_per_l, p_Tl_mcg_per_l,
f_U_mcg_per_l, p_U_mcg_per_l,
f_V_mcg_per_l, p_V_mcg_per_l,
f_Y_mcg_per_l, p_Y_mcg_per_l,
f_Zn_mcg_per_l, p_Zn_mcg_per_l,
f_REE, p_REE,
u_Pb_mcg_per_l,
u_Ag_mcg_per_l,
u_Al_mcg_per_l,
u_As_mcg_per_l,
u_Ba_mcg_per_l,
# u_Be_mcg_per_l,
u_Cd_mcg_per_l,
u_Ce_mcg_per_l,
u_Co_mcg_per_l,
u_Cr_mcg_per_l,
u_Cu_mcg_per_l,
u_Dy_mcg_per_l,
u_Fe_mcg_per_l,
u_La_mcg_per_l,
u_Mn_mcg_per_l,
u_Nd_mcg_per_l,
u_Ni_mcg_per_l,
u_Pr_mcg_per_l,
u_Se_mcg_per_l,
# u_Th_mcg_per_l,
u_Tl_mcg_per_l,
u_U_mcg_per_l,
u_V_mcg_per_l,
u_Y_mcg_per_l,
u_Zn_mcg_per_l) %>%
  dplyr::select(-contains("qa")) %>%
  filter(Distance_km %in% c(0, 103.23)) %>% # select the most upstream and most downstream mainstem sites
  dplyr::select(-c(Distance_km)) %>% # remove distance column
    pivot_longer(
    cols = -c(SiteID),
    names_to = "variable",
    values_to = "value"
  ) %>%
  pivot_wider(
    names_from = SiteID,
    values_from = value
  ) %>%
  filter(!is.na(SalmonR_MS2)) %>% # filter out na values for the SalmonR_MS2 site (upstream site) 
  mutate(SalmonR_MS2 = if_else(SalmonR_MS2 == 0, 0.000001, SalmonR_MS2)) %>% # substitute 0 values for 0.000001 so that a calculation can be done
  # difference calculations comparing most upstream (MS2) to most downtream (MS6)
  mutate(downstream_diff_conc = SalmonR_MS6 - SalmonR_MS2) %>%
  mutate(downstream_diff_fold_greater = (SalmonR_MS6/SalmonR_MS2)) %>%
  mutate(downstream_diff_percent_change = (downstream_diff_conc/SalmonR_MS2) * 100)

view(Salmon_downstream_difference)

write_xlsx(Salmon_downstream_difference, "C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Results and Discussion/Salmon River Downstream Analysis/Salmon River Downstream Differences.xlsx")
```


## Plot theme

```{r}
DA_theme <- 
  theme(
    axis.text.y = element_text(size = 16, color = "black", face = "bold"),
    axis.text.x = element_text(size = 16, color = "black", face = "bold", 
                               #angle = 45, 
                               hjust = 0.5),
    axis.ticks.y = element_line(linewidth = 0.9, color = "black"),  # Thicker y-axis ticks
    axis.ticks.length.y = unit(0.1, "cm"),  # Longer tick marks
    
    axis.ticks.x = element_line(linewidth = 0.9, color = "black"),  # Thicker y-axis ticks
    axis.ticks.length.x = unit(0.15, "cm"),  # Longer tick marks
    
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "black"),
    legend.position = "right",
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 17, face = "bold", hjust = 0.5),
    
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    #panel.background = element_rect(fill = "white"),
    panel.border = element_rect(fill = NA, color = "black", size = 1.25),
    panel.background = element_rect(fill = "transparent"), # Panel background
    plot.background = element_rect(fill = "transparent", color = NA) # Plot background

  )
```

## Labels

```{r}
ylab_DOC <- expression(bold(DOC)~(mg~L^-1))
ylab_DIC <- expression(bold(DIC)~(mgC~L^-1))

ylab_Ca <- expression(bold(Ca)~bold((mg~L^-1)))
ylab_Mg <- expression(bold(Mg)~bold((mg~L^-1)))
ylab_Chloride <- expression(bold(Chloride)~bold((mg~L^-1)))
ylab_Sulfate <- expression(bold(SO[4]^-2)~bold((mg~L^-1)))
ylab_SpC <- expression(bold(Specific~Conductivity)~bold((μS~cm^-1)))
ylab_Alk <- expression(bold(Alkalinity~bold((mgCaCO[3]~L^-1))))

ylab_Zn <- expression(bold(Zn)~bold((μg~L^-1)))
ylab_Cu <- expression(bold(Cu)~bold((μg~L^-1)))
ylab_Fe <- expression(bold(Fe)~bold((μg~L^-1)))
ylab_Ni <- expression(bold(Ni)~bold((μg~L^-1)))
ylab_Mn <- expression(bold(Mn)~bold((μg~L^-1)))
ylab_Cd <- expression(bold(Cd)~bold((μg~L^-1)))
ylab_Al <- expression(bold(Al)~bold((μg~L^-1)))
ylab_Co <- expression(bold(Co)~bold((μg~L^-1)))
ylab_Se <- expression(bold(Se)~bold((μg~L^-1)))
ylab_REE <- expression(bold(Sigma~REE)~bold((μg~L^-1)))
ylab_Tl <- expression(bold(Tl)~bold((μg~L^-1)))
ylab_Pb <- expression(bold(Pb)~bold((μg~L^-1)))
ylab_As <- expression(bold(As)~bold((μg~L^-1)))


ylab_Salinity <- expression(bold(Salinity)~(ppt))
ylab_FMeHg <- expression(bold(FMeHg)~(ng~L^-1))
ylab_FTHg <- expression(bold(FTHg)~(ng~L^-1))
ylab_PMeHg <- expression(bold(PMeHg)~(ng~L^-1))
ylab_PTHg <- expression(bold(PTHg)~(ng~L^-1))
ylab_SPM <- expression(bold(SPM)~(ng~L^-1))
#ylab_Mn <- expression(bold(Manganese)~(μg~L^-1))
ylab_SUVA <- expression(bold(SUVA[254~nm])~(L/mg~m)) 
ylab_Sulfide <- expression(bold(Sulfide)~(mg~L^-1))
```

## Colors
```{r}
watershed_colors <- c(  
    "Agashashok River" = "#A1E3F9",   
    "Anaktok River" = "#9F8383",
    "Salmon River Watershed" = "#9F8383",
    "Salmon River" = "#2DAA9E",   
    "Kugururok River" = "#2D3D85",  
    "Nakolikurok Creek" = "#F87FC7",
    "Nakolikurok" = "#F87FC7",
    "Tukpahlearik Creek" = "#FDDE74",
    "Tukpahlearik" = "#FDDE74"
    )

boxplot_colors <- c(
  "Agashashok River" = "#A1E3F9",   
    "Anaktok River" = "#9F8383",
    "Salmon River Watershed" = "#9F8383",
    "Salmon River" = "#2DAA9E",   
    "Kugururok River" = "#2D3D85",  
    "Nakolikurok Creek" = "#F87FC7",
    "Nakolikurok" = "#F87FC7",
    "Tukpahlearik Creek" = "#FDDE74",
    "Tukpahlearik" = "#FDDE74",
  #"Upstream" = "#72D9FF",
  #"Seep" = "darkred",
  #"Impaired Tributary" = "indianred2",
  #"Downstream MS 1" = "sienna1",
  #"Downstream MS 2" = "orange2",
  #"Downstream MS" = "orange2",
  #"Unimpaired Tributary" = "darkblue",
   "Unimpaired Tributary" = "#00589b",
  "Upstream" = "#72D9FF",
  "Seep" = "#c81600",
  "Impaired Tributary" = "indianred2",
  "Downstream MS" = "#f5a678",
  #"1" = "#72D9FF",
  #"2" = "darkred",
  #"3" = "indianred2",
  #"5" = "sienna1",
  #"6" = "orange2",
  #"4" = "darkblue"
  #"4" = "#003b68",
  "4" = "#00589b",
  "1" = "#72D9FF",
  "2" = "#c81600",
  "3" = "indianred2",
  #"6" = "sienna1"
  #"6" = "#ffb367",
  #"6" = "#f4a460",
  "6" = "#f5a678",
  "normal" = "#28968b"
)

```


# Downstream Analysis by Relative Watershed Area
## pH
```{r}
DA_x_breaks <- c(0,1,2.5,5,7.5,10,12.5,15,17.5,20,22.5)
DA_x_labels <- c("", 1,"",5,"",10,"",15,"",20,"")
DA_x_labels

pH_y_breaks <- seq(4.4,8.6, by = 0.2)
pH_y_labels <- c(4.4, "4.6", "", "5.0", 5.2, "", 5.6, "", 6.0, "", 6.4, "", 6.8 , "", 7.2, 7.4, 7.6, 7.8, "8.0", 8.2, 8.4, "")
```

### Area plot
```{r}
SalmonR_pH_area <- ggplot() +
  # area plots
  geom_area(data = SalmonR_filtered_MS, 
            aes(x = Rel_Water_Area_plotting, y = pH),
            #fill = "#28968b"
            fill = "#2daa9e",
            #alpha = 0.85
            ) +
  
  geom_line(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = pH), color = "#1d6e66", linewidth = 0.4) +
  
  # lines for locations of sampled tributaries
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11), linetype = "dashed", color = "grey15", linewidth = 0.5) +
  
  coord_cartesian(x = c(1,22.5), y = c(7.3,8.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.03, 0))) +
  scale_y_continuous(breaks = pH_y_breaks, labels = pH_y_labels) +
  labs(
    x = NULL,
    y = NULL,
    title = NULL
    #x = "Relative Water Area",
    #y = "pH"
  ) +
  theme_minimal() +
  DA_theme

SalmonR_pH_area

#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Zn area.png", SalmonR_pH_area, width = 4.8, height = 1.92, dpi = 300)
```

### Modifications for heat plots
Data frames
```{r}
SalmonR_pH <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification,Rel_Water_Area_plotting, pH) %>%
  filter(!is.na(Rel_Water_Area_plotting)) %>%
  mutate(
    H = 10^(-pH)
  )
  

view(SalmonR_pH)
```

Tributary data frame
```{r}
SalmonR_trib_pH_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, pH) %>%
  mutate(
    H = 10^(-pH)
  )

view(SalmonR_trib_pH_area)
```

Modifications for heat plots
```{r}
# Calculate tributary metal concentrations relative to the nearest upstream MS sample concentration for heat plot

# Step 1: A reference map for each row that needs normalization
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745",
    "SalmonR_Trib2_20230722_1911",
    "SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945",
    "SalmonR_Trib3_20230724_1140",
    "SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311",
    "SalmonR_Trib6_20230724_1428",
    "SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753",
    "SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

# Step 2: Join main data to get both the value row and its reference row
rel_data <- SalmonR_pH %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(SalmonR_pH %>%
              dplyr::select(RefID = SamplingEventID, 
                            ref_H = H),
            by = "RefID") %>%
  # calculate the concentration relative to the nearest mainstem site (ref)
  mutate(
    rel_H = H / ref_H
  ) 

view(rel_data)

```

```{r}
# Join the relative concentrations to the main data
rel_data_to_join <- rel_data %>%
  dplyr::select(SamplingEventID, rel_H)

SalmonR_pH_with_rel <- SalmonR_pH %>%
  left_join(rel_data_to_join, by = "SamplingEventID")

view(SalmonR_pH_with_rel)

```

```{r}
# Extend the data to have a fake continuous x axis with fake data

# Create full sequence from 0 to 22.5 by 0.05
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

# Join original df with the full sequence
df_expanded <- full_sequence %>%
  left_join(rel_data, by = "Rel_Water_Area_plotting")

rel_data_to_plot <- df_expanded %>%
  dplyr::select(-c(pH, H, ref_H)) %>% # keep only the concentrataion relative to the mainstem (rel_)
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Anaktok_salmon <- rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>% # select anaktok site
  dplyr::select(-c(pH, H, ref_H)) %>% # keep only the concentrataion relative to the mainstem (rel_)
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

# Replace the existing row with the one from Anaktok_salmon
rel_data_to_plot <- rel_data_to_plot %>%
  rows_update(Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(rel_data_to_plot)

```

Manually add data values to relative data to control more of how the NA values are interpolated
```{r}
## Use this if values need to be set manually prior to filling the missing values

mod_data <- data.frame(
  Rel_Water_Area_plotting = c(4.35, 4.7, 5.6, 6.2, 6.3, 7.95, 8.05, 8.95, 10.75, 10.95, 14),
  rel_H = c(0.1, 0.1, 0.1, 0.01, 0.01, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1)
) %>%
  mutate(across(everything(), as.numeric))

rel_data_mod <- rel_data_to_plot %>%
  rows_update(mod_data, by = "Rel_Water_Area_plotting")

view(rel_data_mod)
```

Optional - change the highest value
```{r}
## use this if any values need to be manually changed for the way the plot looks

# Manually change the highest value
rel_data_mod2 <- rel_data_mod %>%
  mutate(rel_H = case_when(
    Rel_Water_Area_plotting == 4.75 ~ 20,
    TRUE ~ rel_H  # keep original value if no match
  ))
```

Linear interpolation using na.approx
```{r}
# Apply linear interpolation to all numeric columns except Rel_Water_Area_plotting
rel_data_to_plot_interp <- rel_data_mod2 %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

# Make the values before the first tributary 0 (adjust column indices if needed)
rel_data_to_plot_interp[1:75, 6] <- 0

view(rel_data_to_plot_interp)

```

### Trib heat plots
```{r}
# Heat plot for pH of tributaries
pH_heat <- ggplot(rel_data_to_plot_interp, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_H)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  #scale_fill_gradientn(
    #colours = c("blue", "red"),
    #values = scales::rescale(c(0, 1, 20)),  # Normalize to [0,1] scale
    #limits = c(0, 20)
  #) + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.03, 0))) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    #legend.position = "none",
    legend.position = "top",
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank()
  )

pH_heat
```

### geom point
```{r}
SalmonR_pH_top <- ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = pH), color = "black", size = 1.1) +
geom_point(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = pH, 
      #fill = New_Grouping
      ), pch = 21, color = "black", 
           fill = "#28968b",
           #fill = "#2DAA9E",
           size = 4, stroke = 1.3) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = Salmon_unimpaired_tribs, aes(x = Rel_Water_Area_plotting, y = pH, 
      #fill = New_Grouping
      ), pch = 24, color = "black", 
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             #fill = "#c0eeea",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = Salmon_impaired_tribs, aes(x = Rel_Water_Area_plotting, y = pH, 
       #fill = New_Grouping
       ), pch = 25, color = "black", 
             fill = "indianred2", 
             size = 3.3, stroke = 1.2) +
  #scale_fill_manual(values = boxplot_colors) +
  coord_cartesian(x = c(0, 22), y = c(7.2, 8.6)) +
  scale_x_continuous( 
    breaks = DA_breaks,
    labels = DA_labels) +
  scale_y_continuous(
    breaks = pH_y_breaks,
    labels = pH_y_labels
  ) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    #legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

SalmonR_pH_top


#SalmonR_pH_top_boxplot_colors
```

```{r}
SalmonR_pH_bottom <- ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = pH), color = "black", size = 1) +
geom_point(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = pH), pch = 21, color = "black", 
           #fill = "#2DAA9E",
           fill = "#28968b",
           size = 5, stroke = 1.3) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = Salmon_unimpaired_tribs, aes(x = Rel_Water_Area_plotting, y = pH), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = Salmon_impaired_tribs, aes(x = Rel_Water_Area_plotting, y = pH), pch = 25, color = "black", 
             fill = "indianred2", 
             size = 3.3, stroke = 1.2) +
  coord_cartesian(x = c(0, 22), y = c(4.5, 5)) +
  scale_x_continuous( 
    breaks = DA_breaks,
    labels = DA_labels) +
  scale_y_continuous(
    breaks = pH_y_breaks,
    labels = pH_y_labels
  ) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank()
  )

SalmonR_pH_bottom
```

```{r}
SalmonR_pH_combo <- SalmonR_pH_top / SalmonR_pH_bottom + plot_layout(heights = c(4, 1), guides = "collect") & theme(plot.margin = margin(0, 5, 0, 2), panel.background = element_rect(fill = "NA", color = "NA"), # Panel background
    plot.background = element_rect(fill = "NA", color = "NA") # Plot background
    )

SalmonR_pH_combo

ggsave("C:/Users/tevinger/Downloads/SalmonR pH.png", SalmonR_pH_combo, width = 5, height = 2.5, dpi = 300)

```

## DIC
```{r}
DA_x_breaks <- seq(0,25, by = 2.5)
DA_x_labels <- c(0,"",5,"",10,"",15,"",20,"",25)
DA_labels

DIC_breaks <- seq(0,55, by = 5)
DIC_labels <- c(0,"",10,"",20,"",30,"",40,"",50,"")
```

```{r}
SalmonR_DIC_top <- ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = DIC_mgC_per_l), color = "black", size = 1) +
geom_point(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = DIC_mgC_per_l), pch = 21, color = "black", 
           #fill = "#2DAA9E",
           fill = "#28968b",
           size = 4, stroke = 1.3) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = Salmon_unimpaired_tribs, aes(x = Rel_Water_Area_plotting, y = DIC_mgC_per_l), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = Salmon_impaired_tribs, aes(x = Rel_Water_Area_plotting, y = DIC_mgC_per_l), pch = 25, color = "black", 
             fill = "indianred2", 
             size = 3.3, stroke = 1.2) +
  #coord_cartesian(x = c(0, 22), y = c(0, 45)) +
  scale_x_continuous( 
    breaks = DA_breaks,
    labels = DA_labels) +
  scale_y_continuous(
    breaks = DIC_breaks,
    labels = DIC_labels
  ) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    plot.margin = margin(0, 5, 0, 2)
  )

SalmonR_DIC_top

ggsave("C:/Users/tevinger/Downloads/SalmonR DIC.png", SalmonR_DIC_top, width = 5, height = 2.5, dpi = 300)
```

## SO4
```{r}
SO4_MS <- SalmonR_filtered_MS %>%
  filter(!is.na(f_SO4_mg_per_l))

DA_x_breaks <- seq(0,25, by = 2.5)
DA_x_labels <- c(0,"",5,"",10,"",15,"",20,"",25)
DA_labels

SO4_breaks <- seq(0,900, by = 50)
SO4_labels <- c(0,"",100, "", 200, "", 300, "", 400, "", 500, "", 600, "", 700, "", 800, "850", 900)
```

### Area Plot
```{r}
SalmonR_SO4_area <- ggplot() +
  geom_area(data = SalmonR_filtered_MS, 
            aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l),
            fill = "#2daa9e") +
  geom_line(data = SalmonR_filtered_MS, 
            aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), 
            color = "#1d6e66", linewidth = 0.4) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11), 
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
  coord_cartesian(x = c(1,22.5), y = c(0, 300)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, 
                     expand = expansion(mult = c(0.03, 0))) +
  scale_y_continuous(breaks = SO4_breaks, labels = SO4_labels) +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  DA_theme

SalmonR_SO4_area
```

```{r}
SalmonR_SO4 <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting, f_SO4_mg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting)) %>%
  mutate(SO4 = f_SO4_mg_per_l)

view(SalmonR_SO4)
```

```{r}
SalmonR_trib_SO4_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_SO4_mg_per_l) %>%
  mutate(SO4 = f_SO4_mg_per_l)

view(SalmonR_trib_SO4_area)
```

```{r}
ref_map <- tibble(
  SamplingEventID = c("SalmonR_Trib1_20230722_1745", "SalmonR_Trib2_20230722_1911", "SheepC_1_20230719_0923", 
                      "Anaktok_1_20230723_1945", "SalmonR_Trib3_20230724_1140", "SalmonR_Trib4_20230724_1155", 
                      "SalmonR_Trib5_20230724_1311", "SalmonR_Trib6_20230724_1428", "SalmonR_Trib7_20230724_1453"),
  RefID = c("SalmonR_MS_above_Trib1_20230722_1753", "SalmonR_MS_above_Trib2_20230722_1915", 
            "SalmonR_MS_at_SheepC_20230719_0927", "SalmonR_MS_at_SheepC_20230719_0927", 
            "SalmonR_MS_at_SheepC_20230719_0927", "SalmonR_MS_at_SheepC_20230719_0927", 
            "SalmonR_MS_at_SheepC_20230719_0927", "SalmonR_MS_at_SheepC_20230719_0927", 
            "SalmonR_MS_at_SheepC_20230719_0927")
) # SalmonR_MS_above_Trib6_20230724_1439 was switched for SalmonR_MS_at_SheepC_20230719_0927 because there are no sulfate measurements at the MS above Trib 6 site

rel_data <- SalmonR_SO4 %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(SalmonR_SO4 %>%
              dplyr::select(RefID = SamplingEventID, ref_SO4 = SO4),
            by = "RefID") %>%
  mutate(rel_SO4 = SO4 / ref_SO4)

view(rel_data)

```

```{r}

```

```{r}

```

```{r}
SalmonR_SO4_top <- ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SO4_MS, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), color = "black", size = 1) +
geom_point(data = SO4_MS, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), pch = 21, color = "black", 
           #fill = "#2DAA9E",
           fill = "#28968b",
           size = 4, stroke = 1.3) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = Salmon_unimpaired_tribs, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = Salmon_impaired_tribs, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), pch = 25, color = "black", 
             fill = "indianred2", 
             size = 3.3, stroke = 1.2) +
  coord_cartesian(x = c(0, 22), y = c(0, 450)) +
  scale_x_continuous( 
    breaks = DA_breaks,
    labels = DA_labels) +
  scale_y_continuous(
    breaks = SO4_breaks,
    labels = SO4_labels
  ) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    plot.margin = margin(0, 5, 0, 2)
  )

SalmonR_SO4_top

#ggsave("C:/Users/tevinger/Downloads/SalmonR DIC.png", SalmonR_DIC_top, width = 5, height = 2.5, dpi = 300)
```

```{r}
SalmonR_SO4_bottom <- ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SO4_MS, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), color = "black", size = 1) +
geom_point(data = SO4_MS, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), pch = 21, color = "black", 
           #fill = "#2DAA9E",
           fill = "#28968b",
           size = 4, stroke = 1.3) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = Salmon_unimpaired_tribs, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = Salmon_impaired_tribs, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), pch = 25, color = "black", 
             fill = "indianred2", 
             size = 3.3, stroke = 1.2) +
  coord_cartesian(x = c(0, 22), y = c(850, 900)) +
  scale_x_continuous( 
    breaks = DA_breaks,
    labels = DA_labels) +
  scale_y_continuous(
    breaks = SO4_breaks,
    labels = SO4_labels
  ) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    plot.margin = margin(0, 5, 0, 2),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

SalmonR_SO4_bottom
```

```{r}
SalmonR_SO4_combo <- SalmonR_SO4_bottom / SalmonR_SO4_top + plot_layout(
  heights = c(1, 4), 
  guides = "collect") & theme(plot.margin = margin(0, 5, 0, 2), panel.background = element_rect(fill = "NA", color = "NA"), # Panel background
    plot.background = element_rect(fill = "NA", color = "NA") # Plot background
    )

SalmonR_SO4_combo

ggsave("C:/Users/tevinger/Downloads/SalmonR SO4.png", SalmonR_SO4_combo, width = 5, height = 2.5, dpi = 300)

```

## Mg
```{r}
Mg_MS <- SalmonR_filtered_MS %>%
  filter(!is.na(f_Mg_mg_l))

DA_x_breaks <- seq(0,25, by = 2.5)
DA_x_labels <- c(0,"",5,"",10,"",15,"",20,"",25)
DA_labels

Mg_breaks <- seq(0,130, by = 5)
Mg_labels <- c("0", "", "", "", "20", "", "", "", "40", "", "", "", "60", "", "", "", "80", "", "", "", "100", "", "", "", "120", "125", "")

Mg_bottom_breaks <- seq(0,60, by = 10)
Mg_bottom_labels <- c(0,"",20,"",40,"",60)

print(Mg_labels)
```

```{r}
SalmonR_Mg_bottom <- ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = Mg_MS, aes(x = Rel_Water_Area_plotting, y = f_Mg_mg_l), color = "black", size = 1) +
geom_point(data = Mg_MS, aes(x = Rel_Water_Area_plotting, y = f_Mg_mg_l), pch = 21, color = "black", 
           #fill = "#2DAA9E",
           fill = "#28968b",
           size = 4, stroke = 1.3) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = Salmon_unimpaired_tribs, aes(x = Rel_Water_Area_plotting, y = f_Mg_mg_l), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = Salmon_impaired_tribs, aes(x = Rel_Water_Area_plotting, y = f_Mg_mg_l), pch = 25, color = "black", 
             fill = "indianred2", 
             size = 3.3, stroke = 1.2) +
  coord_cartesian(x = c(0, 22), y = c(0, 60)) +
  scale_x_continuous( 
    breaks = DA_breaks,
    labels = DA_labels) +
  scale_y_continuous(breaks = Mg_bottom_breaks, labels = Mg_bottom_labels) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    plot.margin = margin(0, 5, 0, 2)
  )

SalmonR_Mg_bottom

#ggsave("C:/Users/tevinger/Downloads/SalmonR DIC.png", SalmonR_DIC_top, width = 5, height = 2.5, dpi = 300)
```

```{r}
SalmonR_Mg_top <- ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = Mg_MS, aes(x = Rel_Water_Area_plotting, y = f_Mg_mg_l), color = "black", size = 1) +
geom_point(data = Mg_MS, aes(x = Rel_Water_Area_plotting, y = f_Mg_mg_l), pch = 21, color = "black", 
           #fill = "#2DAA9E",
           fill = "#28968b",
           size = 4, stroke = 1.3) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = Salmon_unimpaired_tribs, aes(x = Rel_Water_Area_plotting, y = f_Mg_mg_l), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = Salmon_impaired_tribs, aes(x = Rel_Water_Area_plotting, y = f_Mg_mg_l), pch = 25, color = "black", 
             fill = "indianred2", 
             size = 3.3, stroke = 1.2) +
  coord_cartesian(x = c(0, 22), y = c(120, 125)) +
  scale_x_continuous( 
    breaks = DA_breaks,
    labels = DA_labels) +
  scale_y_continuous(breaks = Mg_breaks, labels = Mg_labels) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    plot.margin = margin(0, 5, 0, 2),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

SalmonR_Mg_top
```

```{r}
SalmonR_Mg_combo <- SalmonR_Mg_top / SalmonR_Mg_bottom + plot_layout(
  heights = c(1, 4), 
  guides = "collect") & theme(plot.margin = margin(0, 5, 0, 2), panel.background = element_rect(fill = "NA", color = "NA"), # Panel background
    plot.background = element_rect(fill = "NA", color = "NA") # Plot background
    )

SalmonR_Mg_combo

ggsave("C:/Users/tevinger/Downloads/SalmonR Mg.png", SalmonR_Mg_combo, width = 5, height = 2.5, dpi = 300)

```

# Area Plots
## Fe
```{r}
SalmonR_Fe <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification,Rel_Water_Area_plotting, u_Fe_mcg_per_l, f_Fe_mcg_per_l, p_Fe_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

view(SalmonR_Fe)
```

### area plot
```{r}

# Calculate tributary metal concentrations relative to the nearest upstream MS sample concentration for heat plot

# Step 1: A reference map for each row that needs normalization
ref_map <- tibble(
  SamplingEventID = c(
  "SalmonR_Trib1_20230722_1745",
  "SalmonR_Trib2_20230722_1911",
  "SheepC_1_20230719_0923",
  "Anaktok_1_20230723_1945",
  "SalmonR_Trib3_20230724_1140",
  "SalmonR_Trib4_20230724_1155",
  "SalmonR_Trib5_20230724_1311",
  "SalmonR_Trib6_20230724_1428",
  "SalmonR_Trib7_20230724_1453"
),
  RefID = c(
  "SalmonR_MS_above_Trib1_20230722_1753",
  "SalmonR_MS_above_Trib2_20230722_1915",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_above_Trib6_20230724_1439",
  "SalmonR_MS_above_Trib6_20230724_1439"
)
)

# Step 2: Join main data to get both the value row and its reference row
rel_data <- SalmonR_Fe %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(SalmonR_Fe %>%
              dplyr::select(RefID = SamplingEventID, 
                     ref_u_Fe = u_Fe_mcg_per_l,
                     ref_f_Fe = f_Fe_mcg_per_l,
                     ref_p_Fe = p_Fe_mcg_per_l),
            by = "RefID") %>%
  mutate(
    rel_u_Fe = u_Fe_mcg_per_l / ref_u_Fe,
    rel_f_Fe = f_Fe_mcg_per_l / ref_f_Fe,
    rel_p_Fe = p_Fe_mcg_per_l / ref_p_Fe
  )
  
view(rel_data)
```

```{r}
#join the relative concentrations to the main data
rel_data_to_join <- rel_data %>%
  dplyr::select(SamplingEventID, rel_u_Fe, rel_f_Fe, rel_p_Fe)

SalmonR_Fe_with_rel <- SalmonR_Fe %>%
  left_join(rel_data_to_join, by = "SamplingEventID")

#view(SalmonR_Fe_with_rel)
```

```{r}
# extend the data to have a fake continuous x axis with fake data

# Create full sequence from 0 to 22.5 by 0.05
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

# Join original df with the full sequence
df_expanded <- full_sequence %>%
  left_join(rel_data, by = "Rel_Water_Area_plotting")

rel_data_to_plot <- df_expanded %>%
  dplyr::select(-c(u_Fe_mcg_per_l, f_Fe_mcg_per_l, p_Fe_mcg_per_l, ref_u_Fe, ref_f_Fe, ref_p_Fe)) %>%
   mutate(Rel_Water_Area_plotting = as.numeric(Rel_Water_Area_plotting)) %>%
  mutate(Rel_Water_Area_plotting = round(Rel_Water_Area_plotting, 2))

Anaktok_salmon <- rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(u_Fe_mcg_per_l, f_Fe_mcg_per_l, p_Fe_mcg_per_l, ref_u_Fe, ref_f_Fe, ref_p_Fe)) %>%
   mutate(Rel_Water_Area_plotting = as.numeric(Rel_Water_Area_plotting)) %>%
  mutate(Rel_Water_Area_plotting = round(Rel_Water_Area_plotting, 2))

# Replace the existing row with the one from Anaktok_salmon
rel_data_to_plot <- rel_data_to_plot %>%
  rows_update(Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(rel_data_to_plot)
```

Manually add data values to relative data to control more of how the NA values are interpolated
```{r}
mod_data <- data.frame(
  Rel_Water_Area_plotting = c(0, 4.7, 6.2, 7.95, 8.05, 8.95, 10.85, 10.90, 10.95, 15, 22.5),
  rel_u_Fe = c(0, 1, 0.2, 0.02, 0.03, 0.02, 0.7, 0.6, 0.5, 0, 0),
  rel_f_Fe = c(0, 8, 15, 0.2, 0.3, 0.1, 0.1, 0.09, 0.05, 0, 0),
  rel_p_Fe = c(0, 1, 0.2, 0.02, 0.02, 0.01, 1.15, 1.05, 1, 0, 0)
) %>%
  mutate(across(everything(), as.numeric))

rel_data_mod <- rel_data_to_plot %>%
  rows_update(mod_data, by = "Rel_Water_Area_plotting")

view(rel_data_mod)
```

Linear interpolation using na.approx
```{r}
# manually change the highest value
rel_data_mod2 <- rel_data_mod %>%
  mutate(rel_f_Fe = case_when(
    Rel_Water_Area_plotting == 4.75  ~ 75,
    TRUE ~ rel_f_Fe  # keep original value if no match
  ))

# Apply linear interpolation to all numeric columns except Rel_Water_Area_plotting
rel_data_to_plot_interp <- rel_data_mod2 %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

# make the values before the first tributary 0 
rel_data_to_plot_interp[1:75, 6:8] <- 0

#view(rel_data_to_plot_interp)
```

Data interpolation using na_interpolation - spline
```{r}
# spline interpolates a smooth curve through points
rel_data_to_plot_interp_spline <- rel_data_mod %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na_interpolation(., option = "spline", maxgap = Inf)
  ))

#view(rel_data_to_plot_interp_spline)
```

Data interpolation using na_interpolation - stine
```{r}
# stine is similar to spline but avoids overshoots and extreme curves
rel_data_mod2 <- rel_data_mod %>%
  mutate(rel_f_Fe = case_when(
    Rel_Water_Area_plotting == 4.75  ~ 100,
    TRUE ~ rel_f_Fe  # keep original value if no match
  ))

rel_data_to_plot_interp_stine <- rel_data_mod2 %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na_interpolation(., option = "stine", maxgap = Inf)
  ))
```

Interpolation using state space method - na_kalman
```{r}
#na_kalman uses a Kalman filter and smoother to estimate missing values by reconstructing the latent state of the system.

# create a function to replace the NA values before the first value in the df with zeros
fill_leading_zeros <- function(x) {
  first_non_na <- which(!is.na(x))[1]
  if (!is.na(first_non_na) && first_non_na > 1) {
    x[1:(first_non_na - 1)] <- 0  # set leading NAs to 0
  }
  return(x)
}

# Default state space method (StructTS)
filled_series <- rel_data_mod %>%
  mutate(across(
    .cols = c(rel_u_Fe, rel_f_Fe, rel_p_Fe),
    .fns = ~ na_kalman(fill_leading_zeros(.))
  ))

view(filled_series)
```


Mainstem data frame
```{r}
SalmonR_MS_Fe_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Fe_mcg_per_l, u_Fe_mcg_per_l) %>%
  #filter(!(New_Groups == "NA")) %>%
  #filter(p_Fe_mcg_per_l >= 0.01) %>%
  pivot_longer(
    cols = c(f_Fe_mcg_per_l, u_Fe_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Fe_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) # filtering out here means only the f or p value that is NA is excluded, not both measurements for the same sample

view(SalmonR_MS_Fe_area)

MS_f_Fe_area <- SalmonR_MS_Fe_area %>%
  filter(Metal_type == "f")

MS_u_Fe_area <- SalmonR_MS_Fe_area %>%
  filter(Metal_type == "u")
```

Tributary data frame
```{r}
SalmonR_trib_Fe_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Fe_mcg_per_l, u_Fe_mcg_per_l) %>%
  #filter(!(New_Groups == "NA")) %>%
  #filter(p_Fe_mcg_per_l >= 0.01) %>%
  pivot_longer(
    cols = c(f_Fe_mcg_per_l, u_Fe_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Fe_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) # filtering out here means only the f or p value that is NA is excluded, not both measurements for the same sample

view(SalmonR_trib_Fe_area)

trib_f_Fe_area <- SalmonR_trib_Fe_area %>%
  filter(Metal_type == "f")

trib_u_Fe_area <- SalmonR_trib_Fe_area %>%
  filter(Metal_type == "u")
```

Plotting the actual tributary concentrations
```{r}
SalmonR_Fe_area_no_tribs <- ggplot() +

  geom_area(data = MS_u_Fe_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            #fill = "#28968b"
            fill = "grey30"
            #alpha = 0.85
            ) +
  
  geom_line(data = MS_u_Fe_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), color = "grey28", linewidth = 0.5) +
  
  geom_area(data = MS_f_Fe_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            #fill = "#c9f1e4") + # light blue/green for filtered
            fill = "#2daa9e") + # darker green for filtered paired with grey for particulate
            #fill = "#caf1ed",
  
  geom_line(data = MS_f_Fe_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), color = "#1d6e66", linewidth = 0.4) +
  
  # Points for SalmonR_filtered_Trib
  #geom_point(data = trib_f_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", fill = "#a1e6ce",size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  #geom_point(data = impaired_f_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, color = "indianred2", size = 4, stroke = 1.2) +

  # Points for SalmonR_filtered_Trib
  #geom_point(data = trib_p_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", fill = "grey",size = 3.4, stroke = 1.2) +
  #geom_point(data = impaired_p_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, color = "indianred4", size = 4, stroke = 1.2) +
  
  # lines for locations of sampled tributaries
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11), linetype = "dashed", color = "grey15", linewidth = 0.5) +
  
  coord_cartesian(x = c(1,22.5), y = c(1,10000)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.03, 0))) +
  scale_y_log10(breaks = c(0.01,0.1,1,10,100,1000,10000, 100000), labels = scales::comma, expand = expansion(mult = c(0.02, 0.02))) +
  annotation_logticks(sides = "l") +
  labs(
    #x = "Relative Watershed Area",
    #y = "Metal Concentration",
    x = NULL,
    y = NULL,
    title = NULL
    #title = "Fe Area Plot - Unfiltered and Filtered"
  ) +
  theme_minimal() +
  DA_theme

#SalmonR_Fe_area_tribs

SalmonR_Fe_area_no_tribs

#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SalmonR Fe area plot practice.png", SalmonR_Fe_area, width = 5.1, height = 2.5, dpi = 300)
```

### Trib heat plot
na.aprox method
```{r}
f_Fe_heat <- ggplot(rel_data_to_plot_interp, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Fe)) +
  geom_tile(color = NA, width = 0.05) +
   geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(
     title = NULL,
    #title = "na.approx method",
    x = NULL,
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  coord_cartesian(x = c(1,22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.03, 0))) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    #axis.ticks.x = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.position = "none"
  )

f_Fe_heat

p_Fe_heat <- ggplot(rel_data_to_plot_interp, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_p_Fe)) +
  geom_tile(color = NA, width = 0.05) +
   geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "#301934") +
  labs(
    title = NULL,
    #title = "na.approx method",
    x = NULL,
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  coord_cartesian(x = c(1,22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.03, 0))) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.position = "none"
  )

p_Fe_heat

Salmon_Fe_combined <- p_Fe_heat / f_Fe_heat
Salmon_Fe_combined

#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SalmonR Fe tributary heat plot with legend.png", Salmon_Fe_combined, width = 5.1, height = 2.5, dpi = 300)
```

```{r}
SalmonR_Fe_area_combo <- (
  Salmon_Fe_combined / SalmonR_Fe_area_no_tribs +
  plot_layout(ncol = 1, nrow = 3, heights = c(1, 1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA)
  )

SalmonR_Fe_area_combo

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Fe area plus heat plot.png", SalmonR_Fe_area_combo, width = 5, height = 2.5, dpi = 300)
```

na_interpolation - spline
```{r}
f_Fe_heat_spline <- ggplot(rel_data_to_plot_interp_spline, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Fe)) +
  geom_tile(color = NA, width = 0.05) +
   geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "lightblue", high = "darkred") +
  labs(
    title = "na_interpolation spline method",
    x = "Relative Water Area",
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank()
  )

f_Fe_heat_spline

```

na_interpolation - stine
```{r}
f_Fe_heat_stine <- ggplot(rel_data_to_plot_interp_stine, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Fe)) +
  geom_tile(color = NA, width = 0.05) +
   geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "lightblue", high = "darkred") +
  labs(
    title = "na_interpolation stine method",
    x = "Relative Water Area",
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank()
  )

f_Fe_heat_stine

```

na_kalman
```{r}
p_Fe_heat_kalman <- ggplot(filled_series, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_p_Fe)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(
    xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
    linetype = "dashed", color = "black", linewidth = 0.5
  ) +
  scale_fill_gradientn(
    colours = c("lightblue", "darkred")
  ) +
  labs(
    title = "na_kalman method",
    x = "Relative Water Area",
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank()
  )

p_Fe_heat_kalman
```


### geom_point
```{r}
# Select MS Fe data
# Filter NA values in the grouping variable, filter particulate concentrations and make long format
SalmonR_MS_Fe_long <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Fe_mcg_per_l, f_Fe_mcg_per_l_qa, p_Fe_mcg_per_l, p_Fe_mcg_per_l_qa) %>%
  #filter(!(New_Groups == "NA")) %>%
  #filter(p_Fe_mcg_per_l >= 0.01) %>%
  pivot_longer(
    cols = c(f_Fe_mcg_per_l, p_Fe_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Fe_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>% # filtering out here means only the f or p value that is NA is excluded, not both measurements for the same sample
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*1), 
                                  Metal_conc))

view(SalmonR_MS_Fe_long)

MS_f_Fe_long <- SalmonR_MS_Fe_long %>%
  filter(Metal_type == "f")

MS_p_Fe_long <- SalmonR_MS_Fe_long %>%
  filter(Metal_type == "p")
```

```{r}
# Select unimpaired trib Fe data
# Filter NA values in the grouping variable, filter particulate concentrations and make long format
SalmonR_trib_Fe_long <- Salmon_unimpaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Fe_mcg_per_l, f_Fe_mcg_per_l_qa, p_Fe_mcg_per_l, p_Fe_mcg_per_l_qa) %>%
  #filter(!(New_Groups == "NA")) %>%
  #filter(p_Fe_mcg_per_l >= 0.01) %>%
  pivot_longer(
    cols = c(f_Fe_mcg_per_l, p_Fe_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Fe_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>% # filtering out here means only the f or p value that is NA is excluded, not both measurements for the same sample
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*1), 
                                  Metal_conc))

view(SalmonR_trib_Fe_long)

trib_f_Fe_long <- SalmonR_trib_Fe_long %>%
  filter(Metal_type == "f")

trib_p_Fe_long <- SalmonR_trib_Fe_long %>%
  filter(Metal_type == "p")
```

```{r}
# Select impaired trib Fe data
# Filter NA values in the grouping variable, filter particulate concentrations and make long format
SalmonR_impaired_Fe_long <- Salmon_impaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Fe_mcg_per_l, f_Fe_mcg_per_l_qa, p_Fe_mcg_per_l, p_Fe_mcg_per_l_qa) %>%
  #filter(!(New_Groups == "NA")) %>%
  #filter(p_Fe_mcg_per_l >= 0.01) %>%
  pivot_longer(
    cols = c(f_Fe_mcg_per_l, p_Fe_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Fe_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>% # filtering out here means only the f or p value that is NA is excluded, not both measurements for the same sample
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*1), 
                                  Metal_conc))

view(SalmonR_impaired_Fe_long)

impaired_f_Fe_long <- SalmonR_impaired_Fe_long %>%
  filter(Metal_type == "f")

impaired_p_Fe_long <- SalmonR_impaired_Fe_long %>%
  filter(Metal_type == "p")
```

```{r}
SalmonR_Fe_top <- ggplot() +
  # Filtered Fe
  # Line plot for SalmonR_filtered_MS
  geom_line(data = MS_f_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
geom_point(data = MS_f_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, color = "black", 
           #fill = "#2DAA9E",
           fill = "#28968b",
           size = 4, stroke = 1.3) +
  
  # Points for SalmonR_filtered_Trib
  geom_point(data = trib_f_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = impaired_f_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, 
             #color = "black", 
             color = "indianred2", 
             size = 4, stroke = 1.2) +
  
  # Particulate Fe
  # Line plot for SalmonR_filtered_MS
  geom_line(data = MS_p_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
geom_point(data = MS_p_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, 
           color = "black", 
           #fill = "#2DAA9E",
           fill = "grey28",
           size = 4, stroke = 1.3) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = trib_p_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "grey",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = impaired_p_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, 
             #color = "black", 
             color = "indianred4", 
             size = 4, stroke = 1.2) +
  coord_cartesian(x = c(0, 22), y = c(19900, 19960)) +
  scale_x_continuous(breaks = DA_breaks, labels = DA_labels) +
  scale_y_log10(breaks = c(19900,19950), labels = scales::comma) +
  annotation_logticks(sides = "l") +
  #scale_y_continuous(breaks = DIC_breaks,labels = DIC_labels) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    plot.margin = margin(0, 5, 0, 2),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

SalmonR_Fe_top

#ggsave("C:/Users/tevinger/Downloads/SalmonR DIC.png", SalmonR_DIC_top, width = 5, height = 2.5, dpi = 300)
```

```{r}
SalmonR_Fe_bottom <- ggplot() +
  # Filtered Fe
  # Line plot for SalmonR_filtered_MS
  geom_line(data = MS_f_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
geom_point(data = MS_f_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, color = "black", 
           #fill = "#2DAA9E",
           fill = "#28968b",
           size = 4, stroke = 1.3) +
  
  # Line plot for particulate Fe SalmonR_filtered_MS
  geom_line(data = MS_p_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
geom_point(data = MS_p_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, 
           color = "black", 
           #fill = "#2DAA9E",
           fill = "grey28",
           size = 4, stroke = 1.3) +
  
  # Points for SalmonR_filtered_Trib
  geom_point(data = trib_f_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = impaired_f_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, 
             #color = "black", 
             color = "indianred2", 
             size = 4, stroke = 1.2) +
  
  # Particulate Fe
  
  # Points for SalmonR_filtered_Trib
  geom_point(data = trib_p_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "grey",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = impaired_p_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, 
             #color = "black", 
             color = "indianred4", 
             size = 4, stroke = 1.2) +
  coord_cartesian(x = c(0, 22), y = c(5, 7000)) +
  scale_x_continuous(breaks = DA_breaks, labels = DA_labels) +
  scale_y_log10(breaks = c(1,10,100,1000), labels = scales::comma) +
  annotation_logticks(sides = "l") +
  #scale_y_continuous(breaks = c(0,100,200,300,400,500,1000), labels = c(0,100,200,300,400,500,1000)) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    plot.margin = margin(0, 5, 0, 2),
    axis.title.x = element_blank()
    
  )

SalmonR_Fe_bottom
```

```{r}
SalmonR_Fe_combo <- SalmonR_Fe_top / SalmonR_Fe_bottom + plot_layout(
  heights = c(1, 5), 
  guides = "collect") & theme(plot.margin = margin(0, 5, 0, 2), panel.background = element_rect(fill = "NA", color = "NA"), # Panel background
    plot.background = element_rect(fill = "NA", color = "NA") # Plot background
    )

SalmonR_Fe_combo

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SalmonR Fe.png", SalmonR_Fe_combo, width = 5.1, height = 2.5, dpi = 300)

```

## Zn
### Data frames
```{r}
SalmonR_Zn <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification,Rel_Water_Area_plotting, u_Zn_mcg_per_l, f_Zn_mcg_per_l, p_Zn_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

view(SalmonR_Zn)
```

Mainstem data frame
```{r}
SalmonR_MS_Zn_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Zn_mcg_per_l, u_Zn_mcg_per_l) %>%
  #filter(!(New_Groups == "NA")) %>%
  #filter(p_Fe_mcg_per_l >= 0.01) %>%
  pivot_longer(
    cols = c(f_Zn_mcg_per_l, u_Zn_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Zn_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) # filtering out here means only the f or p value that is NA is excluded, not both measurements for the same sample

#view(SalmonR_MS_Zn_area)

MS_f_Zn_area <- SalmonR_MS_Zn_area %>%
  filter(Metal_type == "f")

MS_u_Zn_area <- SalmonR_MS_Zn_area %>%
  filter(Metal_type == "u")
```

Tributary data frame
```{r}
SalmonR_trib_Zn_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Zn_mcg_per_l, u_Zn_mcg_per_l) %>%
  #filter(!(New_Groups == "NA")) %>%
  #filter(p_Fe_mcg_per_l >= 0.01) %>%
  pivot_longer(
    cols = c(f_Zn_mcg_per_l, u_Zn_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Fe_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) # filtering out here means only the f or p value that is NA is excluded, not both measurements for the same sample

#view(SalmonR_trib_Zn_area)

trib_f_Zn_area <- SalmonR_trib_Zn_area %>%
  filter(Metal_type == "f")

trib_u_Zn_area <- SalmonR_trib_Zn_area %>%
  filter(Metal_type == "u")
```

Modifications for heat plots
```{r}
# Calculate tributary metal concentrations relative to the nearest upstream MS sample concentration for heat plot

# Step 1: A reference map for each row that needs normalization
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745",
    "SalmonR_Trib2_20230722_1911",
    "SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945",
    "SalmonR_Trib3_20230724_1140",
    "SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311",
    "SalmonR_Trib6_20230724_1428",
    "SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753",
    "SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

# Step 2: Join main data to get both the value row and its reference row
rel_data <- SalmonR_Zn %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(SalmonR_Zn %>%
              dplyr::select(RefID = SamplingEventID, 
                            ref_u_Zn = u_Zn_mcg_per_l,
                            ref_f_Zn = f_Zn_mcg_per_l,
                            ref_p_Zn = p_Zn_mcg_per_l),
            by = "RefID") %>%
  mutate(
    rel_u_Zn = u_Zn_mcg_per_l / ref_u_Zn,
    rel_f_Zn = f_Zn_mcg_per_l / ref_f_Zn,
    rel_p_Zn = p_Zn_mcg_per_l / ref_p_Zn
  )

view(rel_data)

```

```{r}
# Join the relative concentrations to the main data
rel_data_to_join <- rel_data %>%
  dplyr::select(SamplingEventID, rel_u_Zn, rel_f_Zn, rel_p_Zn)

SalmonR_Zn_with_rel <- SalmonR_Zn %>%
  left_join(rel_data_to_join, by = "SamplingEventID")

view(SalmonR_Zn_with_rel)

```

```{r}
# Extend the data to have a fake continuous x axis with fake data

# Create full sequence from 0 to 22.5 by 0.05
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

# Join original df with the full sequence
df_expanded <- full_sequence %>%
  left_join(rel_data, by = "Rel_Water_Area_plotting")

rel_data_to_plot <- df_expanded %>%
  dplyr::select(-c(u_Zn_mcg_per_l, f_Zn_mcg_per_l, p_Zn_mcg_per_l, ref_u_Zn, ref_f_Zn, ref_p_Zn)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Anaktok_salmon <- rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(u_Zn_mcg_per_l, f_Zn_mcg_per_l, p_Zn_mcg_per_l, ref_u_Zn, ref_f_Zn, ref_p_Zn)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

# Replace the existing row with the one from Anaktok_salmon
rel_data_to_plot <- rel_data_to_plot %>%
  rows_update(Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(rel_data_to_plot)

```

Manually add data values to relative data to control more of how the NA values are interpolated
```{r}
## Use this if values need to be set manually prior to filling the missing values

mod_data <- data.frame(
  Rel_Water_Area_plotting = c(4.35, 6.2, 6.3, 7.95, 8.95, 10.75, 10.95, 14),
  rel_u_Zn = c(2, 0.6, 0.02, 0.15, 0.01, 0.2, 2, 0),
  rel_f_Zn = c(4, 3, 0.06, 0.3, 0.01, 0.4, 1, 0),
  rel_p_Zn = c(2, 0.004, 0.004, 0.055, 0.01, 0.1, 6, 0)
) %>%
  mutate(across(everything(), as.numeric))

rel_data_mod <- rel_data_to_plot %>%
  rows_update(mod_data, by = "Rel_Water_Area_plotting")

view(rel_data_mod)
```

Linear interpolation using na.approx
```{r}
## use this if any values need to be manually changed for the way the plot looks

# Manually change the highest value
rel_data_mod2 <- rel_data_mod %>%
  mutate(rel_f_Zn = case_when(
    Rel_Water_Area_plotting == 4.75 ~ 75,
    TRUE ~ rel_f_Zn  # keep original value if no match
  ))
```

```{r}
# Apply linear interpolation to all numeric columns except Rel_Water_Area_plotting
rel_data_to_plot_interp <- rel_data_mod %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

# Make the values before the first tributary 0 (adjust column indices if needed)
rel_data_to_plot_interp[1:75, 6:8] <- 0

view(rel_data_to_plot_interp)

```

### Trib heat plots
```{r}
# Heatmap for filtered Zn
f_Zn_heat <- ggplot(rel_data_to_plot_interp, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Zn)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(
    title = NULL,
    x = NULL,
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.03, 0))) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    legend.position = "none",
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank()
  )

f_Zn_heat

# Heatmap for particulate Zn
p_Zn_heat <- ggplot(rel_data_to_plot_interp, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_p_Zn)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "#301934") +
  labs(
    title = NULL,
    x = NULL,
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.03, 0))) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    axis.ticks.x = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank()
  )

p_Zn_heat
```

```{r}
# Combine Zn heatmaps
Salmon_Zn_combined <- p_Zn_heat / f_Zn_heat
Salmon_Zn_combined

# Save final plot
#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Zn trib heat plots with legend.png", Salmon_Zn_combined, width = 5, height = 2.5, dpi = 300)
```

```{r}
SalmonR_Zn_area <- ggplot() +
  # area plots
  geom_area(data = MS_u_Zn_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            #fill = "#28968b"
            fill = "grey30",
            #alpha = 0.85
            ) +
  
  geom_line(data = MS_u_Zn_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), color = "grey28", linewidth = 0.5) +
  
  geom_area(data = MS_f_Zn_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            #fill = "#c9f1e4") + # light blue/green for filtered
            fill = "#2daa9e") + # darker green for filtered paired with grey for particulate
            #fill = "#caf1ed",
  
  geom_line(data = MS_f_Zn_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), color = "#1d6e66", linewidth = 0.4) +
  
  # lines for locations of sampled tributaries
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11), linetype = "dashed", color = "grey15", linewidth = 0.5) +
  
  coord_cartesian(x = c(1,22.5), y = c(1,230)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.03, 0))) +
  #scale_y_continuous(breaks = c(0,25,50,75,100,125,150,175,200,225), labels = c(0,"",50,"",100,"",150,"",200,""), expand = expansion(mult = c(0.01, 0.02))) +
  scale_y_log10(breaks = c(0.1,1,10,100), labels = scales::comma, expand = expansion(mult = c(0.02,0.02))) +
  annotation_logticks(sides = "l") +
  labs(
    x = NULL,
    y = NULL,
    title = NULL
    #x = "Relative Water Area",
    #y = "Zn (ug/L)",
    #title = "Unfiltered and Filtered"
  ) +
  theme_minimal() +
  DA_theme

SalmonR_Zn_area

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Zn area.png", SalmonR_Zn_area, width = 4.8, height = 1.92, dpi = 300)
```

```{r}
# Final Zn composite plot
SalmonR_Zn_area_combo <- (
  Salmon_Zn_combined / SalmonR_Zn_area +
  plot_layout(ncol = 1, nrow = 3, heights = c(1, 1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA)
  )

SalmonR_Zn_area_combo

# Save final plot
ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Zn area plus heat plot.png",SalmonR_Zn_area_combo, width = 4.6, height = 2.5, dpi = 300)

```

## Al
```{r}
## Al
SalmonR_Al <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting, u_Al_mcg_per_l, f_Al_mcg_per_l, p_Al_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

view(SalmonR_Al)
```

```{r}
SalmonR_MS_Al_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Al_mcg_per_l, u_Al_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Al_mcg_per_l, u_Al_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Al_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

# Split by type
MS_f_Al_area <- SalmonR_MS_Al_area %>%
  filter(Metal_type == "f")

MS_u_Al_area <- SalmonR_MS_Al_area %>%
  filter(Metal_type == "u")

```

```{r}
SalmonR_trib_Al_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Al_mcg_per_l, u_Al_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Al_mcg_per_l, u_Al_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Al_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

# Split by type
trib_f_Al_area <- SalmonR_trib_Al_area %>%
  filter(Metal_type == "f")

trib_u_Al_area <- SalmonR_trib_Al_area %>%
  filter(Metal_type == "u")

```

```{r}
SalmonR_Al_area <- ggplot() +
  # area plots
  geom_area(data = MS_u_Al_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#28968b") +
  
  geom_line(data = MS_u_Al_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), 
            color = "#1d6e66", linewidth = 0.5) +
  
  geom_area(data = MS_f_Al_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#c9f1e4") +
  
  geom_line(data = MS_f_Al_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), 
            color = "#1d6e66", linewidth = 0.4) +
  
  # lines for locations of sampled tributaries
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
  coord_cartesian(x = c(1,22.5), y = c(1,4000)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.02, 0.01))) +
  scale_y_log10(breaks = c(0.01,0.1,1,10,100,1000), labels = scales::comma, expand = expansion(mult = c(0.02, 0.02))) +
  annotation_logticks(sides = "l") +
  labs(
    x = "Relative Water Area",
    y = "Al (µg/L)",
    title = "Unfiltered and Filtered"
  ) +
  theme_minimal() +
  DA_theme

SalmonR_Al_area

```

## Ni
```{r}
## Ni
SalmonR_Ni <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting, u_Ni_mcg_per_l, f_Ni_mcg_per_l, p_Ni_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

view(SalmonR_Ni)
```

```{r}
SalmonR_MS_Ni_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Ni_mcg_per_l, u_Ni_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Ni_mcg_per_l, u_Ni_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Ni_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

# Split by type
MS_f_Ni_area <- SalmonR_MS_Ni_area %>%
  filter(Metal_type == "f")

MS_u_Ni_area <- SalmonR_MS_Ni_area %>%
  filter(Metal_type == "u")

```

```{r}
SalmonR_trib_Ni_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Ni_mcg_per_l, u_Ni_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Ni_mcg_per_l, u_Ni_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Ni_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

# Split by type
trib_f_Ni_area <- SalmonR_trib_Ni_area %>%
  filter(Metal_type == "f")

trib_u_Ni_area <- SalmonR_trib_Ni_area %>%
  filter(Metal_type == "u")

```

```{r}
SalmonR_Ni_area <- ggplot() +
  # area plots
  geom_area(data = MS_u_Ni_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#28968b") +
  
  geom_line(data = MS_u_Ni_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), 
            color = "#1d6e66", linewidth = 0.5) +
  
  geom_area(data = MS_f_Ni_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#c9f1e4") +
  
  geom_line(data = MS_f_Ni_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), 
            color = "#1d6e66", linewidth = 0.4) +
  
  # lines for locations of sampled tributaries
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
  coord_cartesian(x = c(1,22.5), y = c(0,150)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.02, 0.01))) +
  #scale_y_log10(breaks = c(0.01,0.1,1,10,100), labels = scales::comma, expand = expansion(mult = c(0.02, 0.02))) +
  #annotation_logticks(sides = "l") +
  labs(
    x = "Relative Water Area",
    y = "Ni (µg/L)",
    title = "Unfiltered and Filtered"
  ) +
  theme_minimal() +
  DA_theme

SalmonR_Ni_area

```

## Cd
```{r}
## Cd
SalmonR_Cd <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting, u_Cd_mcg_per_l, f_Cd_mcg_per_l, p_Cd_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

view(SalmonR_Cd)
```

```{r}
SalmonR_MS_Cd_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Cd_mcg_per_l, u_Cd_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Cd_mcg_per_l, u_Cd_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Cd_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

# Split by type
MS_f_Cd_area <- SalmonR_MS_Cd_area %>%
  filter(Metal_type == "f")

MS_u_Cd_area <- SalmonR_MS_Cd_area %>%
  filter(Metal_type == "u")

```

```{r}
SalmonR_trib_Cd_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Cd_mcg_per_l, u_Cd_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Cd_mcg_per_l, u_Cd_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Cd_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

# Split by type
trib_f_Cd_area <- SalmonR_trib_Cd_area %>%
  filter(Metal_type == "f")

trib_u_Cd_area <- SalmonR_trib_Cd_area %>%
  filter(Metal_type == "u")

```

```{r}
SalmonR_Cd_area <- ggplot() +
  # area plots
  geom_area(data = MS_u_Cd_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#28968b") +
  
  geom_line(data = MS_u_Cd_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), 
            color = "#1d6e66", linewidth = 0.5) +
  
  geom_area(data = MS_f_Cd_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#c9f1e4") +
  
  geom_line(data = MS_f_Cd_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), 
            color = "#1d6e66", linewidth = 0.4) +
  
  # lines for locations of sampled tributaries
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0.001, ymax = 0.01),
            fill = "gray80", alpha = 0.4) +
  coord_cartesian(x = c(1,22.5), y = c(0,5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.0, 0.01))) +
  labs(
    x = "Relative Water Area",
    y = "Cd (µg/L)",
    title = "Unfiltered and Filtered"
  ) +
  theme_minimal() +
  DA_theme

SalmonR_Cd_area

```

## Cu
```{r}
## Cu
SalmonR_Cu <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting, u_Cu_mcg_per_l, f_Cu_mcg_per_l, p_Cu_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

view(SalmonR_Cu)
```

```{r}
SalmonR_MS_Cu_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Cu_mcg_per_l, u_Cu_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Cu_mcg_per_l, u_Cu_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Cu_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

# Split by type
MS_f_Cu_area <- SalmonR_MS_Cu_area %>%
  filter(Metal_type == "f")

MS_u_Cu_area <- SalmonR_MS_Cu_area %>%
  filter(Metal_type == "u")

```

```{r}
SalmonR_trib_Cu_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Cu_mcg_per_l, u_Cu_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Cu_mcg_per_l, u_Cu_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Cu_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

# Split by type
trib_f_Cu_area <- SalmonR_trib_Cu_area %>%
  filter(Metal_type == "f")

trib_u_Cu_area <- SalmonR_trib_Cu_area %>%
  filter(Metal_type == "u")

```

```{r}
SalmonR_Cu_area <- ggplot() +
  # area plots
  geom_area(data = MS_u_Cu_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#28968b") +
  
  geom_line(data = MS_u_Cu_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), 
            color = "#1d6e66", linewidth = 0.5) +
  
  geom_area(data = MS_f_Cu_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#c9f1e4") +
  
  geom_line(data = MS_f_Cu_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), 
            color = "#1d6e66", linewidth = 0.4) +
  
  # lines for locations of sampled tributaries
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
  
  labs(
    x = "Relative Water Area",
    y = "Cu (µg/L)",
    title = "Unfiltered and Filtered"
  ) +
  theme_minimal() +
  DA_theme

SalmonR_Cu_area

```

# Geom Point Plots
## Zn
```{r}
# MS Zn data
SalmonR_MS_Zn_long <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Zn_mcg_per_l, f_Zn_mcg_per_l_qa, p_Zn_mcg_per_l, p_Zn_mcg_per_l_qa) %>%
  pivot_longer(
    cols = c(f_Zn_mcg_per_l, p_Zn_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Zn_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.1), 
                                  Metal_conc))

MS_f_Zn_long <- SalmonR_MS_Zn_long %>% filter(Metal_type == "f")
MS_p_Zn_long <- SalmonR_MS_Zn_long %>% filter(Metal_type == "p")

# Unimpaired trib Zn data
SalmonR_trib_Zn_long <- Salmon_unimpaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Zn_mcg_per_l, f_Zn_mcg_per_l_qa, p_Zn_mcg_per_l, p_Zn_mcg_per_l_qa) %>%
  pivot_longer(
    cols = c(f_Zn_mcg_per_l, p_Zn_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Zn_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.1), 
                                  Metal_conc))

trib_f_Zn_long <- SalmonR_trib_Zn_long %>% filter(Metal_type == "f")
trib_p_Zn_long <- SalmonR_trib_Zn_long %>% filter(Metal_type == "p")

# Impaired trib Zn data
SalmonR_impaired_Zn_long <- Salmon_impaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Zn_mcg_per_l, f_Zn_mcg_per_l_qa, p_Zn_mcg_per_l, p_Zn_mcg_per_l_qa) %>%
  pivot_longer(
    cols = c(f_Zn_mcg_per_l, p_Zn_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Zn_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.1), 
                                  Metal_conc))

impaired_f_Zn_long <- SalmonR_impaired_Zn_long %>% filter(Metal_type == "f")
impaired_p_Zn_long <- SalmonR_impaired_Zn_long %>% filter(Metal_type == "p")
```

```{r}
# Plot top
SalmonR_Zn_top <- ggplot() +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0.01, ymax = 0.1),
          fill = "gray80", alpha = 0.4) +
  #Filtered Zn
  geom_line(data = MS_f_Zn_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
  geom_point(data = MS_f_Zn_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, color = "black", fill = "#28968b", size = 4, stroke = 1.3) +
  
  #Particulate Zn MS
  geom_line(data = MS_p_Zn_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
  geom_point(data = MS_p_Zn_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, color = "black", fill = "grey28", size = 4, stroke = 1.3) +
  
  # Filtered tribs
  geom_point(data = trib_f_Zn_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", fill = "#a1e6ce", size = 3.4, stroke = 1.2) +
  geom_point(data = impaired_f_Zn_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, color = "indianred2", size = 4, stroke = 1.2) +
  
  # Particulate tribs
  geom_point(data = trib_p_Zn_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", fill = "grey", size = 3.4, stroke = 1.2) +
  geom_point(data = impaired_p_Zn_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, color = "indianred4", size = 4, stroke = 1.2) +
  
  coord_cartesian(x = c(0, 22), y = c(0.05, 300)) +
  scale_x_continuous(breaks = DA_breaks, labels = DA_labels) +
  scale_y_log10(breaks = c(0.1,1,10,100), labels = scales::comma) +
  annotation_logticks(sides = "l") +
  labs(x = "Distance Downstream (km)", y = NULL, color = "Legend") +
  theme_minimal() +
  DA_theme +
  theme(
        axis.title.x = element_blank()
        
        )

SalmonR_Zn_top
```

```{r}
# Bottom plot (same structure as top)
SalmonR_Zn_bottom <- SalmonR_Zn_top +
  coord_cartesian(x = c(0, 22), y = c(2210, 2220)) +
  scale_y_continuous(breaks = c(2210, 2220), labels = c(2210, 2220)) +
  theme(plot.margin = margin(0, 5, 0, 2), axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

SalmonR_Zn_bottom
```

```{r}
# Combine
SalmonR_Zn_combo <- SalmonR_Zn_bottom / SalmonR_Zn_top + plot_layout(
  heights = c(1, 5), 
  guides = "collect") &
  theme(plot.margin = margin(0, 5, 0, 2), 
        panel.background = element_rect(fill = NA, color = NA), 
        plot.background = element_rect(fill = NA, color = NA))

SalmonR_Zn_combo

# Save
ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SalmonR Zn_with DL box.png", SalmonR_Zn_combo, width = 4.95, height = 2.5, dpi = 300)
```

## Ni
```{r}
# MS Ni data
SalmonR_MS_Ni_long <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Ni_mcg_per_l, f_Ni_mcg_per_l_qa, p_Ni_mcg_per_l, p_Ni_mcg_per_l_qa) %>%
  pivot_longer(
    cols = c(f_Ni_mcg_per_l, p_Ni_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Ni_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.1), 
                                  Metal_conc))

MS_f_Ni_long <- SalmonR_MS_Ni_long %>% filter(Metal_type == "f")
MS_p_Ni_long <- SalmonR_MS_Ni_long %>% filter(Metal_type == "p")

# Unimpaired trib Ni data
SalmonR_trib_Ni_long <- Salmon_unimpaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Ni_mcg_per_l, f_Ni_mcg_per_l_qa, p_Ni_mcg_per_l, p_Ni_mcg_per_l_qa) %>%
  pivot_longer(
    cols = c(f_Ni_mcg_per_l, p_Ni_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Ni_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.1), 
                                  Metal_conc))

trib_f_Ni_long <- SalmonR_trib_Ni_long %>% filter(Metal_type == "f")
trib_p_Ni_long <- SalmonR_trib_Ni_long %>% filter(Metal_type == "p")

# Impaired trib Ni data
SalmonR_impaired_Ni_long <- Salmon_impaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Ni_mcg_per_l, f_Ni_mcg_per_l_qa, p_Ni_mcg_per_l, p_Ni_mcg_per_l_qa) %>%
  pivot_longer(
    cols = c(f_Ni_mcg_per_l, p_Ni_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Ni_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.1), 
                                  Metal_conc))

impaired_f_Ni_long <- SalmonR_impaired_Ni_long %>% filter(Metal_type == "f")
impaired_p_Ni_long <- SalmonR_impaired_Ni_long %>% filter(Metal_type == "p")
```

```{r}
SalmonR_Ni_bottom <- ggplot() +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0.01, ymax = 0.1),
          fill = "gray80", alpha = 0.4) +
  # filtered Ni MS
  geom_line(data = MS_f_Ni_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
  geom_point(data = MS_f_Ni_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, color = "black", fill = "#28968b", size = 4, stroke = 1.3) +
  
  # Particulate Ni MS
  geom_line(data = MS_p_Ni_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
  geom_point(data = MS_p_Ni_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, color = "black", fill = "grey28", size = 4, stroke = 1.3) +
  
  # Tribs
  geom_point(data = trib_f_Ni_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", fill = "#a1e6ce", size = 3.4, stroke = 1.2) +
  geom_point(data = impaired_f_Ni_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, color = "indianred2", size = 4, stroke = 1.2) +
  
  geom_point(data = trib_p_Ni_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", fill = "grey", size = 3.4, stroke = 1.2) +
  geom_point(data = impaired_p_Ni_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, color = "indianred4", size = 4, stroke = 1.2) +
  
  coord_cartesian(x = c(0, 22), y = c(0.05, 1100)) +
  scale_x_continuous(breaks = DA_breaks, labels = DA_labels) +
  scale_y_log10(breaks = c(0.1, 1,10,100,1000), labels = scales::comma) +
  annotation_logticks(sides = "l") +
  labs(x = "Distance Downstream (km)", y = NULL, color = "Legend") +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    legend.position = "top"
    )

SalmonR_Ni_bottom
```

```{r}
# Bottom plot (same structure as top)
SalmonR_Ni_top <- SalmonR_Ni_bottom +
  coord_cartesian(x = c(0, 22), y = c(850,860)) +
  scale_y_continuous(breaks = c(850,860), labels = c(850,860)) +
  theme(plot.margin = margin(0, 5, 0, 2), 
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

SalmonR_Ni_top
```

```{r}
# Combine
SalmonR_Ni_combo <- SalmonR_Ni_top / SalmonR_Ni_bottom + plot_layout(
  heights = c(1, 5), 
  guides = "collect") &
  theme(plot.margin = margin(0, 5, 0, 2), 
        panel.background = element_rect(fill = NA, color = NA), 
        plot.background = element_rect(fill = NA, color = NA))

SalmonR_Ni_combo

# Save
ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SalmonR Ni_with DL box.png", SalmonR_Ni_bottom, width = 5.15, height = 2.5, dpi = 300)
```

### For legend
```{r}
# Add a Group column before plotting
MS_f_Ni_long$Group <- "Filtered MS"
MS_p_Ni_long$Group <- "Particulate MS"
trib_f_Ni_long$Group <- "Unimpaired Trib (F)"
impaired_f_Ni_long$Group <- "Impaired Trib (F)"
trib_p_Ni_long$Group <- "Unimpaired Trib (P)"
impaired_p_Ni_long$Group <- "Impaired Trib (P)"

# Then in the plot:
SalmonR_Ni_bottom <- ggplot() +
  geom_point(data = MS_f_Ni_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot, fill = Group),
             shape = 21, color = "black", size = 4, stroke = 1.3) +
  
  geom_point(data = MS_p_Ni_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot, fill = Group),
             shape = 21, color = "black", size = 4, stroke = 1.3) +
  
  geom_point(data = trib_f_Ni_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot, fill = Group),
             shape = 24, color = "black", size = 3.4, stroke = 1.2) +
  
  geom_point(data = trib_p_Ni_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot, fill = Group),
             shape = 24, color = "black", size = 3.4, stroke = 1.2) +
  
  # impaired tribs use color only (pch 8 doesn't use fill)
  geom_point(data = impaired_f_Ni_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot, color = Group),
             shape = 8, size = 4, stroke = 1.2) +
  
  geom_point(data = impaired_p_Ni_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot, color = Group),
             shape = 8, size = 4, stroke = 1.2) +

  # Manual legends for both color and fill
  scale_fill_manual(values = c(
    "Filtered MS" = "#28968b",
    "Particulate MS" = "grey28",
    "Unimpaired Trib (F)" = "#a1e6ce",
    "Unimpaired Trib (P)" = "grey"
  )) +
  
  scale_color_manual(values = c(
    "Impaired Trib (F)" = "indianred2",
    "Impaired Trib (P)" = "indianred4"
  )) +

  labs(x = "Distance Downstream (km)", y = NULL, fill = "Sample Type", color = "Sample Type") +
  theme_minimal() +
  theme(legend.position = "top")


SalmonR_Ni_bottom

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SalmonR legend.png", SalmonR_Ni_bottom, width = 10, height = 2.5, dpi = 300)

```

## REE
```{r}
# MS REE data
SalmonR_MS_REE_long <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_REE, f_REE_qa, p_REE, p_REE_qa) %>%
  pivot_longer(
    cols = c(f_REE, p_REE),
    names_to = "Metal_type",
    names_pattern = "^(.)_REE",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.01), 
                                  Metal_conc))

MS_f_REE_long <- SalmonR_MS_REE_long %>% filter(Metal_type == "f")
MS_p_REE_long <- SalmonR_MS_REE_long %>% filter(Metal_type == "p")

# Unimpaired trib REE data
SalmonR_trib_REE_long <- Salmon_unimpaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_REE, f_REE_qa, p_REE, p_REE_qa) %>%
  pivot_longer(
    cols = c(f_REE, p_REE),
    names_to = "Metal_type",
    names_pattern = "^(.)_REE",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.01), 
                                  Metal_conc))

trib_f_REE_long <- SalmonR_trib_REE_long %>% filter(Metal_type == "f")
trib_p_REE_long <- SalmonR_trib_REE_long %>% filter(Metal_type == "p")

# Impaired trib REE data
SalmonR_impaired_REE_long <- Salmon_impaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_REE, f_REE_qa, p_REE, p_REE_qa) %>%
  pivot_longer(
    cols = c(f_REE, p_REE),
    names_to = "Metal_type",
    names_pattern = "^(.)_REE",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.01), 
                                  Metal_conc))

impaired_f_REE_long <- SalmonR_impaired_REE_long %>% filter(Metal_type == "f")
impaired_p_REE_long <- SalmonR_impaired_REE_long %>% filter(Metal_type == "p")
```

```{r}
# Bottom REE plot with detection limit rectangle
SalmonR_REE_bottom <- ggplot() +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0.001, ymax = 0.01),
            fill = "gray80", alpha = 0.4) +
  # Filtered REE MS
  geom_line(data = MS_f_REE_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
  geom_point(data = MS_f_REE_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, color = "black", fill = "#28968b", size = 4, stroke = 1.3) +
  # Particulate REE MS
  geom_line(data = MS_p_REE_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
  geom_point(data = MS_p_REE_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, color = "black", fill = "grey28", size = 4, stroke = 1.3) +
  # Tribs
  geom_point(data = trib_f_REE_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", fill = "#a1e6ce", size = 3.4, stroke = 1.2) +
  geom_point(data = impaired_f_REE_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, color = "indianred2", size = 4, stroke = 1.2) +
  geom_point(data = trib_p_REE_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", fill = "grey", size = 3.4, stroke = 1.2) +
  geom_point(data = impaired_p_REE_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, color = "indianred4", size = 4, stroke = 1.2) +
  coord_cartesian(x = c(0, 22), y = c(0.005, 1000)) +
  scale_x_continuous(breaks = DA_breaks, labels = DA_labels) +
  scale_y_log10(breaks = c(0.001,0.01,0.1, 1, 10, 100, 1000), labels = scales::comma) +
  annotation_logticks(sides = "l") +
  labs(x = "Distance Downstream (km)", y = NULL, color = "Legend") +
  theme_minimal() +
  DA_theme +
  theme(axis.title.x = element_blank(),
        legend.position = "right")

SalmonR_REE_bottom
```

```{r}
# Top REE plot with adjusted y-axis
SalmonR_REE_top <- SalmonR_REE_bottom +
  coord_cartesian(x = c(0, 22), y = c(585, 595)) +
  scale_y_continuous(breaks = c(585, 595), labels = c(585, 595)) +
  theme(plot.margin = margin(0, 5, 0, 2), 
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

SalmonR_REE_top
```

```{r}
# Combine top and bottom REE plots
SalmonR_REE_combo <- SalmonR_REE_top / SalmonR_REE_bottom + plot_layout(
  heights = c(1, 5), 
  guides = "collect") &
  theme(plot.margin = margin(0, 5, 0, 2), 
        panel.background = element_rect(fill = NA, color = NA), 
        plot.background = element_rect(fill = NA, color = NA))

SalmonR_REE_combo

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SalmonR REE_with DL box.png", SalmonR_REE_bottom, width = 5.25, height = 2.5, dpi = 300)
```

## Cu
```{r}
# MS Cu data
SalmonR_MS_Cu_long <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Cu_mcg_per_l, f_Cu_mcg_per_l_qa, p_Cu_mcg_per_l, p_Cu_mcg_per_l_qa) %>%
  pivot_longer(
    cols = c(f_Cu_mcg_per_l, p_Cu_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Cu_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.1), 
                                  Metal_conc))

MS_f_Cu_long <- SalmonR_MS_Cu_long %>% filter(Metal_type == "f")
MS_p_Cu_long <- SalmonR_MS_Cu_long %>% filter(Metal_type == "p")

# Unimpaired trib Cu data
SalmonR_trib_Cu_long <- Salmon_unimpaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Cu_mcg_per_l, f_Cu_mcg_per_l_qa, p_Cu_mcg_per_l, p_Cu_mcg_per_l_qa) %>%
  pivot_longer(
    cols = c(f_Cu_mcg_per_l, p_Cu_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Cu_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.1), 
                                  Metal_conc))

trib_f_Cu_long <- SalmonR_trib_Cu_long %>% filter(Metal_type == "f")
trib_p_Cu_long <- SalmonR_trib_Cu_long %>% filter(Metal_type == "p")

# Impaired trib Cu data
SalmonR_impaired_Cu_long <- Salmon_impaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Cu_mcg_per_l, f_Cu_mcg_per_l_qa, p_Cu_mcg_per_l, p_Cu_mcg_per_l_qa) %>%
  pivot_longer(
    cols = c(f_Cu_mcg_per_l, p_Cu_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Cu_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.1), 
                                  Metal_conc))

impaired_f_Cu_long <- SalmonR_impaired_Cu_long %>% filter(Metal_type == "f")
impaired_p_Cu_long <- SalmonR_impaired_Cu_long %>% filter(Metal_type == "p")

```

```{r}
# Plot bottom
SalmonR_Cu_bottom <- ggplot() +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0.01, ymax = 0.1),
            fill = "gray80", alpha = 0.4) +
  geom_line(data = MS_f_Cu_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
  geom_point(data = MS_f_Cu_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, color = "black", fill = "#28968b", size = 4, stroke = 1.3) +
  geom_line(data = MS_p_Cu_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
  geom_point(data = MS_p_Cu_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, color = "black", fill = "grey28", size = 4, stroke = 1.3) +
  geom_point(data = trib_f_Cu_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", fill = "#a1e6ce", size = 3.4, stroke = 1.2) +
  geom_point(data = impaired_f_Cu_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, color = "indianred2", size = 4, stroke = 1.2) +
  geom_point(data = trib_p_Cu_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", fill = "grey", size = 3.4, stroke = 1.2) +
  geom_point(data = impaired_p_Cu_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, color = "indianred4", size = 4, stroke = 1.2) +
  coord_cartesian(x = c(0, 22), y = c(0.5, 80)) +
  scale_x_continuous(breaks = DA_breaks, labels = DA_labels) +
  scale_y_log10(breaks = c(0.1, 1,10), labels = scales::comma) +
  annotation_logticks(sides = "l") +
  labs(x = "Distance Downstream (km)", y = NULL, color = "Legend") +
  theme_minimal() +
  DA_theme +
  theme(axis.title.x = element_blank())

SalmonR_Cu_bottom
```

```{r}
ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SalmonR Cu.png", SalmonR_Cu_bottom, width = 4.65, height = 2.5, dpi = 300)
```

## Cd
```{r}
# MS Cd data
SalmonR_MS_Cd_long <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Cd_mcg_per_l, f_Cd_mcg_per_l_qa, p_Cd_mcg_per_l, p_Cd_mcg_per_l_qa) %>%
  pivot_longer(
    cols = c(f_Cd_mcg_per_l, p_Cd_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Cd_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.01), 
                                  Metal_conc))

MS_f_Cd_long <- SalmonR_MS_Cd_long %>% filter(Metal_type == "f")
MS_p_Cd_long <- SalmonR_MS_Cd_long %>% filter(Metal_type == "p")

# Unimpaired trib Cd data
SalmonR_trib_Cd_long <- Salmon_unimpaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Cd_mcg_per_l, f_Cd_mcg_per_l_qa, p_Cd_mcg_per_l, p_Cd_mcg_per_l_qa) %>%
  pivot_longer(
    cols = c(f_Cd_mcg_per_l, p_Cd_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Cd_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.01), 
                                  Metal_conc))

trib_f_Cd_long <- SalmonR_trib_Cd_long %>% filter(Metal_type == "f")
trib_p_Cd_long <- SalmonR_trib_Cd_long %>% filter(Metal_type == "p")

# Impaired trib Cd data
SalmonR_impaired_Cd_long <- Salmon_impaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Cd_mcg_per_l, f_Cd_mcg_per_l_qa, p_Cd_mcg_per_l, p_Cd_mcg_per_l_qa) %>%
  pivot_longer(
    cols = c(f_Cd_mcg_per_l, p_Cd_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Cd_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.01), 
                                  Metal_conc))

impaired_f_Cd_long <- SalmonR_impaired_Cd_long %>% filter(Metal_type == "f")
impaired_p_Cd_long <- SalmonR_impaired_Cd_long %>% filter(Metal_type == "p")
```

```{r}
# Plot bottom
SalmonR_Cd_bottom <- ggplot() +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0.001, ymax = 0.01),
            fill = "gray80", alpha = 0.4) +
  geom_line(data = MS_f_Cd_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
  geom_point(data = MS_f_Cd_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, color = "black", fill = "#28968b", size = 4, stroke = 1.3) +
  geom_line(data = MS_p_Cd_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
  geom_point(data = MS_p_Cd_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, color = "black", fill = "grey28", size = 4, stroke = 1.3) +
  geom_point(data = trib_f_Cd_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", fill = "#a1e6ce", size = 3.4, stroke = 1.2) +
  geom_point(data = impaired_f_Cd_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, color = "indianred2", size = 4, stroke = 1.2) +
  geom_point(data = trib_p_Cd_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", fill = "grey", size = 3.4, stroke = 1.2) +
  geom_point(data = impaired_p_Cd_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, color = "indianred4", size = 4, stroke = 1.2) +
  coord_cartesian(x = c(0, 22), y = c(0.005, 70)) +
  scale_x_continuous(breaks = DA_breaks, labels = DA_labels) +
  scale_y_log10(breaks = c(0.01, 0.1,1,10), labels = scales::comma) +
  annotation_logticks(sides = "l") +
  labs(x = "Distance Downstream (km)", y = NULL, color = "Legend") +
  theme_minimal() +
  DA_theme +
  theme(axis.title.x = element_blank())

SalmonR_Cd_bottom
```

```{r}
ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SalmonR Cd_with DL box.png", SalmonR_Cd_bottom, width = 4.95, height = 2.5, dpi = 300)
```

##Co
```{r}
# MS Co data
SalmonR_MS_Co_long <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Co_mcg_per_l, f_Co_mcg_per_l_qa, p_Co_mcg_per_l, p_Co_mcg_per_l_qa) %>%
  pivot_longer(
    cols = c(f_Co_mcg_per_l, p_Co_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Co_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.01), 
                                  Metal_conc))

MS_f_Co_long <- SalmonR_MS_Co_long %>% filter(Metal_type == "f")
MS_p_Co_long <- SalmonR_MS_Co_long %>% filter(Metal_type == "p")

# Unimpaired trib Co data
SalmonR_trib_Co_long <- Salmon_unimpaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Co_mcg_per_l, f_Co_mcg_per_l_qa, p_Co_mcg_per_l, p_Co_mcg_per_l_qa) %>%
  pivot_longer(
    cols = c(f_Co_mcg_per_l, p_Co_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Co_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.01), 
                                  Metal_conc))

trib_f_Co_long <- SalmonR_trib_Co_long %>% filter(Metal_type == "f")
trib_p_Co_long <- SalmonR_trib_Co_long %>% filter(Metal_type == "p")

# Impaired trib Co data
SalmonR_impaired_Co_long <- Salmon_impaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Co_mcg_per_l, f_Co_mcg_per_l_qa, p_Co_mcg_per_l, p_Co_mcg_per_l_qa) %>%
  pivot_longer(
    cols = c(f_Co_mcg_per_l, p_Co_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Co_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>%
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*0.01), 
                                  Metal_conc))

impaired_f_Co_long <- SalmonR_impaired_Co_long %>% filter(Metal_type == "f")
impaired_p_Co_long <- SalmonR_impaired_Co_long %>% filter(Metal_type == "p")
```

```{r}
# Plot bottom
SalmonR_Co_bottom <- ggplot() +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0.001, ymax = 0.01),
            fill = "gray80", alpha = 0.4) +
  geom_line(data = MS_f_Co_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
  geom_point(data = MS_f_Co_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, color = "black", fill = "#28968b", size = 4, stroke = 1.3) +
  geom_line(data = MS_p_Co_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), color = "black", size = 1) +
  geom_point(data = MS_p_Co_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 21, color = "black", fill = "grey28", size = 4, stroke = 1.3) +
  geom_point(data = trib_f_Co_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", fill = "#a1e6ce", size = 3.4, stroke = 1.2) +
  geom_point(data = impaired_f_Co_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, color = "indianred2", size = 4, stroke = 1.2) +
  geom_point(data = trib_p_Co_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", fill = "grey", size = 3.4, stroke = 1.2) +
  geom_point(data = impaired_p_Co_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, color = "indianred4", size = 4, stroke = 1.2) +
  coord_cartesian(x = c(0, 22), y = c(0.005, 600)) +
  scale_x_continuous(breaks = DA_breaks, labels = DA_labels) +
  scale_y_log10(breaks = c(0.01,0.1,1,10,100), labels = scales::comma) +
  annotation_logticks(sides = "l") +
  labs(x = "Distance Downstream (km)", y = NULL, color = "Legend") +
  theme_minimal() +
  DA_theme +
  theme(axis.title.x = element_blank())

SalmonR_Co_bottom

```

```{r}
ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SalmonR Co_with DL box.png", SalmonR_Co_bottom, width = 5.1, height = 2.5, dpi = 300)
```

# Downstream Analysis by Downstream Distance
## pH plot
```{r}
# Split data for top and bottom panels
top_data_Trib <- SalmonR_filtered_Trib %>% filter(pH >= 7.8)
bottom_data_Trib <- SalmonR_filtered_Trib %>% filter(pH < 4.9)

Salmon_impaired_tribs <- SalmonR_filtered_Trib %>% filter(pH < 7.8 & pH > 5)
```

#### for legend
```{r}
SalmonR_Downstream_analysis_of_pH_top <- 
  ggplot() +
  
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SalmonR_filtered_MS, 
            aes(x = Distance_km, y = pH, 
                #color = "black"
                ), color = "black", size = 1) +  # Move color inside aes()
  
  # Points for Main Stem
  geom_point(data = SalmonR_filtered_MS, 
             aes(x = Distance_km, y = pH, 
                 color = "Mainstem", 
                 fill = "Mainstem"
                 ), 
             pch = 21, size = 5, 
             stroke = 1.2
             ) +
  
  # Points for Tributary
  geom_point(data = top_data_Trib, 
             aes(x = Distance_km, y = pH, 
                 color = "Unimpaired Tributary"
                 , fill = "Tributary"
                 ), 
             pch = 24, size = 4.5, 
             stroke = 1.2
             ) +
  
  geom_point(data = Salmon_impaired_tribs,
             aes(x = Distance_km, y = pH,
             color = "Impaired Tributary"),
             pch = 8, size = 4.5, stroke = 1.2) +
  
  geom_point(data = Zn_SalmonR_filtered_MS, aes(x = Distance_km, y = p_Zn_mcg_per_l, color = "particulate", fill = "particulate_MS"), pch = 21, 
           size = 5, stroke = 1.2) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = p_Zn_bottom_data_Trib, aes(x = Distance_km, y = p_Zn_mcg_per_l, color = "particulate", fill = "particulate_Trib"), pch = 25, 
             size = 4, stroke = 1.2) +
    geom_point(data = p_Zn_impaired_trib_1, aes(x = Distance_km, y = p_Zn_mcg_per_l, color = "particulate", fill = "particulate_Imp"), pch = 8, 
             size = 4, stroke = 1.2) +

  # Set axis limits
  coord_cartesian(xlim = c(0, 270), ylim = c(min(SalmonR_filtered_MS$pH) - 0.1, max(SalmonR_filtered_Trib$pH) + 0.1)) +

  # Labels
  labs(
    title = "Salmon River Downstream",
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend",
    fill = "Legend"
  ) +
  
  # Set custom colors for legend
  scale_color_manual(values = c("Mainstem" = "black", "Unimpaired Tributary" = "black", "Impaired Tributary" = "indianred2", "particulate" = "black"),
                     guide = guide_legend(byrow = TRUE)) +  # Set outline colors
  scale_fill_manual(values = c("Mainstem" = "#2DAA9E", "Tributary" = "#B2DF8A", "particulate_MS" = "black", "particulate_Trib" = "black", "particulate_Imp" = "black")) +  # Set fill colors
  
  # Apply theme
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "right",
    legend.text = element_text(size = 20, face = "bold"),
    legend.title = element_blank(),
    legend.key.height = unit(1, "cm"),
    legend.justification = 0.5
  )

SalmonR_Downstream_analysis_of_pH_top
```

```{r}
#extract legend from the plot above and save separately
#build a function to extract legend
g_legend <- function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

#extracting plot legend
SalmonR_downstream_pH_legend <- g_legend(SalmonR_Downstream_analysis_of_pH_top)

ggsave('C:/Users/tayta/Downloads/SalmonR downstream legend.png', SalmonR_downstream_pH_legend, width = 5, height = 8, dpi = 300)

"#A6CEE3" "#1F78B4" "#B2DF8A" "#33A02C" "#FB9A99" "#E31A1C" "#CAB2D6" "#6A3D9A" "#FFFF99" "#B15928" "#B3B3B3" "#666666"
```

## For figure
Basic plot to test everything - distance
```{r}
SalmonR_pH <- ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SalmonR_filtered_MS, aes(x = Distance_km, y = pH), color = "black", size = 1) +
geom_point(data = SalmonR_filtered_MS, aes(x = Distance_km, y = pH), pch = 21, color = "black", 
           #fill = "#2DAA9E",
           fill = "#28968b",
           size = 5, stroke = 1.2) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = SalmonR_filtered_Trib, aes(x = Distance_km, y = pH), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.5, stroke = 1.2) +
  # Points for impaired tribs
  #geom_point(data = SalmonR_filtered_Trib, aes(x = Distance_km, y = pH), pch = 8, color = "indianred2", 
             #fill = "#B2DF8A", 
             #size = 4, stroke = 1.2) +
  coord_cartesian(x = c(0, 105), y = c(4, 8.7)) +
  scale_x_continuous(breaks = c(0,25,50,75,100)) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
   #scale_x_continuous(breaks = c(0,25,50,75,100,115)) +
  #scale_y_break(c(4.7, 7.25), scales = 7) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    #axis.ticks.x = element_blank(),
    #axis.text.x = element_blank(),
    panel.background = element_rect(fill = "transparent", color = NA), # Panel background
    plot.background = element_rect(fill = "transparent", color = NA) # Plot background
  )

SalmonR_pH
```

Basic plot to test everything - relative watershed area
```{r}
SalmonR_pH <- ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = pH), color = "black", size = 1) +
geom_point(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = pH), pch = 21, color = "black", 
           #fill = "#2DAA9E",
           fill = "#28968b",
           size = 5, stroke = 1.2) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = SalmonR_filtered_Trib, aes(x = Rel_Water_Area_plotting, y = pH), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.5, stroke = 1.2) +
  # Points for impaired tribs
  #geom_point(data = SalmonR_filtered_Trib, aes(x = Distance_km, y = pH), pch = 8, color = "indianred2", 
             #fill = "#B2DF8A", 
             #size = 4, stroke = 1.2) +
  #coord_cartesian(x = c(0, 105), y = c(4, 8.7)) +
  #scale_x_continuous(breaks = c(0,25,50,75,100)) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    #axis.ticks.x = element_blank(),
    #axis.text.x = element_blank(),
    panel.background = element_rect(fill = "transparent", color = NA), # Panel background
    plot.background = element_rect(fill = "transparent", color = NA) # Plot background
  )

SalmonR_pH
```

### Top plot
```{r}
SalmonR_Downstream_analysis_of_pH_top <- 
  ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SalmonR_filtered_MS, aes(x = Distance_km, y = pH), color = "black", size = 1) +
geom_point(data = SalmonR_filtered_MS, aes(x = Distance_km, y = pH), pch = 21, color = "black", 
           fill = "#2DAA9E", 
           size = 5, stroke = 1.2) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = top_data_Trib, aes(x = Distance_km, y = pH), pch = 24, color = "black", 
             fill = "#B2DF8A", 
             size = 4, stroke = 1.2) +
  geom_point(data = Salmon_impaired_tribs, aes(x = Distance_km, y = pH), pch = 8, color = "indianred2", 
             #fill = "#B2DF8A", 
             size = 4, stroke = 1.2) +
  coord_cartesian(x = c(0, 115), y = c(6.5, 8.7)) +
  scale_x_continuous(breaks = c(0,25,50,75,100,115)) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  #scale_y_break(c(4.7, 7.25), scales = 7) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    #legend.position = "none",
    panel.background = element_rect(fill = "transparent"), # Panel background
    plot.background = element_rect(fill = "transparent", color = NA) # Plot background
    )

SalmonR_Downstream_analysis_of_pH_top
```

### Bottom Plot
```{r}
SalmonR_Downstream_analysis_of_pH_bottom <- 
  ggplot() +
  geom_point(data = bottom_data_Trib, aes(x = Distance_km, y = pH), pch = 8, color = "indianred2", 
             #fill = "#B2DF8A", 
             size = 4, stroke = 1.2) +
  coord_cartesian(x = c(0, 115), y = c(4.6, 4.7)) +
  scale_y_continuous(
    breaks = c(4.6,4.7)  # Positions of ticks
    #labels = c()  # Custom labels
  ) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
   scale_x_continuous(breaks = c(0,25,50,75,100,115)) +
  #scale_y_break(c(4.7, 7.25), scales = 7) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    #axis.ticks.x = element_blank(),
    #axis.text.x = element_blank(),
    panel.background = element_rect(fill = "transparent", color = NA), # Panel background
    plot.background = element_rect(fill = "transparent", color = NA) # Plot background
  )

SalmonR_Downstream_analysis_of_pH_bottom


#plot_grid(SalmonR_Downstream_analysis_of_pH_top, SalmonR_Downstream_analysis_of_pH_bottom, ncol = 1, align = "v", rel_heights = c(2, 1), vjust = 1)  # Adjust height ratio if needed

```

### Combined
``` {r}
library(patchwork)

#SalmonR_downstream_pH <- SalmonR_Downstream_analysis_of_pH_top / SalmonR_Downstream_analysis_of_pH_bottom + plot_layout(heights = c(4, 1), guides = "collect") & theme(plot.margin = margin(0, 5, 0, 2))

#SalmonR_downstream_pH

SalmonR_downstream_pH_combo <- SalmonR_Downstream_analysis_of_pH_top / SalmonR_Downstream_analysis_of_pH_bottom + plot_layout(heights = c(4, 1), guides = "collect") & theme(plot.margin = margin(0, 5, 0, 2), panel.background = element_rect(fill = "NA", color = "NA"), # Panel background
    plot.background = element_rect(fill = "NA", color = "NA") # Plot background
    )

SalmonR_downstream_pH_combo

ggsave("C:/Users/tayta/Downloads/Salmon River Downstream pH.png", plot = SalmonR_downstream_pH_combo, width = 9, height = 4, bg = "transparent", dpi = 760)

```

## Sulfate Plot

``` {r}
# Split data for top and bottom panels
#SO4_top_data_Trib <- SalmonR_filtered_Trib %>% filter(f_SO4_mg_per_l >= 7.8)
SO4_bottom_data <- SalmonR_filtered_Trib %>% filter(f_SO4_mg_per_l < 300)
#SO4_Salmon_impaired_1 <- SalmonR_filtered_Trib %>% filter(f_SO4_mg_per_l == 407.18 )
SO4_Salmon_impaired_tribs <- SalmonR_filtered_Trib %>% filter(f_SO4_mg_per_l > 320)


value <- SalmonR_2023_river_data$f_SO4_mg_per_l[SalmonR_2023_river_data$`Field label` == "Anaktok_1"]
print(value)
```

#### Bottom Plot
``` {r}
SalmonR_Downstream_SO4_bottom <- 
  ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SalmonR_filtered_MS, aes(x = Distance_km, y = f_SO4_mg_per_l), color = "black", size = 1) +
  #points for mainstem sites
  geom_point(data = SalmonR_filtered_MS, aes(x = Distance_km, y = f_SO4_mg_per_l), pch = 21, fill = "#2DAA9E", color = "black", 
             #fill = "#A6CEE3", 
             size = 5, stroke = 1.2) +
  # Points for unimpaired tributaries
  geom_point(data = SO4_bottom_data, aes(x = Distance_km, y = f_SO4_mg_per_l), pch = 24, fill = "#B2DF8A", color = "black", 
             #fill = "#B2DF8A", 
             size = 4, stroke = 1.2) +
  # points for impiared trib 1
  geom_point(data = SO4_Salmon_impaired_tribs, aes(x = Distance_km, y = f_SO4_mg_per_l), pch = 8, color = "indianred2", 
             #fill = "#B2DF8A", 
             size = 4, stroke = 1.2) +
  #scale_y_log10() +
  coord_cartesian(x = c(0, 115), y = c(0, 450)) +
  #scale_y_continuous(breaks = c(0,25,100,200,300,400,500,900)) +
  scale_x_continuous(breaks = c(0,25,50,75,100,115)) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = ylab_Sulfate,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    panel.background = element_rect(fill = "NA", color = "NA"), # Panel background
    plot.background = element_rect(fill = "NA", color = "NA") # Plot background
  )

SalmonR_Downstream_SO4_bottom

#ggsave("C:/Users/tayta/Downloads/Downstream Salmon Sulfate.png", plot = SalmonR_Downstream_analysis_of_SO4, width = 9, height = 4, bg = "transparent", dpi = 760)

```

### Top Plot
``` {r}
SalmonR_Downstream_SO4_top <- 
  ggplot() +
  geom_point(data = SO4_Salmon_impaired_tribs, aes(x = Distance_km, y = f_SO4_mg_per_l), pch = 8, 
             color = "indianred2",
             #fill = "#B2DF8A", 
             size = 4, stroke = 1.2) +
  coord_cartesian(x = c(0, 115), y = c(850, 900)) +
  scale_x_continuous(breaks = c(0,25,50,75,100,115)) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  #scale_y_break(c(4.7, 7.25), scales = 7) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    #legend.position = "none",
    panel.background = element_rect(fill = "transparent"), # Panel background
    plot.background = element_rect(fill = "transparent", color = NA) # Plot background
    )

SalmonR_Downstream_SO4_top
```

### Combined
``` {r}
SalmonR_downstream_SO4_combo <- SalmonR_Downstream_SO4_top / SalmonR_Downstream_SO4_bottom + plot_layout(
  heights = c(1, 4), 
  guides = "collect") & theme(plot.margin = margin(0, 5, 0, 2), panel.background = element_rect(fill = "NA", color = "NA"), # Panel background
    plot.background = element_rect(fill = "NA", color = "NA") # Plot background
    )

SalmonR_downstream_SO4_combo

ggsave("C:/Users/tayta/Downloads/Salmon River Downstream SO4.png", plot = SalmonR_downstream_SO4_combo, width = 9, height = 4, bg = "transparent", dpi = 760)

```


## Zn

```{r}
f_Zn_SalmonR_filtered_MS <- SalmonR_filtered_MS %>%
  dplyr::select(Field_Label, Distance_km, f_Zn_mcg_per_l, p_Zn_mcg_per_l) %>%
  filter(!is.na(f_Zn_mcg_per_l))

f_Zn_SalmonR_filtered_MS$f_Zn_mcg_per_l <- as.numeric(Zn_SalmonR_filtered_MS$f_Zn_mcg_per_l)

f_Zn_SalmonR_filtered_Trib <- SalmonR_filtered_Trib %>%
  dplyr::select(Field_Label, Distance_km, f_Zn_mcg_per_l, p_Zn_mcg_per_l) %>%
  filter(!is.na(f_Zn_mcg_per_l))

f_Zn_SalmonR_filtered_Trib$f_Zn_mcg_per_l <- as.numeric(Zn_SalmonR_filtered_Trib$f_Zn_mcg_per_l)

p_Zn_SalmonR_filtered_MS <- SalmonR_filtered_MS %>%
  dplyr::select(Field_Label, Distance_km, f_Zn_mcg_per_l, p_Zn_mcg_per_l) %>%
  filter(!is.na(p_Zn_mcg_per_l))

p_Zn_SalmonR_filtered_MS$p_Zn_mcg_per_l <- as.numeric(p_Zn_SalmonR_filtered_MS$p_Zn_mcg_per_l)

p_Zn_SalmonR_filtered_Trib <- SalmonR_filtered_Trib %>%
  dplyr::select(Field_Label, Distance_km, f_Zn_mcg_per_l, p_Zn_mcg_per_l) %>%
  filter(!is.na(p_Zn_mcg_per_l))

p_Zn_SalmonR_filtered_Trib$p_Zn_mcg_per_l <- as.numeric(p_Zn_SalmonR_filtered_Trib$p_Zn_mcg_per_l)

view(p_Zn_SalmonR_filtered_Trib)
```

### Split data for top and bottom panels
```{r}
# Split data for top and bottom panels
f_Zn_top_data_Trib <- f_Zn_SalmonR_filtered_Trib %>% filter(f_Zn_mcg_per_l >= 1000)
f_Zn_bottom_data_Trib <- f_Zn_SalmonR_filtered_Trib %>% filter(f_Zn_mcg_per_l < 60)
f_Zn_impaired_trib_1 <- f_Zn_SalmonR_filtered_Trib %>% filter(f_Zn_mcg_per_l > 75 & f_Zn_mcg_per_l < 85)

p_Zn_top_data_Trib <- p_Zn_SalmonR_filtered_Trib %>% filter(f_Zn_mcg_per_l >= 1000)
p_Zn_bottom_data_Trib <- p_Zn_SalmonR_filtered_Trib %>% filter(f_Zn_mcg_per_l < 60)
p_Zn_impaired_trib_1 <- p_Zn_SalmonR_filtered_Trib %>% filter(f_Zn_mcg_per_l > 75 & f_Zn_mcg_per_l < 85)

```

### Top Plot
``` {r}
SalmonR_Downstream_analysis_of_Zn_top <- 
  ggplot() +
  geom_vline(xintercept = c(17.01, 21.81), size = 0.5, color = "darkred") +
  geom_point(data = f_Zn_top_data_Trib, aes(x = Distance_km, y = f_Zn_mcg_per_l), pch = 8, color = "indianred2", 
             #fill = "#B2DF8A",
             size = 4, stroke = 1.2) +
  coord_cartesian(x = c(0, 115), y = c(1975,1976)) +
  #scale_y_continuous(breaks = c(2215, 2215.5)) +
  scale_x_continuous(breaks = c(0,25,50,75,100,115)) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.background = element_rect(fill = "NA", color = "NA"), # Panel background
    plot.background = element_rect(fill = "NA", color = "NA") # Plot background
  )

SalmonR_Downstream_analysis_of_Zn_top

```

### Bottom Plot
``` {r}
SalmonR_Downstream_analysis_of_Zn_bottom <- 
  ggplot() +
  geom_vline(xintercept = c(17.01, 21.81), size = 0.5, color = "darkred") +
  geom_line(data = Zn_SalmonR_filtered_MS, aes(x = Distance_km, y = f_Zn_mcg_per_l), color = "black", size = 1) +
geom_point(data = Zn_SalmonR_filtered_MS, aes(x = Distance_km, y = f_Zn_mcg_per_l), pch = 21, color = "black", 
           fill = "#2DAA9E", 
           size = 5, stroke = 1.2) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = Zn_bottom_data_Trib, aes(x = Distance_km, y = f_Zn_mcg_per_l), pch = 24, color = "black", 
             fill = "#B2DF8A", 
             size = 4, stroke = 1.2) +
    geom_point(data = Zn_impaired_trib_1, aes(x = Distance_km, y = f_Zn_mcg_per_l), pch = 8, color = "indianred2", 
             #fill = "#B2DF8A", 
             size = 4, stroke = 1.2) +
  #geom_point(data = p_Zn_top_data_Trib, aes(x = Distance_km, y = p_Zn_mcg_per_l), pch = 8, color = "black", fill = "black", size = 4, stroke = 1.2) +
  #geom_line(data = Zn_SalmonR_filtered_MS, aes(x = Distance_km, y = p_Zn_mcg_per_l), color = "darkgrey", size = 1) +
#geom_point(data = Zn_SalmonR_filtered_MS, aes(x = Distance_km, y = p_Zn_mcg_per_l), pch = 21, color = "black", fill = "black", size = 5, stroke = 1.2) +
  # Points for SalmonR_filtered_Trib
  #geom_point(data = p_Zn_bottom_data_Trib, aes(x = Distance_km, y = p_Zn_mcg_per_l), pch = 25, color = "black", fill = "black", size = 4, stroke = 1.2) +
    #geom_point(data = p_Zn_impaired_trib_1, aes(x = Distance_km, y = p_Zn_mcg_per_l), pch = 8, color = "black", size = 4, stroke = 1.2) +
  coord_cartesian(x = c(0, 115), y = c(0,250)) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  scale_x_continuous(breaks = c(0,25,50,75,100,115)) +
  scale_y_continuous(breaks = c(0,25,50,75,100,150,200,250)) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    panel.background = element_rect(fill = "NA", color = "NA"), # Panel background
    plot.background = element_rect(fill = "NA", color = "NA"), # Plot background
    axis.text.y = element_text(size = 24, color = "black", face = "bold", margin = margin(r = 7)),
    axis.text.x = element_text(size = 24, color = "black", face = "bold", margin = margin(t = 7)),
      axis.ticks.y = element_line(size = 0.8, color = "black"),
      plot.title = element_blank(),
      legend.position = "none",
      panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
      axis.ticks.x = element_line(size = 0.8, color = "black"), # Make x-axis ticks visible
      axis.ticks.length = unit(5, "pt")
  )

SalmonR_Downstream_analysis_of_Zn_bottom
```

### Combined Zn with axis break
``` {r}
SalmonR_downstream_Zn <- SalmonR_Downstream_analysis_of_Zn_top / SalmonR_Downstream_analysis_of_Zn_bottom + plot_layout(heights = c(1,5), guides = "collect") & theme(plot.margin = margin(0, 5, 0, 2), panel.background = element_rect(fill = "transparent", color = "NA"), # Panel background
    plot.background = element_rect(fill = "transparent", color = "NA") # Plot background
    )

SalmonR_downstream_Zn

ggsave("C:/Users/tayta/Downloads/Salmon River Downstream diss Zn_dissolved only.png", plot = SalmonR_downstream_Zn, width = 9, height = 4.5, bg = "transparent", dpi = 760)
```

### Export Zn CMC/CCC
``` {r}
Zn_CMC_CCC <- SalmonR_filtered_MS %>%
  dplyr::select(dist_downstream_km, Field_Label, SamplingEventID, Zn_mcg_per_l, water_hardness, Zn_CMC, Zn_CCC)

write_xlsx(Zn_CMC_CCC, "C:/Users/tayta/Downloads/Salmon River Mainstem CCC and CMC.xlsx")
```

## Se

```{r}
Se_SalmonR_filtered_MS <- SalmonR_filtered_MS %>%
  filter(!is.na(f_Se_mcg_per_l))

Se_SalmonR_filtered_MS$f_Se_mcg_per_l <- as.numeric(Se_SalmonR_filtered_MS$f_Se_mcg_per_l)

Se_SalmonR_filtered_Trib <- SalmonR_filtered_Trib %>%
  filter(!is.na(f_Se_mcg_per_l))

Se_SalmonR_filtered_Trib$f_Se_mcg_per_l <- as.numeric(Se_SalmonR_filtered_Trib$f_Se_mcg_per_l)
```

### Split data for top and bottom panels
```{r}
# Split data for top and bottom panels
Se_top_data_Trib <- Se_SalmonR_filtered_Trib %>% filter(f_Se_mcg_per_l >= 10)
Se_bottom_data_Trib <- Se_SalmonR_filtered_Trib %>% filter(f_Se_mcg_per_l < 1.25)
Se_impaired_trib_1 <- Se_SalmonR_filtered_Trib %>% filter(f_Se_mcg_per_l > 1.2 & f_Se_mcg_per_l < 1.3)

```

### Bottom Plot
```{r}
SalmonR_Downstream_analysis_of_Se_bottom <- 
  ggplot() +
  geom_line(data = Se_SalmonR_filtered_MS, aes(x = Distance_km, y = f_Se_mcg_per_l), color = "black", size = 1) +
geom_point(data = Se_SalmonR_filtered_MS, aes(x = Distance_km, y = f_Se_mcg_per_l), pch = 21, color = "black", 
           fill = "#2DAA9E", 
           size = 5, stroke = 1.2) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = Se_bottom_data_Trib, aes(x = Distance_km, y = f_Se_mcg_per_l), pch = 24, color = "black", 
             fill = "#B2DF8A", 
             size = 4, stroke = 1.2) +
    geom_point(data = Se_impaired_trib_1, aes(x = Distance_km, y = f_Se_mcg_per_l), pch = 8, color = "indianred2", 
             #fill = "#B2DF8A", 
             size = 4, stroke = 1.2) +
  coord_cartesian(x = c(0, 115)
                  , y = c(0,10)
                  ) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  scale_x_continuous(breaks = c(0,25,50,75,100,115)) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    panel.background = element_rect(fill = "NA", color = "NA"), # Panel background
    plot.background = element_rect(fill = "NA", color = "NA") # Plot background
  )

SalmonR_Downstream_analysis_of_Se_bottom
```

### Top Plot
``` {r}
SalmonR_Downstream_analysis_of_Se_top <- 
  ggplot() +
  geom_point(data = Se_top_data_Trib, aes(x = dist_downstream_km, y = Se_mcg_per_l), pch = 8, color = "black", 
             #fill = "#B2DF8A",
             size = 4, stroke = 1.2) +
  coord_cartesian(x = c(0, 270), y = c(37, 40)) +
  #scale_y_continuous(breaks = c(2215, 2215.5)) +
  scale_x_continuous(breaks = c(0, 50,100,150,200,250)) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.background = element_rect(fill = "NA", color = "NA"), # Panel background
    plot.background = element_rect(fill = "NA", color = "NA") # Plot background
  )

SalmonR_Downstream_analysis_of_Se_top

```

### Combined Se with axis break
``` {r}
SalmonR_downstream_Se <- SalmonR_Downstream_analysis_of_Se_top / SalmonR_Downstream_analysis_of_Se_bottom + plot_layout(heights = c(1,4), guides = "collect") & theme(plot.margin = margin(0, 5, 0, 2), panel.background = element_rect(fill = "transparent", color = "NA"), # Panel background
    plot.background = element_rect(fill = "transparent", color = "NA") # Plot background
    )

SalmonR_downstream_Se

ggsave("C:/Users/tayta/Downloads/Salmon River Downstream diss Se.png", plot = SalmonR_downstream_Se, width = 9, height = 4, bg = "transparent", dpi = 760)
```

## DIC Plot

``` {r}
SalmonR_Downstream_analysis_of_DIC <- 
  ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SalmonR_filtered_MS, aes(x = dist_downstream_km, y = DIC_mgC_per_l), color = "blue", size = 1) +
  
  # Points for SalmonR_filtered_Trib
  geom_point(data = SalmonR_filtered_Trib, aes(x = dist_downstream_km, y = DIC_mgC_per_l), color = "red", size = 3) +
  
  # Labels and theme
  labs(
    title = "Salmon River Downstream",
    x = "Distance Downstream (km)",
    y = ylab_DIC,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme

SalmonR_Downstream_analysis_of_DIC

```

### Chloride Plot

``` {r}
SalmonR_Downstream_analysis_of_Cl <- 
  ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SalmonR_filtered_MS, aes(x = dist_downstream_km, y = f_Cl_mg_per_l), color = "blue", size = 1) +
  
  # Points for SalmonR_filtered_Trib
  geom_point(data = SalmonR_filtered_Trib, aes(x = dist_downstream_km, y = f_Cl_mg_per_l), color = "red", size = 3) +
  
  # Labels and theme
  labs(
    title = "Salmon River Downstream",
    x = "Distance Downstream (km)",
    y = ylab_Chloride,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme

SalmonR_Downstream_analysis_of_Cl

```


### Sulfate by Year - modification from AGU analysis

```{r}
Agashashok_River_Data_filtered_no_early_2022 <- Agashashok_River_Data_filtered %>%
  filter(!(Year == 2022 & Season == "Early"))

# Calculate means and counts
sulfate_season_stats <- Agashashok_River_Data_filtered_no_early_2022 %>%
  group_by(Year, Season) %>%
  dplyr::summarize(
    mean_value = mean(f_SO4_mg_per_l, na.rm = TRUE),
    count = n(),
    .groups = 'drop'  # Ensures ungrouped data at the end
  )

# Calculate yearly means for each year (across all seasons)
sulfate_yearly_means <- Agashashok_River_Data_filtered %>%
  group_by(Year) %>%
  dplyr::summarize(mean_value = mean(f_SO4_mg_per_l, na.rm = TRUE), .groups = 'drop')


# Add the Temporal_status column
Agashashok_River_Data_filtered_no_early_2022 <- Agashashok_River_Data_filtered_no_early_2022 %>%
  mutate(
    Temporal_status = ifelse(Year %in% c(2015, 2016, 2017, 2018), 'pre',
                      ifelse(Year %in% c(2019, 2022, 2023), 'post', NA))
  )
```

```{r}


Sulfate_temporal_bp <- ggplot(Agashashok_River_Data_filtered, aes(x = as.factor(Year), y = f_SO4_mg_per_l, fill = Season)) +
  geom_boxplot() +
  #scale_y_log10() +
  scale_fill_manual(
    values = c("Early" = "#88CCEE", "Late" = "#0072B2")
  ) +
  # Add means as text
  #geom_text(data = chloride_season_stats, aes(x = as.factor(Year), y = 0.5, 
                                     #label = paste0("mean =", mean_value), group = Season),
           # position = position_dodge(width = 0.75), size = 3) +
  # Add counts as text
  geom_text(data = sulfate_season_stats, aes(x = as.factor(Year), y = -20, 
                                     label = paste0("N=", count), group = Season),
            position = position_dodge(width = 0.75), size = 5, angle = 45) +
  geom_text(data = sulfate_season_stats, aes(x = as.factor(Year), y = -27, 
                                     label = count, group = Season),
            position = position_dodge(width = 0.75), size = 1, color = "white") +
   geom_text(data = sulfate_season_stats, aes(x = as.factor(Year), y = 240, 
                                     label = count, group = Season),
            position = position_dodge(width = 0.75), size = 1, color = "white") +
  geom_vline(xintercept = 4.5, linetype = "dashed", color = "red", size = 1) +
  labs(
    title = "Boxplot of Sulfate Concentration\nby Year and Season",  # Add \n for line break
    x = "Year",
    y = "Sulfate Concentration (mg/L)",
    fill = "Season"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(hjust = 1, size = 24, color = "black", face = "bold", angle = 45),  # Rotate x-axis labels
    plot.title = element_blank(),  # Center and style title
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 25, color = "black", face = "bold"),
    legend.position = "none",
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 17, face = "bold"),
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    panel.background = element_rect(fill = "transparent"), # Panel background
    plot.background = element_rect(fill = "transparent", color = NA) # Plot background
  ) 

Sulfate_temporal_bp

# Save to Box
#ggsave("C:/Users/tayta/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/Agashashok Temporal Analysis/Sulfate_temporal_bp.png", plot = Sulfate_temporal_bp, bg = "transparent", dpi = 300)

#save to downloads
ggsave("C:/Users/tayta/Downloads/Sulfate_temporal_bp.png", plot = Sulfate_temporal_bp, width = 7, height = 4.5, bg = "transparent", dpi = 300)

# Add means as points
#geom_point(data = sulfate_season_stats, aes(x = as.factor(Year), y = mean_value, color = Season), position = position_dodge(width = 0.7), size = 3, shape = 16)
```

```{r}
#extracting plot legend
Sulfate_temporal_bp_legend <- g_legend(Sulfate_temporal_bp)

Sulfate_temporal_bp_legend

ggsave('C:/Users/tayta/Downloads/Aggie Seasons Legend.png', Sulfate_temporal_bp_legend, width = 4, height = 2, bg = "transparent", dpi = 300)
```


# Old - Alkalinity Calculation
## Calculate Alkalinity from DIC
```{r}
# the calculate_Alk_from_DIC function was made in R file called "DIC and Alkalinity Conversions" on Box
SalmonR_2023_alkalinity <- SalmonR_2023_river_data

SalmonR_2023_alkalinity <- calculate_Alk_from_DIC(SalmonR_2023_alkalinity)

SalmonR_2023_alkalinity <- SalmonR_2023_alkalinity %>%
  relocate(Alk_eq_L, Alk_mEq_L, Alk_mgCaCO3_L, .after = pH) 

view(SalmonR_2023_alkalinity)

SalmonR_MS_alkalinity <- SalmonR_2023_alkalinity %>%
  filter(SiteID %in% c("SalmonR_MS2", "SalmonR_MS6")) %>%
  dplyr::select(SiteID, pH, Temp_deg_celsius, DIC_mgC_per_l, Alk_eq_L, Alk_mEq_L, Alk_mgCaCO3_L)
```

## Manual check of calculation
```{r}
# manual check that alkalinity calculation function worked
SalmonR_MS2 <- SalmonR_2023_river_data %>%
  filter(SiteID == "SalmonR_MS2") %>%
  dplyr::select(SiteID, pH, Temp_deg_celsius, DIC_mgC_per_l)

SalmonR_MS2_alkalinity <- SalmonR_2023_alkalinity %>%
  filter(SiteID == "SalmonR_MS2") %>%
  dplyr::select(SiteID, pH, Temp_deg_celsius, DIC_mgC_per_l, Alk_eq_L, Alk_mEq_L, Alk_mgCaCO3_L)
```

```{r}
# site values
pH <- 8.33
Temp_K <- 6.7 + 273.15
Temp_K
DIC_mgC_per_l <- 28.39
  
  # Equilibrium constant temperature corrections
  # General temperature correction equation is in the USGS document with coefficients from Stumm and Morgan (1996)
  # log10(K) = a1 + a2*T + a3/T + a4*log10(T) + a5/(T^2); T = (T in deg C) + 273.15
  
logK1 <-  (-356.3094) + (-0.06091964 * Temp_K) + (21834.37 / Temp_K) + (126.8339 * log10(Temp_K)) + (-1684915 / (Temp_K^2))
K1 <- 10^logK1

K1

logK2 <- (-107.8871) + (-0.03252849 * Temp_K) + (5151.79/ Temp_K) + (38.92561 * log10(Temp_K)) + (-563713.9 / (Temp_K^2))
K2 <- 10^logK2

K2
  
  # Calculate [H+] from pH
  H <- 10^(-pH)
  
H
  
  # Alpha fractions
  alpha_1 <- (K1 * H) / ((H^2) + (K1 * H) + (K1 * K2))
  alpha_2 <- (K1 * K2) / ((H^2) + (K1 * H) + (K1 * K2))
  
alpha_1
alpha_2

  # Convert DIC (mgC/L) to mol/L
  DIC_mol_L <- DIC_mgC_per_l / (12.01*1000) # (12.01 g/mol)
  
  # Calculate alkalinity
  Alk_eq_L <- (alpha_1 + 2 * alpha_2) * DIC_mol_L
  Alk_mEq_L <- Alk_eq_L * 1000
  Alk_mgCaCO3_L <- Alk_mEq_L * (100.087 / 2)  # CaCO3 MW = 100.087 g/mol, valence = 2
  
Alk_eq_L
Alk_mEq_L
Alk_mgCaCO3_L
```
