---
title: "Ferrum_Downstream Analysis"
output: html_document
date: "2025-01-29"
editor_options: 
  chunk_output_type: console
---

# Load Packages

```{r}
library(tidyverse)
library(cowplot)
library(ggplot2)
library(lubridate)
library(emmeans)
library(lme4)
library(ggeasy)
library(lattice)
library(rstatix)
library(ggsignif)
library(outliers)
library(ggpmisc)
library(ggpubr)
library(r2symbols)
library(stargazer)
library(ggbreak)
library(writexl)
library(ggrepel)
library(stringr)
library(ggthemes)
library(reshape)
library(RColorBrewer)
library(readxl)
library(dplyr)
library(gridExtra)
library(scales)
library(dbscan)
library(mclust)
library(devtools)
library(factoextra)
library(corrplot)
library(ggbiplot)
library(ggcorrplot)
library(GGally)
library(Hmisc)
library(ggbiplot)
library(ggfortify)
library(emmeans)
library(lme4)
library(lmerTest)
library(multcomp)
library(readxl)
library(learnr)
library(scatterplot3d)
library(vegan)
library(ggtern)
library(plotrix)
library(colorBlindness)
library(flextable)
library(officer)
library(dunn.test)
library(multcompView)
library(patchwork)
library(ggbreak)
library(ggpattern)
library(imputeTS)
library(zoo)
```

# Function to save legend
```{r}
# Function to extract and save a legend
save_ggplot_legend <- function(plot, filename, width = 3, height = 2, dpi = 300, bg = "transparent") {
  # Extract the legend
  legend <- cowplot::get_legend(plot)
  
  # Convert to ggplot object
  legend_plot <- cowplot::ggdraw(legend)
  
  print(legend_plot)
  
  return(legend_plot) # Optionally return the legend object as well
}
```

# Load Data
```{r}
Alaska_DataRelease_2022_2023_Ferrum_V10 <- read_excel("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Datasheets/Ferrum Manuscript Datasheets/Alaska_DataRelease_2022_2023_Ferrum_V10.xlsx")
```

```{r}
# Select data for Salmon River July 2023 trip
SalmonR_2023_river_data <-  Alaska_DataRelease_2022_2023_Ferrum_V10 %>%
  dplyr::filter(Watershed == "Salmon River" | Field_label == "Anaktok_1") %>%
  dplyr::filter(sample_collection_year == "2023") %>%
  dplyr::filter(sample_collection_month == "July") %>%
  arrange(Distance_km)

view(SalmonR_2023_river_data)

write_xlsx(SalmonR_2023_river_data, "C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Datasheets/Ferrum Manuscript Datasheets/Salmon River July 2023 Data_V2.xlsx")
```

```{r}
# Modified in excel:
#distance downstream values 
#classification value for Anaktok to reflect this sample site as a tributary on the Salmon 
# Updated Site Classification for tributaries

SalmonR_2023_river_data <- read_excel("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Datasheets/Ferrum Manuscript Datasheets/Salmon River July 2023 Data_v2_updated.xlsx")

```

## Filter Data
### Add u_REE
```{r}
SalmonR_2023_river_data <- SalmonR_2023_river_data %>%
  mutate(
    u_REE = ifelse(
      rowSums(is.na(dplyr::select(., 
                           u_Ce_mcg_per_l, 
                           u_Dy_mcg_per_l, 
                           u_La_mcg_per_l, 
                           u_Nd_mcg_per_l, 
                           u_Pr_mcg_per_l, 
                           u_Y_mcg_per_l))) > 0,
      NA,
      rowSums(dplyr::select(., 
                     u_Ce_mcg_per_l, 
                     u_Dy_mcg_per_l, 
                     u_La_mcg_per_l, 
                     u_Nd_mcg_per_l, 
                     u_Pr_mcg_per_l, 
                     u_Y_mcg_per_l), 
              na.rm = TRUE)
    )
  )
```

```{r}
SalmonR_filtered_MS <- SalmonR_2023_river_data %>%
  filter(Hyd_Classification == "Mainstem") %>%
  mutate(New_Grouping = ifelse(is.na(New_Grouping), "normal", New_Grouping)) # fill in the groups that don't have a site_group with normal

SalmonR_filtered_Trib <- SalmonR_2023_river_data %>%
  filter(Hyd_Classification == "Tributary") %>%
  mutate(New_Grouping = ifelse(New_Grouping == "Downstream MS", "Impaired Tributary", New_Grouping)) # this fixes the group that Anaktok_1 is in for the Salmon River

Salmon_impaired_tribs <- SalmonR_2023_river_data %>%
  dplyr::filter(Site_Classification == "Impaired")

Salmon_unimpaired_tribs <- SalmonR_2023_river_data %>%
  dplyr::filter(Site_Classification == "Unimpaired")
```

## Downstream Difference Calculation
```{r}
Salmon_downstream_difference <- SalmonR_filtered_MS %>%
  dplyr::select(SiteID, Distance_km, pH,
                Temp_deg_celsius,
                Diss_oxy_mg_per_l,
                Diss_oxy_percent_sat,
                Spec_Cond_microS_per_cm,
                DIC_mgC_per_l,
                Alk_mgCaCO3_per_l,
                DOC_mgC_per_l,
                f_Cl_mg_per_l,
                f_NO3_mgN_per_l,
                f_SO4_mg_per_l,
                f_Ca_mg_l,
                f_Mg_mg_l,
                f_Na_mg_l,
                f_K_mg_l,
                f_SiO2_mg_per_l,
                f_Pb_mcg_per_l, p_Pb_mcg_per_l,
                f_Ag_mcg_per_l, p_Ag_mcg_per_l,
f_Al_mcg_per_l, p_Al_mcg_per_l,
f_As_mcg_per_l, p_As_mcg_per_l,
f_Ba_mcg_per_l, p_Ba_mcg_per_l,
#f_Be_mcg_per_l, p_Be_mcg_per_l,
f_Cd_mcg_per_l, p_Cd_mcg_per_l,
f_Ce_mcg_per_l, p_Ce_mcg_per_l,
f_Co_mcg_per_l, p_Co_mcg_per_l,
f_Cr_mcg_per_l, p_Cr_mcg_per_l,
f_Cu_mcg_per_l, p_Cu_mcg_per_l,
f_Dy_mcg_per_l, p_Dy_mcg_per_l,
f_Fe_mcg_per_l, p_Fe_mcg_per_l,
f_La_mcg_per_l, p_La_mcg_per_l,
f_Mn_mcg_per_l, p_Mn_mcg_per_l,
f_Nd_mcg_per_l, p_Nd_mcg_per_l,
f_Ni_mcg_per_l, p_Ni_mcg_per_l,
f_Pr_mcg_per_l, p_Pr_mcg_per_l,
f_Se_mcg_per_l, p_Se_mcg_per_l,
#f_Th_mcg_per_l, p_Th_mcg_per_l,
f_Tl_mcg_per_l, p_Tl_mcg_per_l,
f_U_mcg_per_l, p_U_mcg_per_l,
f_V_mcg_per_l, p_V_mcg_per_l,
f_Y_mcg_per_l, p_Y_mcg_per_l,
f_Zn_mcg_per_l, p_Zn_mcg_per_l,
f_REE, p_REE,
u_Pb_mcg_per_l,
u_Ag_mcg_per_l,
u_Al_mcg_per_l,
u_As_mcg_per_l,
u_Ba_mcg_per_l,
# u_Be_mcg_per_l,
u_Cd_mcg_per_l,
u_Ce_mcg_per_l,
u_Co_mcg_per_l,
u_Cr_mcg_per_l,
u_Cu_mcg_per_l,
u_Dy_mcg_per_l,
u_Fe_mcg_per_l,
u_La_mcg_per_l,
u_Mn_mcg_per_l,
u_Nd_mcg_per_l,
u_Ni_mcg_per_l,
u_Pr_mcg_per_l,
u_Se_mcg_per_l,
# u_Th_mcg_per_l,
u_Tl_mcg_per_l,
u_U_mcg_per_l,
u_V_mcg_per_l,
u_Y_mcg_per_l,
u_Zn_mcg_per_l) %>%
  dplyr::select(-contains("qa")) %>%
  filter(Distance_km %in% c(0, 103.23)) %>% # select the most upstream and most downstream mainstem sites
  dplyr::select(-c(Distance_km)) %>% # remove distance column
    pivot_longer(
    cols = -c(SiteID),
    names_to = "variable",
    values_to = "value"
  ) %>%
  pivot_wider(
    names_from = SiteID,
    values_from = value
  ) %>%
  filter(!is.na(SalmonR_MS2)) %>% # filter out na values for the SalmonR_MS2 site (upstream site) 
  mutate(SalmonR_MS2 = if_else(SalmonR_MS2 == 0, 0.000001, SalmonR_MS2)) %>% # substitute 0 values for 0.000001 so that a calculation can be done
  # difference calculations comparing most upstream (MS2) to most downtream (MS6)
  mutate(downstream_diff_conc = SalmonR_MS6 - SalmonR_MS2) %>%
  mutate(downstream_diff_fold_greater = (SalmonR_MS6/SalmonR_MS2)) %>%
  mutate(downstream_diff_percent_change = (downstream_diff_conc/SalmonR_MS2) * 100)

view(Salmon_downstream_difference)

write_xlsx(Salmon_downstream_difference, "C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Results and Discussion/Salmon River Downstream Analysis/Salmon River Downstream Differences.xlsx")
```


## Plot theme

```{r}
DA_theme <- 
  theme(
    axis.text.y = element_text(size = 16, color = "black", face = "bold"),
    axis.text.x = element_text(size = 16, color = "black", face = "bold", 
                               #angle = 45, 
                               hjust = 0.5),
    axis.ticks.y = element_line(linewidth = 0.9, color = "black"),  # Thicker y-axis ticks
    axis.ticks.length.y = unit(0.1, "cm"),  # Longer tick marks
    
    axis.ticks.x = element_line(linewidth = 0.9, color = "black"),  # Thicker y-axis ticks
    axis.ticks.length.x = unit(0.15, "cm"),  # Longer tick marks
    
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "black"),
    legend.position = "right",
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 17, face = "bold", hjust = 0.5),
    
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    #panel.background = element_rect(fill = "white"),
    panel.border = element_rect(fill = NA, color = "black", size = 1.25),
    panel.background = element_rect(fill = "transparent"), # Panel background
    plot.background = element_rect(fill = "transparent", color = NA) # Plot background

  )
```

## Labels

```{r}
ylab_DOC <- expression(bold(DOC)~(mg~L^-1))
ylab_DIC <- expression(bold(DIC)~(mgC~L^-1))

ylab_Ca <- expression(bold(Ca)~bold((mg~L^-1)))
ylab_Mg <- expression(bold(Mg)~bold((mg~L^-1)))
ylab_Chloride <- expression(bold(Chloride)~bold((mg~L^-1)))
ylab_Sulfate <- expression(bold(SO[4]^-2)~bold((mg~L^-1)))
ylab_SpC <- expression(bold(Specific~Conductivity)~bold((μS~cm^-1)))
ylab_Alk <- expression(bold(Alkalinity~bold((mgCaCO[3]~L^-1))))

ylab_Zn <- expression(bold(Zn)~bold((μg~L^-1)))
ylab_Cu <- expression(bold(Cu)~bold((μg~L^-1)))
ylab_Fe <- expression(bold(Fe)~bold((μg~L^-1)))
ylab_Ni <- expression(bold(Ni)~bold((μg~L^-1)))
ylab_Mn <- expression(bold(Mn)~bold((μg~L^-1)))
ylab_Cd <- expression(bold(Cd)~bold((μg~L^-1)))
ylab_Al <- expression(bold(Al)~bold((μg~L^-1)))
ylab_Co <- expression(bold(Co)~bold((μg~L^-1)))
ylab_Se <- expression(bold(Se)~bold((μg~L^-1)))
ylab_REE <- expression(bold(Sigma~REE)~bold((μg~L^-1)))
ylab_Tl <- expression(bold(Tl)~bold((μg~L^-1)))
ylab_Pb <- expression(bold(Pb)~bold((μg~L^-1)))
ylab_As <- expression(bold(As)~bold((μg~L^-1)))


ylab_Salinity <- expression(bold(Salinity)~(ppt))
ylab_FMeHg <- expression(bold(FMeHg)~(ng~L^-1))
ylab_FTHg <- expression(bold(FTHg)~(ng~L^-1))
ylab_PMeHg <- expression(bold(PMeHg)~(ng~L^-1))
ylab_PTHg <- expression(bold(PTHg)~(ng~L^-1))
ylab_SPM <- expression(bold(SPM)~(ng~L^-1))
#ylab_Mn <- expression(bold(Manganese)~(μg~L^-1))
ylab_SUVA <- expression(bold(SUVA[254~nm])~(L/mg~m)) 
ylab_Sulfide <- expression(bold(Sulfide)~(mg~L^-1))
```

## Colors
```{r}
watershed_colors <- c(  
    "Agashashok River" = "#A1E3F9",   
    "Anaktok River" = "#9F8383",
    "Salmon River Watershed" = "#9F8383",
    "Salmon River" = "#2DAA9E",   
    "Kugururok River" = "#2D3D85",  
    "Nakolikurok Creek" = "#F87FC7",
    "Nakolikurok" = "#F87FC7",
    "Tukpahlearik Creek" = "#FDDE74",
    "Tukpahlearik" = "#FDDE74"
    )

boxplot_colors <- c(
  "Agashashok River" = "#A1E3F9",   
    "Anaktok River" = "#9F8383",
    "Salmon River Watershed" = "#9F8383",
    "Salmon River" = "#2DAA9E",   
    "Kugururok River" = "#2D3D85",  
    "Nakolikurok Creek" = "#F87FC7",
    "Nakolikurok" = "#F87FC7",
    "Tukpahlearik Creek" = "#FDDE74",
    "Tukpahlearik" = "#FDDE74",
  #"Upstream" = "#72D9FF",
  #"Seep" = "darkred",
  #"Impaired Tributary" = "indianred2",
  #"Downstream MS 1" = "sienna1",
  #"Downstream MS 2" = "orange2",
  #"Downstream MS" = "orange2",
  #"Unimpaired Tributary" = "darkblue",
   "Unimpaired Tributary" = "#00589b",
  "Upstream" = "#72D9FF",
  "Seep" = "#c81600",
  "Impaired Tributary" = "indianred2",
  "Downstream MS" = "#f5a678",
  #"1" = "#72D9FF",
  #"2" = "darkred",
  #"3" = "indianred2",
  #"5" = "sienna1",
  #"6" = "orange2",
  #"4" = "darkblue"
  #"4" = "#003b68",
  "4" = "#00589b",
  "1" = "#72D9FF",
  "2" = "#c81600",
  "3" = "indianred2",
  #"6" = "sienna1"
  #"6" = "#ffb367",
  #"6" = "#f4a460",
  "6" = "#f5a678",
  "normal" = "#28968b"
)

```


# Downstream Analysis by Relative Watershed Area
## pH
```{r}
DA_x_breaks <- c(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22)
DA_x_labels <- c("", 1,"","","",5,"","","","",10,"","","","",15,"","","","",20,"","")
DA_x_labels

pH_y_breaks <- seq(4.4,8.6, by = 0.2)
pH_y_labels <- c(4.4, "4.6", "", "5.0", 5.2, "", 5.6, "", 6.0, "", 6.4, "", 6.8 , "", 7.2, "", 7.6, "", "8.0", "", 8.4, "")
```

### Area plot
```{r}
SalmonR_pH_area <- ggplot() +
  # area plots
  geom_area(data = SalmonR_filtered_MS, 
            aes(x = Rel_Water_Area_plotting, y = pH),
            #fill = "#28968b"
            fill = "#2daa9e",
            #alpha = 0.85
            ) +
  
  geom_line(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = pH), color = "#1d6e66", linewidth = 0.4) +
  geom_point(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = pH, 
      #fill = New_Grouping
      ), pch = 19, color = "black", 
           size = 2) +
  
  # lines for locations of sampled tributaries
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11), linetype = "dashed", color = "grey15", linewidth = 0.5) +
  
  coord_cartesian(x = c(1,22.5), y = c(7.3,8.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.035, 0.015))) +
  #scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.03, 0))) +
  scale_y_continuous(breaks = pH_y_breaks, labels = pH_y_labels, sec.axis = dup_axis(name = NULL, labels = NULL)) +
  labs(
    x = NULL,
    y = NULL,
    title = NULL
    #x = "Relative Water Area",
    #y = "pH"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    #axis.text.y = element_blank(),
    axis.ticks.length.y.right = unit(-0.1, "cm")  # negative to extend into plot
  )

SalmonR_pH_area

#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Zn area.png", SalmonR_pH_area, width = 4.8, height = 1.92, dpi = 300)
```

### Modifications for heat plots
Data frames
```{r}
SalmonR_pH <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification,Rel_Water_Area_plotting, pH) %>%
  filter(!is.na(Rel_Water_Area_plotting)) %>%
  mutate(
    H = 10^(-pH)
  )
  

#view(SalmonR_pH)
```

Tributary data frame
```{r}
SalmonR_trib_pH_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, pH) %>%
  mutate(
    H = 10^(-pH)
  )

#view(SalmonR_trib_pH_area)
```

Modifications for heat plots
```{r}
# Calculate tributary metal concentrations relative to the nearest upstream MS sample concentration for heat plot

# Step 1: A reference map for each row that needs normalization
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745",
    "SalmonR_Trib2_20230722_1911",
    "SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945",
    "SalmonR_Trib3_20230724_1140",
    "SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311",
    "SalmonR_Trib6_20230724_1428",
    "SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753",
    "SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

# Step 2: Join main data to get both the value row and its reference row
pH_rel_data <- SalmonR_pH %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(SalmonR_pH %>%
              dplyr::select(RefID = SamplingEventID, 
                            ref_H = H),
            by = "RefID") %>%
  # calculate the concentration relative to the nearest mainstem site (ref)
  mutate(
    rel_H = H / ref_H
  ) 

view(pH_rel_data)

```

```{r}
# Join the relative concentrations to the main data
pH_rel_data_to_join <- pH_rel_data %>%
  dplyr::select(SamplingEventID, rel_H)

SalmonR_pH_with_rel <- SalmonR_pH %>%
  left_join(pH_rel_data_to_join, by = "SamplingEventID")

#view(SalmonR_pH_with_rel)

```

```{r}
# Extend the data to have a fake continuous x axis with fake data

# Create full sequence from 0 to 22.5 by 0.05
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

# Join original df with the full sequence
df_expanded <- full_sequence %>%
  left_join(pH_rel_data, by = "Rel_Water_Area_plotting")

pH_rel_data_to_plot <- df_expanded %>%
  dplyr::select(-c(pH, H, ref_H)) %>% # keep only the concentrataion relative to the mainstem (rel_)
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

pH_Anaktok_salmon <- pH_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>% # select anaktok site
  dplyr::select(-c(pH, H, ref_H)) %>% # keep only the concentration relative to the mainstem (rel_)
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

# Replace the existing row with the one from Anaktok_salmon
pH_rel_data_to_plot <- pH_rel_data_to_plot %>%
  rows_update(pH_Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(pH_rel_data_to_plot)

```

Manually add data values to relative data to control more of how the NA values are interpolated
```{r}
## Use this if values need to be set manually prior to filling the missing values

# pH_mod_data <- data.frame(
#   Rel_Water_Area_plotting = c(4.35, 4.7, 5.6, 6.2, 6.3, 7.95, 8.05, 8.95, 10.75, 10.95, 14),
#   rel_H = c(0.1, 0.1, 0.1, 0.01, 0.01, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1)
# ) %>%
#   mutate(across(everything(), as.numeric))

pH_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(4.35, 4.7, 5.6, 6.2, 6.3, 7.2, 7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12),
  rel_H = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
) %>%
  mutate(across(everything(), as.numeric))

pH_rel_data_mod <- pH_rel_data_to_plot %>%
  rows_update(pH_mod_data, by = "Rel_Water_Area_plotting")

#view(pH_rel_data_mod)
```

Optional - change the highest value
```{r}
## use this if any values need to be manually changed for the way the plot looks

# Manually change the highest value
pH_rel_data_mod2 <- pH_rel_data_mod %>%
  mutate(rel_H = case_when(
    Rel_Water_Area_plotting == 4.75 ~ 10,
    TRUE ~ rel_H  # keep original value if no match
  ))
```

Linear interpolation using na.approx
```{r}
# Apply linear interpolation to all numeric columns except Rel_Water_Area_plotting
pH_rel_data_to_plot_interp <- pH_rel_data_mod2 %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

# Make the values before the first tributary 0 (adjust column indices if needed)
pH_rel_data_to_plot_interp[1:75, 6] <- 0

view(pH_rel_data_to_plot_interp)

pH_filtered_rel_data_to_plot_interp <- pH_rel_data_to_plot_interp %>%
  filter (rel_H >= 1.01)

```

### Trib heat plots
```{r}
# Heat plot for pH of tributaries
pH_heat <- ggplot(pH_filtered_rel_data_to_plot_interp, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_H)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  #scale_fill_gradientn(
    #colours = c("blue", "red"),
    #values = scales::rescale(c(0, 1, 20)),  # Normalize to [0,1] scale
    #limits = c(0, 20)
  #) + 
  labs(
    title = NULL,
    x = NULL,
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    #legend.position = "none",
    legend.position = "top",
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.title = element_blank(),
    axis.ticks.length.x = unit(0.1, "cm")  # make tick marks shorter
  )

pH_heat
```

```{r}
pH_heat_legend <- ggpubr::get_legend(pH_heat)

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/pH heat legend.png",cowplot::ggdraw(pH_heat_legend), width = 4, height = 2, dpi = 300)
```

### Final pH composite plot
```{r}
SalmonR_pH_area_combo <- (
  pH_heat / SalmonR_pH_area +
  plot_layout(ncol = 1, nrow = 2, heights = c(1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    legend.position = "none",
    legend.text = element_text(size = 8),       # smaller legend labels
    legend.title = element_text(size = 9),      # smaller legend title
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
  legend.spacing = unit(0.1, "cm"), # smaller boxes
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA)
  )

SalmonR_pH_area_combo

# Save final plot
ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/pH area plus heat plot_with labels.png", SalmonR_pH_area_combo, width = 3.6, height = 1.8, dpi = 300)
```

### geom point
```{r}
SalmonR_pH_top <- ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = pH), color = "black", size = 1.1) +
geom_point(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = pH, 
      #fill = New_Grouping
      ), pch = 21, color = "black", 
           fill = "#28968b",
           #fill = "#2DAA9E",
           size = 4, stroke = 1.3) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = Salmon_unimpaired_tribs, aes(x = Rel_Water_Area_plotting, y = pH, 
      #fill = New_Grouping
      ), pch = 24, color = "black", 
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             #fill = "#c0eeea",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = Salmon_impaired_tribs, aes(x = Rel_Water_Area_plotting, y = pH, 
       #fill = New_Grouping
       ), pch = 25, color = "black", 
             fill = "indianred2", 
             size = 3.3, stroke = 1.2) +
  #scale_fill_manual(values = boxplot_colors) +
  coord_cartesian(x = c(0, 22), y = c(7.2, 8.6)) +
  scale_x_continuous( 
    breaks = DA_breaks,
    labels = DA_labels) +
  scale_y_continuous(
    breaks = pH_y_breaks,
    labels = pH_y_labels
  ) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    #legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

SalmonR_pH_top


#SalmonR_pH_top_boxplot_colors
```

```{r}
SalmonR_pH_bottom <- ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = pH), color = "black", size = 1) +
geom_point(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = pH), pch = 21, color = "black", 
           #fill = "#2DAA9E",
           fill = "#28968b",
           size = 5, stroke = 1.3) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = Salmon_unimpaired_tribs, aes(x = Rel_Water_Area_plotting, y = pH), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = Salmon_impaired_tribs, aes(x = Rel_Water_Area_plotting, y = pH), pch = 25, color = "black", 
             fill = "indianred2", 
             size = 3.3, stroke = 1.2) +
  coord_cartesian(x = c(0, 22), y = c(4.5, 5)) +
  scale_x_continuous( 
    breaks = DA_breaks,
    labels = DA_labels) +
  scale_y_continuous(
    breaks = pH_y_breaks,
    labels = pH_y_labels
  ) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank()
  )

SalmonR_pH_bottom
```

```{r}
SalmonR_pH_combo <- SalmonR_pH_top / SalmonR_pH_bottom + plot_layout(heights = c(4, 1), guides = "collect") & theme(plot.margin = margin(0, 5, 0, 2), panel.background = element_rect(fill = "NA", color = "NA"), # Panel background
    plot.background = element_rect(fill = "NA", color = "NA") # Plot background
    )

SalmonR_pH_combo

ggsave("C:/Users/tevinger/Downloads/SalmonR pH.png", SalmonR_pH_combo, width = 5, height = 2.5, dpi = 300)

```

## DIC
```{r}
DA_x_breaks <- seq(0,25, by = 2.5)
DA_x_labels <- c(0,"",5,"",10,"",15,"",20,"",25)
DA_labels

DIC_breaks <- seq(0,55, by = 5)
DIC_labels <- c(0,"",10,"",20,"",30,"",40,"",50,"")
```

```{r}
SalmonR_DIC_top <- ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = DIC_mgC_per_l), color = "black", size = 1) +
geom_point(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = DIC_mgC_per_l), pch = 21, color = "black", 
           #fill = "#2DAA9E",
           fill = "#28968b",
           size = 4, stroke = 1.3) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = Salmon_unimpaired_tribs, aes(x = Rel_Water_Area_plotting, y = DIC_mgC_per_l), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = Salmon_impaired_tribs, aes(x = Rel_Water_Area_plotting, y = DIC_mgC_per_l), pch = 25, color = "black", 
             fill = "indianred2", 
             size = 3.3, stroke = 1.2) +
  #coord_cartesian(x = c(0, 22), y = c(0, 45)) +
  scale_x_continuous( 
    breaks = DA_breaks,
    labels = DA_labels) +
  scale_y_continuous(
    breaks = DIC_breaks,
    labels = DIC_labels
  ) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    plot.margin = margin(0, 5, 0, 2)
  )

SalmonR_DIC_top

ggsave("C:/Users/tevinger/Downloads/SalmonR DIC.png", SalmonR_DIC_top, width = 5, height = 2.5, dpi = 300)
```

## SpC
```{r}
Cl_MS <- SalmonR_filtered_MS %>%
  filter(!is.na(f_Cl_mg_per_l))

Cl_breaks <- seq(0,900, by = 50)
Cl_labels <- c(0,"",100, "", 200, "", 300, "", 400, "", 500, "", 600, "", 700, "", 800, "850", 900)
```

### Area Plot
```{r}
SalmonR_SpC_area <- ggplot() +
  geom_area(data = SalmonR_filtered_MS, 
            aes(x = Rel_Water_Area_plotting, y = Spec_Cond_microS_per_cm),
            fill = "#2daa9e") +
  geom_line(data = SalmonR_filtered_MS, 
            aes(x = Rel_Water_Area_plotting, y = Spec_Cond_microS_per_cm), 
            color = "#1d6e66", linewidth = 0.4) +
  geom_point(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = Spec_Cond_microS_per_cm, 
      #fill = New_Grouping
      ), pch = 19, color = "black", 
           size = 2) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11), 
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
  coord_cartesian(x = c(1,22.5), y = c(0, 750)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, 
                     expand = expansion(mult = c(0.03, 0))) +
  #scale_y_continuous(breaks = Cl_breaks, labels = Cl_labels, sec.axis = dup_axis(name = NULL, labels = NULL)) +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.ticks.length.y.right = unit(-0.1, "cm")  # negative to extend into plot
  )

SalmonR_SpC_area
```

## Cl
```{r}
Cl_MS <- SalmonR_filtered_MS %>%
  filter(!is.na(f_Cl_mg_per_l))

Cl_breaks <- seq(0,900, by = 50)
Cl_labels <- c(0,"",100, "", 200, "", 300, "", 400, "", 500, "", 600, "", 700, "", 800, "850", 900)
```

### Area Plot
```{r}
SalmonR_Cl_area <- ggplot() +
  geom_area(data = SalmonR_filtered_MS, 
            aes(x = Rel_Water_Area_plotting, y = f_Cl_mg_per_l),
            fill = "#2daa9e") +
  geom_line(data = SalmonR_filtered_MS, 
            aes(x = Rel_Water_Area_plotting, y = f_Cl_mg_per_l), 
            color = "#1d6e66", linewidth = 0.4) +
  geom_point(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = f_Cl_mg_per_l, 
      #fill = New_Grouping
      ), pch = 19, color = "black", 
           size = 2) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11), 
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
  coord_cartesian(x = c(1,22.5), y = c(0, 2.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, 
                     expand = expansion(mult = c(0.03, 0))) +
  #scale_y_continuous(breaks = Cl_breaks, labels = Cl_labels, sec.axis = dup_axis(name = NULL, labels = NULL)) +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.ticks.length.y.right = unit(-0.1, "cm")  # negative to extend into plot
  )

SalmonR_Cl_area
```


## SO4
```{r}
SO4_MS <- SalmonR_filtered_MS %>%
  filter(!is.na(f_SO4_mg_per_l))

SO4_breaks <- seq(0,900, by = 50)
SO4_labels <- c(0,"",100, "", 200, "", 300, "", 400, "", 500, "", 600, "", 700, "", 800, "850", 900)
```

### Area Plot
```{r}
SalmonR_SO4_area <- ggplot() +
  geom_area(data = SalmonR_filtered_MS, 
            aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l),
            fill = "#2daa9e") +
  geom_line(data = SalmonR_filtered_MS, 
            aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), 
            color = "#1d6e66", linewidth = 0.4) +
  geom_point(data = SalmonR_filtered_MS, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l, 
      #fill = New_Grouping
      ), pch = 19, color = "black", 
           size = 2) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11), 
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
  coord_cartesian(x = c(1,22.5), y = c(0, 300)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.035, 0.015))) +
  scale_y_continuous(breaks = SO4_breaks, labels = SO4_labels, sec.axis = dup_axis(name = NULL, labels = NULL)) +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.length.y.right = unit(-0.1, "cm")  # negative to extend into plot
  )

SalmonR_SO4_area
```

```{r}
SalmonR_SO4 <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting, f_SO4_mg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting)) %>%
  mutate(SO4 = f_SO4_mg_per_l)

view(SalmonR_SO4)
```

```{r}
SalmonR_trib_SO4_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_SO4_mg_per_l) %>%
  mutate(SO4 = f_SO4_mg_per_l)

view(SalmonR_trib_SO4_area)
```

```{r}
# ref_map <- tibble(
#   SamplingEventID = c("SalmonR_Trib1_20230722_1745", "SalmonR_Trib2_20230722_1911", "SheepC_1_20230719_0923", 
#                       "Anaktok_1_20230723_1945", "SalmonR_Trib3_20230724_1140", "SalmonR_Trib4_20230724_1155", 
#                       "SalmonR_Trib5_20230724_1311", "SalmonR_Trib6_20230724_1428", "SalmonR_Trib7_20230724_1453"),
#   RefID = c("SalmonR_MS_above_Trib1_20230722_1753", "SalmonR_MS_above_Trib2_20230722_1915", 
#             "SalmonR_MS_at_SheepC_20230719_0927", "SalmonR_MS_at_SheepC_20230719_0927", 
#             "SalmonR_MS_at_SheepC_20230719_0927", "SalmonR_MS_at_SheepC_20230719_0927", 
#             "SalmonR_MS_at_SheepC_20230719_0927", "SalmonR_MS_at_SheepC_20230719_0927", 
#             "SalmonR_MS_at_SheepC_20230719_0927")
# ) # SalmonR_MS_above_Trib6_20230724_1439 was switched for SalmonR_MS_at_SheepC_20230719_0927 because there are no sulfate measurements at the MS above Trib 6 site

ref_map <- tibble(
  SamplingEventID = c(
  "SalmonR_Trib1_20230722_1745",
  "SalmonR_Trib2_20230722_1911",
  "SheepC_1_20230719_0923",
  "Anaktok_1_20230723_1945",
  "SalmonR_Trib3_20230724_1140",
  "SalmonR_Trib4_20230724_1155",
  "SalmonR_Trib5_20230724_1311",
  "SalmonR_Trib6_20230724_1428",
  "SalmonR_Trib7_20230724_1453"
),
  RefID = c(
  "SalmonR_MS_above_Trib1_20230722_1753",
  "SalmonR_MS_above_Trib2_20230722_1915",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_above_Trib6_20230724_1439",
  "SalmonR_MS_above_Trib6_20230724_1439"
)
)

SO4_rel_data <- SalmonR_SO4 %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(SalmonR_SO4 %>%
              dplyr::select(RefID = SamplingEventID, ref_SO4 = SO4),
            by = "RefID") %>%
  mutate(rel_SO4 = SO4 / ref_SO4)

view(SO4_rel_data)

```

```{r}
SO4_rel_data_to_join <- SO4_rel_data %>%
  dplyr::select(SamplingEventID, rel_SO4)

SalmonR_SO4_with_rel <- SalmonR_SO4 %>%
  left_join(SO4_rel_data_to_join, by = "SamplingEventID")

view(SalmonR_SO4_with_rel)
```

```{r}
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

df_expanded <- full_sequence %>%
  left_join(SO4_rel_data, by = "Rel_Water_Area_plotting")

SO4_rel_data_to_plot <- df_expanded %>%
  dplyr::select(-c(f_SO4_mg_per_l, SO4, ref_SO4)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

SO4_Anaktok_salmon <- SO4_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(f_SO4_mg_per_l, SO4, ref_SO4)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

SO4_rel_data_to_plot <- SO4_rel_data_to_plot %>%
  rows_update(SO4_Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(SO4_rel_data_to_plot)

```

```{r}
SO4_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(4.35, 4.7, 5.6, 6.2, 6.3, 7.2, 7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12),
  rel_SO4 = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
) %>%
  mutate(across(everything(), as.numeric))

SO4_rel_data_mod <- SO4_rel_data_to_plot %>%
  rows_update(mod_data, by = "Rel_Water_Area_plotting")

#view(SO4_rel_data_mod)
```

```{r}
SO4_rel_data_mod2 <- SO4_rel_data_mod %>%
  mutate(rel_SO4 = case_when(
    Rel_Water_Area_plotting == 4.75 ~ 20,
    TRUE ~ rel_SO4
  ))
```

```{r}
SO4_rel_data_to_plot_interp <- SO4_rel_data_mod %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

SO4_rel_data_to_plot_interp[1:75, 6] <- 0

SO4_rel_data_to_plot_interp <- SO4_rel_data_to_plot_interp %>% 
  filter(rel_SO4 >= 1.01)

#view(SO4_rel_data_to_plot_interp)
```

### trib heat plot
```{r}
SO4_heat <- ggplot(SO4_rel_data_to_plot_interp, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_SO4)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(
    title = NULL,
    x = NULL,
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    legend.position = "top",
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.title = element_blank(),
    axis.ticks.length.x = unit(0.1, "cm")  # make tick marks shorter
  )

SO4_heat
```

```{r}
SO4_legend <- ggpubr::get_legend(SO4_heat)

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SO4 heat legend.png",cowplot::ggdraw(SO4_legend), width = 4, height = 2, dpi = 300)
```

### Final SO4 composite plot
```{r}
SalmonR_SO4_area_combo <- (
  SO4_heat / SalmonR_SO4_area +
  plot_layout(ncol = 1, nrow = 2, heights = c(1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    legend.position = "none",
    legend.text = element_text(size = 8),       # smaller legend labels
    legend.title = element_text(size = 9),      # smaller legend title
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
  legend.spacing = unit(0.1, "cm"), # smaller boxes
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA)
  )

SalmonR_SO4_area_combo

# Save final plot
ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/M_SO4 area plus heat plot_no labels.png",SalmonR_SO4_area_combo, width = 3.6, height = 1.8, dpi = 300)
```

### geom point
```{r}
SalmonR_SO4_top <- ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SO4_MS, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), color = "black", size = 1) +
geom_point(data = SO4_MS, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), pch = 21, color = "black", 
           #fill = "#2DAA9E",
           fill = "#28968b",
           size = 4, stroke = 1.3) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = Salmon_unimpaired_tribs, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = Salmon_impaired_tribs, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), pch = 25, color = "black", 
             fill = "indianred2", 
             size = 3.3, stroke = 1.2) +
  coord_cartesian(x = c(0, 22), y = c(0, 450)) +
  scale_x_continuous( 
    breaks = DA_breaks,
    labels = DA_labels) +
  scale_y_continuous(
    breaks = SO4_breaks,
    labels = SO4_labels
  ) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.title.x = element_blank(),
    plot.margin = margin(0, 5, 0, 2)
  )

SalmonR_SO4_top

#ggsave("C:/Users/tevinger/Downloads/SalmonR DIC.png", SalmonR_DIC_top, width = 5, height = 2.5, dpi = 300)
```

```{r}
SalmonR_SO4_bottom <- ggplot() +
  # Line plot for SalmonR_filtered_MS
  geom_line(data = SO4_MS, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), color = "black", size = 1) +
geom_point(data = SO4_MS, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), pch = 21, color = "black", 
           #fill = "#2DAA9E",
           fill = "#28968b",
           size = 4, stroke = 1.3) +
  # Points for SalmonR_filtered_Trib
  geom_point(data = Salmon_unimpaired_tribs, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 3.4, stroke = 1.2) +
  # Points for impaired tribs
  geom_point(data = Salmon_impaired_tribs, aes(x = Rel_Water_Area_plotting, y = f_SO4_mg_per_l), pch = 25, color = "black", 
             fill = "indianred2", 
             size = 3.3, stroke = 1.2) +
  coord_cartesian(x = c(0, 22), y = c(850, 900)) +
  scale_x_continuous( 
    breaks = DA_breaks,
    labels = DA_labels) +
  scale_y_continuous(
    breaks = SO4_breaks,
    labels = SO4_labels
  ) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    plot.margin = margin(0, 5, 0, 2),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

SalmonR_SO4_bottom
```

```{r}
SalmonR_SO4_combo <- SalmonR_SO4_bottom / SalmonR_SO4_top + plot_layout(
  heights = c(1, 4), 
  guides = "collect") & theme(plot.margin = margin(0, 5, 0, 2), panel.background = element_rect(fill = "NA", color = "NA"), # Panel background
    plot.background = element_rect(fill = "NA", color = "NA") # Plot background
    )

SalmonR_SO4_combo

ggsave("C:/Users/tevinger/Downloads/SalmonR SO4.png", SalmonR_SO4_combo, width = 5, height = 2.5, dpi = 300)

```

# SO4:Cl
## Data frames
```{r}
SalmonR_SO4_Cl <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification,Rel_Water_Area_plotting, f_SO4_mg_per_l, f_Cl_mg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting)) %>%
  mutate(
    # 1. Convert mg/L → mmol/L  (divide by molecular weight in g/mol = mg/mmol)

    Chloride_mol_L  = f_Cl_mg_per_l  / (35.45*1000),  # Cl⁻
    Sulfate_mol_L = f_SO4_mg_per_l / (96.06*1000),  # SO₄²⁻ (as sulfate)

    # 2. Molar SO4:Cl ratio
    SO4_Cl_molar  = Sulfate_mol_L / Chloride_mol_L
  )
```

```{r}
SalmonR_MS_SO4_Cl_area <- SalmonR_SO4_Cl %>%
  dplyr::select(
    SamplingEventID,
    Rel_Water_Area_plotting,
    SO4_Cl_molar,
    Hyd_Classification
  ) %>%
  filter(Hyd_Classification == "Mainstem") %>%
  pivot_longer(
    cols = SO4_Cl_molar,
    names_to = "type",
    values_to = "conc"
  ) %>%
  filter(!is.na(conc))

```

```{r}
SalmonR_trib_SO4_Cl_area <- SalmonR_SO4_Cl %>%
  dplyr::select(
    SamplingEventID,
    Rel_Water_Area_plotting,
    SO4_Cl_molar,
    Hyd_Classification
  ) %>%
  filter(Hyd_Classification == "Tributary") %>%
  pivot_longer(
    cols = SO4_Cl_molar,
    names_to = "type",
    values_to = "conc"
  ) %>%
  filter(!is.na(conc))
```

```{r}
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745","SalmonR_Trib2_20230722_1911","SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945","SalmonR_Trib3_20230724_1140","SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311","SalmonR_Trib6_20230724_1428","SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753","SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

```

```{r}
SO4_Cl_rel_data <- SalmonR_SO4_Cl %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(
    SalmonR_SO4_Cl %>%
      dplyr::select(
        RefID = SamplingEventID,
        ref_SO4_Cl = SO4_Cl_molar
      ),
    by = "RefID"
  ) %>%
  mutate(
    rel_SO4_Cl = SO4_Cl_molar / ref_SO4_Cl
  )

view(SO4_Cl_rel_data)
# should have 9 rows
```

```{r}
SO4_Cl_rel_data_to_join <- SO4_Cl_rel_data %>%
  dplyr::select(SamplingEventID, rel_SO4_Cl)

SalmonR_SO4_Cl_with_rel <- SalmonR_SO4_Cl %>%
  left_join(SO4_Cl_rel_data_to_join, by = "SamplingEventID")

view(SalmonR_SO4_Cl_with_rel)
# should have 19 rows

```

```{r}
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

SO4_Cl_df_expanded <- full_sequence %>%
  left_join(SO4_Cl_rel_data, by = "Rel_Water_Area_plotting")

SO4_Cl_rel_data_to_plot <- SO4_Cl_df_expanded %>%
  dplyr::select(-c(SO4_Cl_molar, ref_SO4_Cl)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

SO4_Cl_Anaktok_salmon <- SO4_Cl_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(SO4_Cl_molar, ref_SO4_Cl)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

SO4_Cl_rel_data_to_plot <- SO4_Cl_rel_data_to_plot %>%
  rows_update(SO4_Cl_Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(SO4_Cl_rel_data_to_plot)

```

```{r}
SO4_Cl_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(
    4.35, 4.7, 5.6, 6.2, 6.3, 7.2,
    7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12
  ),
  rel_SO4_Cl = 0
) %>% mutate(across(everything(), as.numeric))

SO4_Cl_rel_data_mod <- SO4_Cl_rel_data_to_plot %>%
  rows_update(SO4_Cl_mod_data, by = "Rel_Water_Area_plotting")

```

```{r}
SO4_Cl_rel_data_to_plot_interp <- SO4_Cl_rel_data_mod %>%
  mutate(rel_SO4_Cl = na.approx(
    rel_SO4_Cl,
    x = Rel_Water_Area_plotting,
    na.rm = FALSE,
    rule = 2
  ))

SO4_Cl_rel_data_to_plot_interp[1:75, "rel_SO4_Cl"] <- 0

f_SO4_Cl_rel_data_to_plot_interp <- SO4_Cl_rel_data_to_plot_interp %>%
  filter(rel_SO4_Cl >= 1.01)

```

## Trib heat plot
```{r}
trib_SO4_Cl_heat <- ggplot(
  f_SO4_Cl_rel_data_to_plot_interp,
  aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_SO4_Cl)
) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(
    xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
    linetype = "dashed", color = "black", linewidth = 0.5
  ) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(
    breaks = DA_x_breaks,
    labels = DA_x_labels,
    expand = expansion(mult = c(0.035, 0.015))
  ) +
  theme_minimal() + DA_theme +
  theme(
    axis.text.y = element_blank(),
    legend.position = "top",
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.title = element_blank(),
    axis.ticks.length.x = unit(0.1, "cm")
  )

trib_SO4_Cl_heat
```

## MS area plot
```{r}
SalmonR_SO4_Cl_area <- ggplot() +
  geom_area(data = SalmonR_MS_SO4_Cl_area,
            aes(x = Rel_Water_Area_plotting, y = conc),
            fill = "#2daa9e") +
  geom_line(data = SalmonR_MS_SO4_Cl_area,
            aes(x = Rel_Water_Area_plotting, y = conc),
            color = "#1d6e66", linewidth = 0.4) +
  geom_point(data = SalmonR_MS_SO4_Cl_area,
             aes(x = Rel_Water_Area_plotting, y = conc),
             pch = 19, color = "black", size = 2) +
  geom_vline(
    xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
    linetype = "dashed", color = "grey15", linewidth = 0.5
  ) +
  coord_cartesian(x = c(1,22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  theme(axis.text.y.right = element_blank()
        #axis.text.y.left = element_blank()
        ) +
  DA_theme

SalmonR_SO4_Cl_area

ggsave(
  "C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SO4_Cl area plot with labels.png",
  SalmonR_SO4_Cl_area,
  width = 3.6,
  height = 1.8,
  dpi = 300
)
```

## Combo
```{r}
SalmonR_SO4_Cl_area_combo <- (
  trib_SO4_Cl_heat / SalmonR_SO4_Cl_area +
  plot_layout(ncol = 1, nrow = 2, heights = c(1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    legend.position = "none",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9),
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
    legend.spacing = unit(0.1, "cm"),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA)
  )

SalmonR_SO4_Cl_area_combo

ggsave(
  "C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SO4_Cl area plus heat plot_without labels.png",
  SalmonR_SO4_Cl_area_combo,
  width = 3.6,
  height = 1.8,
  dpi = 300
)

```

```{r}

```

```{r}


```

# Mg
## Data frames
```{r}
SalmonR_Mg <- SalmonR_2023_river_data %>%
  dplyr::select(
    SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting,
    f_Mg_mg_l
  ) %>%
  filter(!is.na(Rel_Water_Area_plotting))

# view(SalmonR_Mg)

DA_x_breaks <- seq(0,25, by = 2.5)
DA_x_labels <- c(0,"",5,"",10,"",15,"",20,"",25)
DA_labels

Mg_breaks <- seq(0,130, by = 5)
Mg_labels <- c("0", "", "", "", "20", "", "", "", "40", "", "", "", "60", "", "", "", "80", "", "", "", "100", "", "", "", "120", "125", "")

Mg_bottom_breaks <- seq(0,60, by = 10)
Mg_bottom_labels <- c(0,"",20,"",40,"",60)

print(Mg_labels)
```

```{r}
SalmonR_MS_Mg_area <- SalmonR_filtered_MS %>%
  dplyr::select(
    SamplingEventID,
    Rel_Water_Area_plotting,
    f_Mg_mg_l
  ) %>%
  pivot_longer(
    cols = f_Mg_mg_l,
    names_to = "type",
    values_to = "conc"
  ) %>%
  filter(!is.na(conc))

```

```{r}
SalmonR_trib_Mg_area <- SalmonR_filtered_Trib %>%
  dplyr::select(
    SamplingEventID,
    Rel_Water_Area_plotting,
    f_Mg_mg_l
  ) %>%
  pivot_longer(
    cols = f_Mg_mg_l,
    names_to = "type",
    values_to = "conc"
  ) %>%
  filter(!is.na(conc))

```

```{r}
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745","SalmonR_Trib2_20230722_1911","SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945","SalmonR_Trib3_20230724_1140","SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311","SalmonR_Trib6_20230724_1428","SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753","SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

```

```{r}
Mg_rel_data <- SalmonR_Mg %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(
    SalmonR_Mg %>%
      dplyr::select(
        RefID = SamplingEventID,
        ref_Mg = f_Mg_mg_l
      ),
    by = "RefID"
  ) %>%
  mutate(
    rel_Mg = f_Mg_mg_l / ref_Mg
  )

view(Mg_rel_data)
# should have 9 rows

```

```{r}
Mg_rel_data_to_join <- Mg_rel_data %>%
  dplyr::select(SamplingEventID, rel_Mg)

SalmonR_Mg_with_rel <- SalmonR_Mg %>%
  left_join(Mg_rel_data_to_join, by = "SamplingEventID")

view(SalmonR_Mg_with_rel)
# should have 19 rows

```

```{r}
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

Mg_df_expanded <- full_sequence %>%
  left_join(Mg_rel_data, by = "Rel_Water_Area_plotting")

Mg_rel_data_to_plot <- Mg_df_expanded %>%
  dplyr::select(-c(f_Mg_mg_l, ref_Mg)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Mg_Anaktok_salmon <- Mg_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(f_Mg_mg_l, ref_Mg)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Mg_rel_data_to_plot <- Mg_rel_data_to_plot %>%
  rows_update(Mg_Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(Mg_rel_data_to_plot)

```

```{r}
Mg_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(
    4.35, 4.7, 5.6, 6.2, 6.3, 7.2,
    7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12
  ),
  rel_Mg = 0
) %>% mutate(across(everything(), as.numeric))

Mg_rel_data_mod <- Mg_rel_data_to_plot %>%
  rows_update(Mg_mod_data, by = "Rel_Water_Area_plotting")

```

```{r}
Mg_rel_data_to_plot_interp <- Mg_rel_data_mod %>%
  mutate(rel_Mg = na.approx(
    rel_Mg,
    x = Rel_Water_Area_plotting,
    na.rm = FALSE,
    rule = 2
  ))

Mg_rel_data_to_plot_interp[1:75, "rel_Mg"] <- 0

f_Mg_rel_data_to_plot_interp <- Mg_rel_data_to_plot_interp %>%
  filter(rel_Mg >= 1.01)

```

## Trib heat plot
```{r}
trib_Mg_heat <- ggplot(
  f_Mg_rel_data_to_plot_interp,
  aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_Mg)
) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(
    xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
    linetype = "dashed", color = "black", linewidth = 0.5
  ) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(
    breaks = DA_x_breaks,
    labels = DA_x_labels,
    expand = expansion(mult = c(0.035, 0.015))
  ) +
  theme_minimal() + DA_theme +
  theme(
    axis.text.y = element_blank(),
    legend.position = "top",
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.title = element_blank(),
    axis.ticks.length.x = unit(0.1, "cm")
  )

trib_Mg_heat

```

## Area plot
```{r}
SalmonR_Mg_area <- ggplot() +
  geom_area(data = SalmonR_MS_Mg_area,
            aes(x = Rel_Water_Area_plotting, y = conc),
            fill = "#2daa9e") +
  geom_line(data = SalmonR_MS_Mg_area,
            aes(x = Rel_Water_Area_plotting, y = conc),
            color = "#1d6e66", linewidth = 0.4) +
  geom_point(data = SalmonR_MS_Mg_area,
             aes(x = Rel_Water_Area_plotting, y = conc),
             pch = 19, color = "black", size = 2) +
  geom_vline(
    xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
    linetype = "dashed", color = "grey15", linewidth = 0.5
  ) +
  coord_cartesian(x = c(1,22.5), y = c(0,50)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  scale_y_continuous(
    breaks = c(0,10,20,30,40,50,60),
    labels = c(0,"",20,"",40,"",60),
    sec.axis = dup_axis(),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  theme(axis.text.y.right = element_blank(),
        axis.text.y.left = element_blank()) +
  DA_theme

SalmonR_Mg_area

```

```{r}
SalmonR_Mg_area_combo <- (
  trib_Mg_heat / SalmonR_Mg_area +
  plot_layout(ncol = 1, nrow = 2, heights = c(1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    legend.position = "none",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9),
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
    legend.spacing = unit(0.1, "cm"),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA)
  )

SalmonR_Mg_area_combo

ggsave(
  "C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Mg area plus heat plot_without labels.png",
  SalmonR_Mg_area_combo,
  width = 3.6,
  height = 1.8,
  dpi = 300
)

```

# Ca
```{r}
SalmonR_Ca <- SalmonR_2023_river_data %>%
  dplyr::select(
    SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting,
    f_Ca_mg_l
  ) %>%
  filter(!is.na(Rel_Water_Area_plotting))

# view(SalmonR_Ca)

DA_x_breaks <- seq(0,25, by = 2.5)
DA_x_labels <- c(0,"",5,"",10,"",15,"",20,"",25)
DA_labels

Ca_breaks <- seq(0,130, by = 5)
Ca_labels <- c("0", "", "", "", "20", "", "", "", "40", "", "", "", "60", "", "", "", "80", "", "", "", "100", "", "", "", "120", "125", "")

Ca_bottom_breaks <- seq(0,80, by = 10)
Ca_bottom_labels <- c(0,"",20,"",40,"",60, "", 80)

print(Ca_labels)
```

```{r}
SalmonR_MS_Ca_area <- SalmonR_filtered_MS %>%
  dplyr::select(
    SamplingEventID,
    Rel_Water_Area_plotting,
    f_Ca_mg_l
  ) %>%
  pivot_longer(
    cols = f_Ca_mg_l,
    names_to = "type",
    values_to = "conc"
  ) %>%
  filter(!is.na(conc))

```

```{r}
SalmonR_trib_Ca_area <- SalmonR_filtered_Trib %>%
  dplyr::select(
    SamplingEventID,
    Rel_Water_Area_plotting,
    f_Ca_mg_l
  ) %>%
  pivot_longer(
    cols = f_Ca_mg_l,
    names_to = "type",
    values_to = "conc"
  ) %>%
  filter(!is.na(conc))

```

```{r}
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745","SalmonR_Trib2_20230722_1911","SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945","SalmonR_Trib3_20230724_1140","SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311","SalmonR_Trib6_20230724_1428","SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753","SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

```

```{r}
Ca_rel_data <- SalmonR_Ca %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(
    SalmonR_Ca %>%
      dplyr::select(
        RefID = SamplingEventID,
        ref_Ca = f_Ca_mg_l
      ),
    by = "RefID"
  ) %>%
  mutate(
    rel_Ca = f_Ca_mg_l / ref_Ca
  )

view(Ca_rel_data)
# should have 9 rows

```

```{r}
Ca_rel_data_to_join <- Ca_rel_data %>%
  dplyr::select(SamplingEventID, rel_Ca)

SalmonR_Ca_with_rel <- SalmonR_Ca %>%
  left_join(Ca_rel_data_to_join, by = "SamplingEventID")

view(SalmonR_Ca_with_rel)
# should have 19 rows

```

```{r}
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

Ca_df_expanded <- full_sequence %>%
  left_join(Ca_rel_data, by = "Rel_Water_Area_plotting")

Ca_rel_data_to_plot <- Ca_df_expanded %>%
  dplyr::select(-c(f_Ca_mg_l, ref_Ca)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Ca_Anaktok_salmon <- Ca_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(f_Ca_mg_l, ref_Ca)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Ca_rel_data_to_plot <- Ca_rel_data_to_plot %>%
  rows_update(Ca_Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(Ca_rel_data_to_plot)

```

```{r}
Ca_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(
    4.35, 4.7, 5.6, 6.2, 6.3, 7.2,
    7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12
  ),
  rel_Ca = 0
) %>% mutate(across(everything(), as.numeric))

Ca_rel_data_mod <- Ca_rel_data_to_plot %>%
  rows_update(Ca_mod_data, by = "Rel_Water_Area_plotting")

```

```{r}
Ca_rel_data_to_plot_interp <- Ca_rel_data_mod %>%
  mutate(rel_Ca = na.approx(
    rel_Ca,
    x = Rel_Water_Area_plotting,
    na.rm = FALSE,
    rule = 2
  ))

Ca_rel_data_to_plot_interp[1:75, "rel_Ca"] <- 0

f_Ca_rel_data_to_plot_interp <- Ca_rel_data_to_plot_interp %>%
  filter(rel_Ca >= 1.01)

```

```{r}
trib_Ca_heat <- ggplot(
  f_Ca_rel_data_to_plot_interp,
  aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_Ca)
) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(
    xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
    linetype = "dashed", color = "black", linewidth = 0.5
  ) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(
    breaks = DA_x_breaks,
    labels = DA_x_labels,
    expand = expansion(mult = c(0.035, 0.015))
  ) +
  theme_minimal() + DA_theme +
  theme(
    axis.text.y = element_blank(),
    legend.position = "top",
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.title = element_blank(),
    axis.ticks.length.x = unit(0.1, "cm")
  )

trib_Ca_heat

```

```{r}
SalmonR_Ca_area <- ggplot() +
  geom_area(data = SalmonR_MS_Ca_area,
            aes(x = Rel_Water_Area_plotting, y = conc),
            fill = "#2daa9e") +
  geom_line(data = SalmonR_MS_Ca_area,
            aes(x = Rel_Water_Area_plotting, y = conc),
            color = "#1d6e66", linewidth = 0.4) +
  geom_point(data = SalmonR_MS_Ca_area,
             aes(x = Rel_Water_Area_plotting, y = conc),
             pch = 19, color = "black", size = 2) +
  geom_vline(
    xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
    linetype = "dashed", color = "grey15", linewidth = 0.5
  ) +
  coord_cartesian(x = c(1,22.5), y = c(0,80)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  scale_y_continuous(
    breaks = c(0,10,20,30,40,50,60,70,80),
    labels = c(0,"",20,"",40,"",60,"",80),
    sec.axis = dup_axis(),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  theme(axis.text.y.right = element_blank(),
        axis.text.y.left = element_blank()
        ) +
  DA_theme

SalmonR_Ca_area

```

```{r}
SalmonR_Ca_area_combo <- (
  trib_Ca_heat / SalmonR_Ca_area +
  plot_layout(ncol = 1, nrow = 2, heights = c(1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    legend.position = "none",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9),
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
    legend.spacing = unit(0.1, "cm"),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA)
  )

SalmonR_Ca_area_combo

ggsave(
  "C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Ca area plus heat plot_without labels.png",
  SalmonR_Ca_area_combo,
  width = 3.6,
  height = 1.8,
  dpi = 300)
```

# Fe
```{r}
SalmonR_Fe <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification,Rel_Water_Area_plotting, u_Fe_mcg_per_l, f_Fe_mcg_per_l, p_Fe_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

#view(SalmonR_Fe)
```

### modifications
```{r}

# Calculate tributary metal concentrations relative to the nearest upstream MS sample concentration for heat plot

# Step 1: A reference map for each row that needs normalization
ref_map <- tibble(
  SamplingEventID = c(
  "SalmonR_Trib1_20230722_1745",
  "SalmonR_Trib2_20230722_1911",
  "SheepC_1_20230719_0923",
  "Anaktok_1_20230723_1945",
  "SalmonR_Trib3_20230724_1140",
  "SalmonR_Trib4_20230724_1155",
  "SalmonR_Trib5_20230724_1311",
  "SalmonR_Trib6_20230724_1428",
  "SalmonR_Trib7_20230724_1453"
),
  RefID = c(
  "SalmonR_MS_above_Trib1_20230722_1753",
  "SalmonR_MS_above_Trib2_20230722_1915",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_above_Trib6_20230724_1439",
  "SalmonR_MS_above_Trib6_20230724_1439"
)
)

# Step 2: Join main data to get both the value row and its reference row
Fe_rel_data <- SalmonR_Fe %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(SalmonR_Fe %>%
              dplyr::select(RefID = SamplingEventID, 
                     ref_u_Fe = u_Fe_mcg_per_l,
                     ref_f_Fe = f_Fe_mcg_per_l,
                     ref_p_Fe = p_Fe_mcg_per_l),
            by = "RefID") %>%
  mutate(
    rel_u_Fe = u_Fe_mcg_per_l / ref_u_Fe,
    rel_f_Fe = f_Fe_mcg_per_l / ref_f_Fe,
    rel_p_Fe = p_Fe_mcg_per_l / ref_p_Fe
  )
  
#view(Fe_rel_data)

# only keep values that are greater than 1 for the heat plots
# Fe_rel_data_mod <- Fe_rel_data %>%
#   mutate(across(
#     .cols = c(rel_u_Fe, rel_f_Fe, rel_p_Fe),
#     .fns = ~ ifelse(. < 1, 0, .) # if a value is less than 1 make it a 0
#   ))
# 
# view(Fe_rel_data_mod)
```

```{r}
#join the relative concentrations to the main data
Fe_rel_data_to_join <- Fe_rel_data %>%
  dplyr::select(SamplingEventID, rel_u_Fe, rel_f_Fe, rel_p_Fe)

SalmonR_Fe_with_rel <- SalmonR_Fe %>%
  left_join(rel_data_to_join, by = "SamplingEventID")

#view(SalmonR_Fe_with_rel)
```

```{r}
# extend the data to have a fake continuous x axis with fake data

# Create full sequence from 0 to 22.5 by 0.05
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

# Join original df with the full sequence
df_expanded <- full_sequence %>%
  left_join(Fe_rel_data, by = "Rel_Water_Area_plotting")

Fe_rel_data_to_plot <- df_expanded %>%
  dplyr::select(-c(u_Fe_mcg_per_l, f_Fe_mcg_per_l, p_Fe_mcg_per_l, ref_u_Fe, ref_f_Fe, ref_p_Fe)) %>%
   mutate(Rel_Water_Area_plotting = as.numeric(Rel_Water_Area_plotting)) %>%
  mutate(Rel_Water_Area_plotting = round(Rel_Water_Area_plotting, 2))

Fe_Anaktok_salmon <- Fe_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(u_Fe_mcg_per_l, f_Fe_mcg_per_l, p_Fe_mcg_per_l, ref_u_Fe, ref_f_Fe, ref_p_Fe)) %>%
   mutate(Rel_Water_Area_plotting = as.numeric(Rel_Water_Area_plotting)) %>%
  mutate(Rel_Water_Area_plotting = round(Rel_Water_Area_plotting, 2))

# Replace the existing row with the one from Anaktok_salmon
Fe_rel_data_to_plot <- Fe_rel_data_to_plot %>%
  rows_update(Fe_Anaktok_salmon, by = "Rel_Water_Area_plotting")

#view(rel_data_to_plot)
```

Manually add data values to relative data to control more of how the NA values are interpolated
```{r}
# mod_data <- data.frame(
#   Rel_Water_Area_plotting = c(4.7, 5.6, 6.2, 7.95, 8.05, 8.95, 10.75, 10.90, 10.95, 14),
#   rel_u_Fe = c(1, 0.2, 0, 0, 0, 0, 0, 0, 0, 0),
#   rel_f_Fe = c(8, 15, 0, 0, 0, 0, 0, 0, 0, 0),
#   rel_p_Fe = c(0.5, 0.2, 0, 0, 0, 0, 0, 0, 0.5, 0)
# ) %>%
#   mutate(across(everything(), as.numeric))

Fe_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(4.35, 4.7, 5.6, 6.2, 6.3, 7.2, 7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12),
  rel_u_Fe = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 00),
  rel_f_Fe = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
  rel_p_Fe = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
) %>%
  mutate(across(everything(), as.numeric))

Fe_rel_data_mod <- Fe_rel_data_to_plot %>%
  rows_update(Fe_mod_data, by = "Rel_Water_Area_plotting")

#view(Fe_rel_data_mod)
```

Linear interpolation using na.approx
```{r}
# manually change the highest value
Fe_rel_data_mod2 <- Fe_rel_data_mod %>%
  mutate(rel_f_Fe = case_when(
    Rel_Water_Area_plotting == 4.75  ~ 25,
    TRUE ~ rel_f_Fe  # keep original value if no match
  ))

# Apply linear interpolation to all numeric columns except Rel_Water_Area_plotting
Fe_rel_data_to_plot_interp <- Fe_rel_data_mod2 %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

# make the values before the first tributary 0 
Fe_rel_data_to_plot_interp[1:75, 6:8] <- 0

# keep only values greater than 1 to plot
f_Fe_rel_data_to_plot_interp <- Fe_rel_data_to_plot_interp %>%
  filter(rel_f_Fe >= 1.01)

p_Fe_rel_data_to_plot_interp <- Fe_rel_data_to_plot_interp %>%
  filter(rel_p_Fe >= 1.01)

#view(rel_data_to_plot_interp)
```

Data interpolation using na_interpolation - spline
```{r}
# spline interpolates a smooth curve through points
rel_data_to_plot_interp_spline <- rel_data_mod %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na_interpolation(., option = "spline", maxgap = Inf)
  ))

#view(rel_data_to_plot_interp_spline)
```

Data interpolation using na_interpolation - stine
```{r}
# stine is similar to spline but avoids overshoots and extreme curves
rel_data_mod2 <- rel_data_mod %>%
  mutate(rel_f_Fe = case_when(
    Rel_Water_Area_plotting == 4.75  ~ 100,
    TRUE ~ rel_f_Fe  # keep original value if no match
  ))

rel_data_to_plot_interp_stine <- rel_data_mod2 %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na_interpolation(., option = "stine", maxgap = Inf)
  ))
```

Interpolation using state space method - na_kalman
```{r}
#na_kalman uses a Kalman filter and smoother to estimate missing values by reconstructing the latent state of the system.

# create a function to replace the NA values before the first value in the df with zeros
fill_leading_zeros <- function(x) {
  first_non_na <- which(!is.na(x))[1]
  if (!is.na(first_non_na) && first_non_na > 1) {
    x[1:(first_non_na - 1)] <- 0  # set leading NAs to 0
  }
  return(x)
}

# Default state space method (StructTS)
filled_series <- rel_data_mod %>%
  mutate(across(
    .cols = c(rel_u_Fe, rel_f_Fe, rel_p_Fe),
    .fns = ~ na_kalman(fill_leading_zeros(.))
  ))

view(filled_series)
```


Mainstem data frame
```{r}
SalmonR_MS_Fe_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Fe_mcg_per_l, u_Fe_mcg_per_l) %>%
  #filter(!(New_Groups == "NA")) %>%
  #filter(p_Fe_mcg_per_l >= 0.01) %>%
  pivot_longer(
    cols = c(f_Fe_mcg_per_l, u_Fe_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Fe_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) # filtering out here means only the f or p value that is NA is excluded, not both measurements for the same sample

view(SalmonR_MS_Fe_area)

MS_f_Fe_area <- SalmonR_MS_Fe_area %>%
  filter(Metal_type == "f")

MS_u_Fe_area <- SalmonR_MS_Fe_area %>%
  filter(Metal_type == "u")
```

Tributary data frame
```{r}
SalmonR_trib_Fe_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Fe_mcg_per_l, u_Fe_mcg_per_l) %>%
  #filter(!(New_Groups == "NA")) %>%
  #filter(p_Fe_mcg_per_l >= 0.01) %>%
  pivot_longer(
    cols = c(f_Fe_mcg_per_l, u_Fe_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Fe_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) # filtering out here means only the f or p value that is NA is excluded, not both measurements for the same sample

view(SalmonR_trib_Fe_area)

trib_f_Fe_area <- SalmonR_trib_Fe_area %>%
  filter(Metal_type == "f")

trib_u_Fe_area <- SalmonR_trib_Fe_area %>%
  filter(Metal_type == "u")
```

### area plot
```{r}
breaks <- c(0.01, 0.1, 1, 10, 100, 1000, 10000, 100000)

# Create labels as bold expressions
Fe_labels <- sapply(log10(breaks), function(x) {
  if(x == 0) {
    "bold(10^0)"
  } else {
    paste0("bold(10^", x, ")")
  }
})
```

```{r}
SalmonR_Fe_area_no_tribs <- ggplot() +

  geom_area(data = MS_u_Fe_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            #fill = "#28968b"
            fill = "grey30"
            #alpha = 0.85
            ) +
  
  geom_line(data = MS_u_Fe_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), color = "grey28", linewidth = 0.5) +
  
  geom_area(data = MS_f_Fe_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            #fill = "#c9f1e4") + # light blue/green for filtered
            fill = "#2daa9e") + # darker green for filtered paired with grey for particulate
  geom_line(data = MS_f_Fe_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), color = "#1d6e66", linewidth = 0.4) +
  
  # Mainstem point for filtered data
  geom_point(data = MS_f_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 19, color = "black", 
           size = 2) +
  
  # mainstem point for unfiltered data
geom_point(data = MS_u_Fe_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), pch = 19, 
           color = "black",
           size = 2) +
  
  # lines for locations of sampled tributaries
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11), linetype = "dashed", color = "grey15", linewidth = 0.5) +
  
  coord_cartesian(x = c(1,22.5), y = c(1,10000)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.035, 0.015))) +
  # scale_y_log10(breaks = c(0.01,0.1,1,10,100,1000,10000, 100000), labels = scales::comma, expand = expansion(mult = c(0.02, 0.02)), sec.axis = dup_axis()) +
  scale_y_log10(
    breaks = breaks,
    labels = parse(text = labels),
    expand = expansion(mult = c(0.02, 0.02)),
    sec.axis = dup_axis()
  ) +
  annotation_logticks(sides = "lr") +
  labs(
    #x = "Relative Watershed Area",
    #y = "Metal Concentration",
    x = NULL,
    y = NULL,
    title = NULL
    #title = "Fe Area Plot - Unfiltered and Filtered"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    axis.text.y.right = element_blank()
  )

#SalmonR_Fe_area_tribs

SalmonR_Fe_area_no_tribs

#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SalmonR Fe area plot practice.png", SalmonR_Fe_area, width = 5.1, height = 2.5, dpi = 300)
```

### Trib heat plot
na.aprox method
```{r}
f_Fe_heat <- ggplot(f_Fe_rel_data_to_plot_interp, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Fe)) +
  geom_tile(color = NA, width = 0.05) +
   geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(
     title = NULL,
    #title = "na.approx method",
    x = NULL,
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  coord_cartesian(x = c(1,22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    #axis.ticks.x = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.position = "none",
    legend.title = element_blank(),
    axis.ticks.length.x = unit(0.1, "cm")  # make tick marks shorter
  )

f_Fe_heat

p_Fe_heat <- ggplot(p_Fe_rel_data_to_plot_interp, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_p_Fe)) +
  geom_tile(color = NA, width = 0.05) +
   geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "#301934") +
  labs(
    title = NULL,
    #title = "na.approx method",
    x = NULL,
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  coord_cartesian(x = c(1,22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.position = "none",
    legend.margin = margin(2, 2, 0, 2),
    plot.margin = margin(0, 1, 1, 1),
    legend.title = element_blank(),
    axis.ticks.length.x = unit(0.1, "cm")  # make tick marks shorter
  )

p_Fe_heat

Salmon_Fe_combined <- p_Fe_heat / f_Fe_heat
Salmon_Fe_combined

#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SalmonR Fe tributary heat plot with legend.png", Salmon_Fe_combined, width = 5.1, height = 2.5, dpi = 300)
```

```{r}
f_Fe_heat_legend <- ggpubr::get_legend(f_Fe_heat)

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/f_Fe heat legend.png",cowplot::ggdraw(f_Fe_heat_legend), width = 4, height = 2, dpi = 300)

p_Fe_heat_legend <- ggpubr::get_legend(p_Fe_heat)

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/p_Fe heat legend.png",cowplot::ggdraw(p_Fe_heat_legend), width = 4, height = 2, dpi = 300)
```

## combo
```{r}
SalmonR_Fe_area_combo <- (
  Salmon_Fe_combined / SalmonR_Fe_area_no_tribs +
  plot_layout(ncol = 1, nrow = 3, heights = c(1, 1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA),
    legend.position = "none",
    legend.text = element_text(size = 8),       # smaller legend labels
    legend.title = element_text(size = 9),      # smaller legend title
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
    legend.spacing = unit(0.1, "cm") # smaller boxes
  )

SalmonR_Fe_area_combo

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Fe area plus heat plot_no labels.png", SalmonR_Fe_area_combo, width = 3.6, height = 2.1, dpi = 300)
```

na_interpolation - spline
```{r}
f_Fe_heat_spline <- ggplot(rel_data_to_plot_interp_spline, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Fe)) +
  geom_tile(color = NA, width = 0.05) +
   geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "lightblue", high = "darkred") +
  labs(
    title = "na_interpolation spline method",
    x = "Relative Water Area",
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank()
  )

f_Fe_heat_spline

```

na_interpolation - stine
```{r}
f_Fe_heat_stine <- ggplot(rel_data_to_plot_interp_stine, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Fe)) +
  geom_tile(color = NA, width = 0.05) +
   geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "lightblue", high = "darkred") +
  labs(
    title = "na_interpolation stine method",
    x = "Relative Water Area",
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank()
  )

f_Fe_heat_stine

```

na_kalman
```{r}
p_Fe_heat_kalman <- ggplot(filled_series, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_p_Fe)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(
    xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
    linetype = "dashed", color = "black", linewidth = 0.5
  ) +
  scale_fill_gradientn(
    colours = c("lightblue", "darkred")
  ) +
  labs(
    title = "na_kalman method",
    x = "Relative Water Area",
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank()
  )

p_Fe_heat_kalman
```


### geom_point
```{r}
# Select MS Fe data
# Filter NA values in the grouping variable, filter particulate concentrations and make long format
SalmonR_MS_Fe_long <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Fe_mcg_per_l, f_Fe_mcg_per_l_qa, p_Fe_mcg_per_l, p_Fe_mcg_per_l_qa) %>%
  #filter(!(New_Groups == "NA")) %>%
  #filter(p_Fe_mcg_per_l >= 0.01) %>%
  pivot_longer(
    cols = c(f_Fe_mcg_per_l, p_Fe_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Fe_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>% # filtering out here means only the f or p value that is NA is excluded, not both measurements for the same sample
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*1), 
                                  Metal_conc))

view(SalmonR_MS_Fe_long)

MS_f_Fe_long <- SalmonR_MS_Fe_long %>%
  filter(Metal_type == "f")

MS_p_Fe_long <- SalmonR_MS_Fe_long %>%
  filter(Metal_type == "p")
```

```{r}
# Select unimpaired trib Fe data
# Filter NA values in the grouping variable, filter particulate concentrations and make long format
SalmonR_trib_Fe_long <- Salmon_unimpaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Fe_mcg_per_l, f_Fe_mcg_per_l_qa, p_Fe_mcg_per_l, p_Fe_mcg_per_l_qa) %>%
  #filter(!(New_Groups == "NA")) %>%
  #filter(p_Fe_mcg_per_l >= 0.01) %>%
  pivot_longer(
    cols = c(f_Fe_mcg_per_l, p_Fe_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Fe_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>% # filtering out here means only the f or p value that is NA is excluded, not both measurements for the same sample
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*1), 
                                  Metal_conc))

view(SalmonR_trib_Fe_long)

trib_f_Fe_long <- SalmonR_trib_Fe_long %>%
  filter(Metal_type == "f")

trib_p_Fe_long <- SalmonR_trib_Fe_long %>%
  filter(Metal_type == "p")
```

```{r}
# Select impaired trib Fe data
# Filter NA values in the grouping variable, filter particulate concentrations and make long format
SalmonR_impaired_Fe_long <- Salmon_impaired_tribs %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Fe_mcg_per_l, f_Fe_mcg_per_l_qa, p_Fe_mcg_per_l, p_Fe_mcg_per_l_qa) %>%
  #filter(!(New_Groups == "NA")) %>%
  #filter(p_Fe_mcg_per_l >= 0.01) %>%
  pivot_longer(
    cols = c(f_Fe_mcg_per_l, p_Fe_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Fe_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) %>% # filtering out here means only the f or p value that is NA is excluded, not both measurements for the same sample
  mutate(Metal_conc_plot = ifelse(Metal_conc == 0, 
                                  Metal_conc + ((sqrt(2)/2)*1), 
                                  Metal_conc))

view(SalmonR_impaired_Fe_long)

impaired_f_Fe_long <- SalmonR_impaired_Fe_long %>%
  filter(Metal_type == "f")

impaired_p_Fe_long <- SalmonR_impaired_Fe_long %>%
  filter(Metal_type == "p")
```

```{r}
SalmonR_Fe_top <- ggplot() +
  # Filtered Fe
  # Points for impaired tribs
  geom_point(data = impaired_f_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 25, 
             #color = "black", 
             fill = "indianred2", 
             size = 2, stroke = 1.2) +
  coord_cartesian(x = c(1, 22.5), y = c(19925, 19950)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels) +
  scale_y_log10(breaks = c(19925,19950), labels = scales::comma) +
  annotation_logticks(sides = "l") +
  #scale_y_continuous(breaks = DIC_breaks,labels = DIC_labels) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    plot.margin = margin(0, 5, 0, 2),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_text(size = 12, color = "black", face = "bold")
  )

SalmonR_Fe_top

#ggsave("C:/Users/tevinger/Downloads/SalmonR DIC.png", SalmonR_DIC_top, width = 5, height = 2.5, dpi = 300)
```

```{r}
SalmonR_Fe_bottom <- ggplot() +
  
  # unfiltered Fe area plot with line to outline
  geom_area(data = MS_u_Fe_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            #fill = "#28968b"
            fill = "grey50"
            #alpha = 0.85
            ) +
  geom_line(data = MS_u_Fe_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), color = "grey28", linewidth = 0.5) +
  
  # filtered Fe area plot with line to outline
  geom_area(data = MS_f_Fe_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            #fill = "#c9f1e4") + # light blue/green for filtered
            fill = "#2daa9e") + # darker green for filtered paired with grey for particulate
  geom_line(data = MS_f_Fe_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), color = "#1d6e66", linewidth = 0.4) +
  
  # Mainstem point for filtered data
  geom_point(data = MS_f_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 19, color = "black", 
           size = 1.5) +
  
  # mainstem point for unfiltered data
geom_point(data = MS_u_Fe_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), pch = 19, 
           color = "black",
           size = 1.5) +
  
  # lines for locations of sampled tributaries
  #geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11), linetype = "dashed", color = "grey15", linewidth = 0.5) +
  
  
  # Points for SalmonR_filtered_Trib
  geom_point(data = trib_f_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "#a1e6ce",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 2, stroke = 1.2) +
  
  # Points for impaired tribs
  geom_point(data = impaired_f_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, 
             color = "indianred3", 
             #fill = "indianred2", 
             size = 2, stroke = 1.2) +
  
  # Particulate Fe
  
  # Points for SalmonR_filtered_Trib
  geom_point(data = trib_p_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 24, color = "black", 
             #fill = "#c0eeea",
             fill = "grey28",
             #fill = "#92e2c6",
             #fill = "#b1ead6",
             size = 2, stroke = 1.2) +
  
  # Points for impaired tribs
  geom_point(data = impaired_p_Fe_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 8, 
             color = "black", 
             #fill = "indianred4", 
             size = 2, stroke = 1.2) +
  coord_cartesian(x = c(1, 22.5), y = c(5, 30000)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.06, 0.05))) +
  scale_y_log10(breaks = c(1,10,100,1000,10000), labels = scales::comma) +
  annotation_logticks(sides = "lr") +
  #scale_y_continuous(breaks = c(0,100,200,300,400,500,1000), labels = c(0,100,200,300,400,500,1000)) +
  labs(
    title = NULL,
    x = "Distance Downstream (km)",
    y = NULL,
    color = "Legend"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    plot.margin = margin(0, 5, 0, 2),
    axis.title.x = element_blank(),
    axis.text.y = element_text(size = 12, color = "black", face = "bold"),
    axis.text.x = element_text(size = 12, color = "black", face = "bold")
  )

SalmonR_Fe_bottom

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SalmonR Fe_V5.png", SalmonR_Fe_bottom, width = 3.8, height = 2, dpi = 300)
```

```{r}
SalmonR_Fe_combo <- SalmonR_Fe_top / SalmonR_Fe_bottom + plot_layout(
  heights = c(1, 5), 
  guides = "collect") & theme(plot.margin = margin(1.8, 5, 0, 2), panel.background = element_rect(fill = "NA", color = "NA"), # Panel background
    plot.background = element_rect(fill = "NA", color = "NA") # Plot background
    )

SalmonR_Fe_combo

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/SalmonR Fe_V2.png", SalmonR_Fe_combo, width = 3.8, height = 2, dpi = 300)

```

# Zn
### Data frames
```{r}
SalmonR_Zn <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification,Rel_Water_Area_plotting, u_Zn_mcg_per_l, f_Zn_mcg_per_l, p_Zn_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

#view(SalmonR_Zn)
```

Mainstem data frame
```{r}
SalmonR_MS_Zn_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Zn_mcg_per_l, u_Zn_mcg_per_l) %>%
  #filter(!(New_Groups == "NA")) %>%
  #filter(p_Fe_mcg_per_l >= 0.01) %>%
  pivot_longer(
    cols = c(f_Zn_mcg_per_l, u_Zn_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Zn_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) # filtering out here means only the f or p value that is NA is excluded, not both measurements for the same sample

#view(SalmonR_MS_Zn_area)

MS_f_Zn_area <- SalmonR_MS_Zn_area %>%
  filter(Metal_type == "f")

MS_u_Zn_area <- SalmonR_MS_Zn_area %>%
  filter(Metal_type == "u")
```

Tributary data frame
```{r}
SalmonR_trib_Zn_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Zn_mcg_per_l, u_Zn_mcg_per_l) %>%
  #filter(!(New_Groups == "NA")) %>%
  #filter(p_Fe_mcg_per_l >= 0.01) %>%
  pivot_longer(
    cols = c(f_Zn_mcg_per_l, u_Zn_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Fe_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc)) # filtering out here means only the f or p value that is NA is excluded, not both measurements for the same sample

#view(SalmonR_trib_Zn_area)

trib_f_Zn_area <- SalmonR_trib_Zn_area %>%
  filter(Metal_type == "f")

trib_u_Zn_area <- SalmonR_trib_Zn_area %>%
  filter(Metal_type == "u")
```

Modifications for heat plots
```{r}
# Calculate tributary metal concentrations relative to the nearest upstream MS sample concentration for heat plot

# Step 1: A reference map for each row that needs normalization
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745",
    "SalmonR_Trib2_20230722_1911",
    "SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945",
    "SalmonR_Trib3_20230724_1140",
    "SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311",
    "SalmonR_Trib6_20230724_1428",
    "SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753",
    "SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

# Step 2: Join main data to get both the value row and its reference row
Zn_rel_data <- SalmonR_Zn %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(SalmonR_Zn %>%
              dplyr::select(RefID = SamplingEventID, 
                            ref_u_Zn = u_Zn_mcg_per_l,
                            ref_f_Zn = f_Zn_mcg_per_l,
                            ref_p_Zn = p_Zn_mcg_per_l),
            by = "RefID") %>%
  mutate(
    rel_u_Zn = u_Zn_mcg_per_l / ref_u_Zn,
    rel_f_Zn = f_Zn_mcg_per_l / ref_f_Zn,
    rel_p_Zn = p_Zn_mcg_per_l / ref_p_Zn
  )

#view(Zn_rel_data)

# only keep values that are greater than 1 for the heat plots
# rel_data_mod <- rel_data %>%
#   mutate(across(
#     .cols = c(rel_u_Zn, rel_f_Zn, rel_p_Zn),
#     .fns = ~ ifelse(. < 1, 0, .)
#   ))

#view(rel_data_mod)
```

```{r}
# Join the relative concentrations to the main data
Zn_rel_data_to_join <- Zn_rel_data %>%
  dplyr::select(SamplingEventID, rel_u_Zn, rel_f_Zn, rel_p_Zn)

SalmonR_Zn_with_rel <- SalmonR_Zn %>%
  left_join(rel_data_to_join, by = "SamplingEventID")

#view(SalmonR_Zn_with_rel)

```

```{r}
# Extend the data to have a fake continuous x axis with fake data

# Create full sequence from 0 to 22.5 by 0.05
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

# Join original df with the full sequence
Zn_df_expanded <- full_sequence %>%
  left_join(Zn_rel_data, by = "Rel_Water_Area_plotting")

Zn_rel_data_to_plot <- Zn_df_expanded %>%
  dplyr::select(-c(u_Zn_mcg_per_l, f_Zn_mcg_per_l, p_Zn_mcg_per_l, ref_u_Zn, ref_f_Zn, ref_p_Zn)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Zn_Anaktok_salmon <- Zn_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(u_Zn_mcg_per_l, f_Zn_mcg_per_l, p_Zn_mcg_per_l, ref_u_Zn, ref_f_Zn, ref_p_Zn)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

# Replace the existing row with the one from Anaktok_salmon
Zn_rel_data_to_plot <- Zn_rel_data_to_plot %>%
  rows_update(Zn_Anaktok_salmon, by = "Rel_Water_Area_plotting")

#view(Zn_rel_data_to_plot)

```

Manually add data values to relative data to control more of how the NA values are interpolated
```{r}
## Use this if values need to be set manually prior to filling the missing values

Zn_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(4.35, 4.7, 5.6, 6.2, 6.3, 7.2, 7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12),
  rel_u_Zn = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
  rel_f_Zn = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
  rel_p_Zn = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
) %>%
  mutate(across(everything(), as.numeric))

Zn_rel_data_mod <- Zn_rel_data_to_plot %>%
  rows_update(Zn_mod_data, by = "Rel_Water_Area_plotting")

#view(Zn_rel_data_mod)
```

Linear interpolation using na.approx
```{r}
## use this if any values need to be manually changed for the way the plot looks

# Manually change the highest value
Zn_rel_data_mod2 <- Zn_rel_data_mod %>%
  mutate(rel_f_Zn = case_when(
    Rel_Water_Area_plotting == 4.75 ~ 25,
    TRUE ~ rel_f_Zn  # keep original value if no match
  ))
```

```{r}
# Apply linear interpolation to all numeric columns except Rel_Water_Area_plotting
Zn_rel_data_to_plot_interp <- Zn_rel_data_mod2 %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

# Make the values before the first tributary 0 (adjust column indices if needed)
Zn_rel_data_to_plot_interp[1:75, 6:8] <- 0

# keep only values greater than 1 to plot
f_Zn_rel_data_to_plot_interp <- Zn_rel_data_to_plot_interp %>%
  filter(rel_f_Zn >= 1.01)

p_Zn_rel_data_to_plot_interp <- Zn_rel_data_to_plot_interp %>%
  filter(rel_p_Zn >= 1.01)

#view(rel_data_to_plot_interp)

```

### Trib heat plots
```{r}
# Heatmap for filtered Zn
f_Zn_heat <- ggplot(f_Zn_rel_data_to_plot_interp, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Zn)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(
    title = NULL,
    x = NULL,
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    legend.position = "none",
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.title = element_blank(),
    axis.ticks.length.x = unit(0.1, "cm")  # make tick marks shorter
  )

f_Zn_heat

# Heatmap for particulate Zn
p_Zn_heat <- ggplot(p_Zn_rel_data_to_plot_interp, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_p_Zn)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "#301934") +
  labs(
    title = NULL,
    x = NULL,
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.position = "none",
    legend.margin = margin(2, 2, 0, 2),
    plot.margin = margin(0, 1, 1, 1),
    legend.title = element_blank(),
    axis.ticks.length.x = unit(0.1, "cm")  # make tick marks shorter
  )

p_Zn_heat
```

```{r}
f_Zn_heat_legend <- ggpubr::get_legend(f_Zn_heat)

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/f_Zn heat legend.png",cowplot::ggdraw(f_Zn_heat_legend), width = 4, height = 2, dpi = 300)

p_Zn_heat_legend <- ggpubr::get_legend(p_Zn_heat)

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/p_Zn heat legend.png",cowplot::ggdraw(p_Zn_heat_legend), width = 4, height = 2, dpi = 300)
```

```{r}
# Combine Zn heatmaps
Salmon_Zn_combined <- p_Zn_heat / f_Zn_heat
Salmon_Zn_combined

# Save final plot
#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Zn trib heat plots with legend.png", Salmon_Zn_combined, width = 5, height = 2.5, dpi = 300)
```

### Area plot
```{r}
#Zn_breaks <- c(0.01, 0.1, 1, 10, 100, 1000, 10000, 100000)

SalmonR_Zn_area <- ggplot() +
  # area plots
  geom_area(data = MS_u_Zn_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            #fill = "#28968b"
            fill = "grey30",
            #alpha = 0.85
            ) +
  
  geom_line(data = MS_u_Zn_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), color = "grey28", linewidth = 0.5) +
  
  geom_area(data = MS_f_Zn_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            #fill = "#c9f1e4") + # light blue/green for filtered
            fill = "#2daa9e") + # darker green for filtered paired with grey for particulate
            #fill = "#caf1ed",
  
  geom_line(data = MS_f_Zn_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), color = "#1d6e66", linewidth = 0.4) +
    # Mainstem point for filtered data
  geom_point(data = MS_f_Zn_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 19, color = "black", 
           size = 2) +
  
  # mainstem point for unfiltered data
geom_point(data = MS_u_Zn_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), pch = 19, 
           color = "black",
           size = 2) +
  
  # lines for locations of sampled tributaries
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11), linetype = "dashed", color = "grey15", linewidth = 0.5) +
  
  coord_cartesian(x = c(1,22.5), y = c(1,300)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.035, 0.015))) +
  #scale_y_continuous(breaks = c(0,25,50,75,100,125,150,175,200,225), labels = c(0,"",50,"",100,"",150,"",200,""), expand = expansion(mult = c(0.01, 0.02))) +
  # scale_y_log10(breaks = c(0.1,1,10,100), labels = scales::comma, expand = expansion(mult = c(0.02,0.02))) +
  scale_y_log10(
    breaks = breaks,
    labels = parse(text = labels),
    expand = expansion(mult = c(0.02, 0.02)),
    sec.axis = dup_axis()
  ) +
  annotation_logticks(sides = "lr") +
  labs(
    x = NULL,
    y = NULL,
    title = NULL
    #x = "Relative Water Area",
    #y = "Zn (ug/L)",
    #title = "Unfiltered and Filtered"
  ) +
  theme_minimal() +
  theme(
    #axis.text.y.left = element_blank(),
    axis.text.y.right = element_blank()
  ) +
  DA_theme

SalmonR_Zn_area

#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Zn area.png", SalmonR_Zn_area, width = 3.6, height = 2.1, dpi = 300)
```

## combo
```{r}
# Final Zn composite plot
SalmonR_Zn_area_combo <- (
  Salmon_Zn_combined / SalmonR_Zn_area +
  plot_layout(ncol = 1, nrow = 3, heights = c(1, 1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA),
    legend.position = "none",
    legend.text = element_text(size = 8),       # smaller legend labels
    legend.title = element_text(size = 9),      # smaller legend title
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
    legend.spacing = unit(0.1, "cm") # smaller boxes
  )

SalmonR_Zn_area_combo

# Save final plot
ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Zn area plus heat plot_with labels.png",SalmonR_Zn_area_combo, width = 3.6, height = 2.1, dpi = 300)

```

# Al
```{r}
## Al
SalmonR_Al <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting, u_Al_mcg_per_l, f_Al_mcg_per_l, p_Al_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

view(SalmonR_Al)
```

```{r}
SalmonR_MS_Al_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Al_mcg_per_l, u_Al_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Al_mcg_per_l, u_Al_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Al_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

# Split by type
MS_f_Al_area <- SalmonR_MS_Al_area %>%
  filter(Metal_type == "f")

MS_u_Al_area <- SalmonR_MS_Al_area %>%
  filter(Metal_type == "u")

```

```{r}
SalmonR_trib_Al_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Al_mcg_per_l, u_Al_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Al_mcg_per_l, u_Al_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Al_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

# Split by type
trib_f_Al_area <- SalmonR_trib_Al_area %>%
  filter(Metal_type == "f")

trib_u_Al_area <- SalmonR_trib_Al_area %>%
  filter(Metal_type == "u")

```

```{r}
SalmonR_Al_area <- ggplot() +
  # area plots
  geom_area(data = MS_u_Al_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#28968b") +
  
  geom_line(data = MS_u_Al_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), 
            color = "#1d6e66", linewidth = 0.5) +
  
  geom_area(data = MS_f_Al_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#c9f1e4") +
  
  geom_line(data = MS_f_Al_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), 
            color = "#1d6e66", linewidth = 0.4) +
  
  # lines for locations of sampled tributaries
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
  coord_cartesian(x = c(1,22.5), y = c(1,4000)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.02, 0.01))) +
  scale_y_log10(breaks = c(0.01,0.1,1,10,100,1000), labels = scales::comma, expand = expansion(mult = c(0.02, 0.02))) +
  annotation_logticks(sides = "l") +
  labs(
    x = "Relative Water Area",
    y = "Al (µg/L)",
    title = "Unfiltered and Filtered"
  ) +
  theme_minimal() +
  DA_theme

SalmonR_Al_area

```

# Ni
```{r}
## Ni
SalmonR_Ni <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting, u_Ni_mcg_per_l, f_Ni_mcg_per_l, p_Ni_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

view(SalmonR_Ni)
```

### modifications
```{r}
# Calculate tributary metal concentrations relative to the nearest upstream MS sample concentration for heat plot

# Step 1: A reference map for each row that needs normalization
ref_map <- tibble(
  SamplingEventID = c(
  "SalmonR_Trib1_20230722_1745",
  "SalmonR_Trib2_20230722_1911",
  "SheepC_1_20230719_0923",
  "Anaktok_1_20230723_1945",
  "SalmonR_Trib3_20230724_1140",
  "SalmonR_Trib4_20230724_1155",
  "SalmonR_Trib5_20230724_1311",
  "SalmonR_Trib6_20230724_1428",
  "SalmonR_Trib7_20230724_1453"
),
  RefID = c(
  "SalmonR_MS_above_Trib1_20230722_1753",
  "SalmonR_MS_above_Trib2_20230722_1915",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_at_SheepC_20230719_0927",
  "SalmonR_MS_above_Trib6_20230724_1439",
  "SalmonR_MS_above_Trib6_20230724_1439"
)
)

# Step 2: Join and calculate relative Ni
Ni_rel_data <- SalmonR_Ni %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(SalmonR_Ni %>%
              dplyr::select(RefID = SamplingEventID, 
                            ref_u_Ni = u_Ni_mcg_per_l,
                            ref_f_Ni = f_Ni_mcg_per_l,
                            ref_p_Ni = p_Ni_mcg_per_l),
            by = "RefID") %>%
  # change 0 values in ref_p_Ni column to 0.01 * 0.7071 (detection limit times sqrt2/2)
  mutate(across(
    .cols = c(ref_p_Ni),
    .fns = ~ ifelse(. == 0, 0.007071, .)
  )) %>%
  mutate(
    rel_u_Ni = u_Ni_mcg_per_l / ref_u_Ni,
    rel_f_Ni = f_Ni_mcg_per_l / ref_f_Ni,
    rel_p_Ni = p_Ni_mcg_per_l / ref_p_Ni
  )

#view(Ni_rel_data)

# Replace values < 1 with 0
# rel_data_mod <- rel_data %>%
#   mutate(across(
#     .cols = c(rel_u_Ni, rel_f_Ni, rel_p_Ni),
#     .fns = ~ ifelse(. < 1, 0, .)
#   ))

#view(rel_data_mod)
```

```{r}
#join the relative concentrations to the main data
Ni_rel_data_to_join <- Ni_rel_data %>%
  dplyr::select(SamplingEventID, rel_u_Ni, rel_f_Ni, rel_p_Ni)

SalmonR_Ni_with_rel <- SalmonR_Ni %>%
  left_join(Ni_rel_data_to_join, by = "SamplingEventID")

#view(SalmonR_Ni_with_rel)
```

```{r}
# Create full sequence for interpolation
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

# Join with relative data
df_expanded <- full_sequence %>%
  left_join(Ni_rel_data, by = "Rel_Water_Area_plotting")

Ni_rel_data_to_plot <- df_expanded %>%
  dplyr::select(-c(u_Ni_mcg_per_l, f_Ni_mcg_per_l, p_Ni_mcg_per_l, ref_u_Ni, ref_f_Ni, ref_p_Ni)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Ni_Anaktok_salmon <- Ni_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(u_Ni_mcg_per_l, f_Ni_mcg_per_l, p_Ni_mcg_per_l, ref_u_Ni, ref_f_Ni, ref_p_Ni)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Ni_rel_data_to_plot <- Ni_rel_data_to_plot %>%
  rows_update(Ni_Anaktok_salmon, by = "Rel_Water_Area_plotting")

#view(Ni_rel_data_to_plot)
```

Manually add data values to relative data to control more of how the NA values are interpolated
```{r}
Ni_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(4.35, 4.7, 5.6, 6.2, 6.3, 7.2, 7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12),
  rel_u_Ni = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
  rel_f_Ni = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
  rel_p_Ni = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
) %>%
  mutate(across(everything(), as.numeric))

Ni_rel_data_mod <- Ni_rel_data_to_plot %>%
  rows_update(Ni_mod_data, by = "Rel_Water_Area_plotting")

#view(Ni_rel_data_mod)
```

Linear interpolation using na.approx
```{r}
# manually change the highest values for particulate Ni so that color differences on the lower end are visible
Ni_rel_data_mod2 <- Ni_rel_data_mod %>%
  mutate(rel_p_Ni = case_when(
    Rel_Water_Area_plotting == 6.25  ~ 60,
    Rel_Water_Area_plotting == 8  ~ 30,
    TRUE ~ rel_p_Ni  # keep original value if no match
  ))

# Apply linear interpolation to all numeric columns except Rel_Water_Area_plotting
Ni_rel_data_to_plot_interp <- Ni_rel_data_mod2 %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

# make the values before the first tributary 0 
Ni_rel_data_to_plot_interp[1:75, 6:8] <- 0

# keep only values greater than 1 to plot
f_Ni_rel_data_to_plot_interp <- Ni_rel_data_to_plot_interp %>%
  filter(rel_f_Ni >= 1.01)

p_Ni_rel_data_to_plot_interp <- Ni_rel_data_to_plot_interp %>%
  filter(rel_p_Ni >= 1.01)

#view(Ni_rel_data_to_plot_interp)
```

Mainstem Df
```{r}
SalmonR_MS_Ni_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Ni_mcg_per_l, u_Ni_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Ni_mcg_per_l, u_Ni_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Ni_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

# Split by type
MS_f_Ni_area <- SalmonR_MS_Ni_area %>%
  filter(Metal_type == "f")

MS_u_Ni_area <- SalmonR_MS_Ni_area %>%
  filter(Metal_type == "u")

```

Tributary MS
```{r}
SalmonR_trib_Ni_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Ni_mcg_per_l, u_Ni_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Ni_mcg_per_l, u_Ni_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Ni_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

# Split by type
trib_f_Ni_area <- SalmonR_trib_Ni_area %>%
  filter(Metal_type == "f")

trib_u_Ni_area <- SalmonR_trib_Ni_area %>%
  filter(Metal_type == "u")

```

### Trib heat plots
```{r}
f_Ni_heat <- ggplot(f_Ni_rel_data_to_plot_interp, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Ni)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(
    title = NULL,
    x = NULL,
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(
    breaks = DA_x_breaks,
    labels = DA_x_labels,
    expand = expansion(mult = c(0.035, 0.015))
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.position = "none",
    legend.title = element_blank(),
    axis.ticks.length.x = unit(0.1, "cm")  # make tick marks shorter
  )

f_Ni_heat

p_Ni_heat <- ggplot(p_Ni_rel_data_to_plot_interp, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_p_Ni)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "#301934") +
  labs(
    title = NULL,
    x = NULL,
    y = NULL,
    fill = "Tributary:Mainstem"
  ) +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(
    breaks = DA_x_breaks,
    labels = DA_x_labels,
    expand = expansion(mult = c(0.035, 0.015))
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.position = "none",
    legend.margin = margin(2, 2, 0, 2),
    plot.margin = margin(0, 1, 1, 1),
    legend.title = element_blank()
  )

p_Ni_heat

Salmon_Ni_combined <- p_Ni_heat / f_Ni_heat
Salmon_Ni_combined

```

```{r}
f_Ni_heat_legend <- ggpubr::get_legend(f_Ni_heat)

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/f_Ni heat legend.png",
       cowplot::ggdraw(f_Ni_heat_legend), width = 4, height = 2, dpi = 300)

p_Ni_heat_legend <- ggpubr::get_legend(p_Ni_heat)

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/p_Ni heat legend.png",
       cowplot::ggdraw(p_Ni_heat_legend), width = 4, height = 2, dpi = 300)

```

### area plot
```{r}
library(ggplot2)
library(scales)

SalmonR_Ni_area <- ggplot() +

  geom_area(data = MS_u_Ni_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            #fill = "#28968b"
            fill = "grey30"
            #alpha = 0.85
            ) +
  
  geom_line(data = MS_u_Ni_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), color = "grey28", linewidth = 0.5) +
  
  geom_area(data = MS_f_Ni_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            #fill = "#c9f1e4") + # light blue/green for filtered
            fill = "#2daa9e") + # darker green for filtered paired with grey for particulate
  geom_line(data = MS_f_Ni_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), color = "#1d6e66", linewidth = 0.4) +
  
  # Mainstem point for filtered data
  geom_point(data = MS_f_Ni_long, aes(x = Rel_Water_Area_plotting, y = Metal_conc_plot), pch = 19, color = "black", 
           size = 2) +
  
  # mainstem point for unfiltered data
geom_point(data = MS_u_Ni_area, aes(x = Rel_Water_Area_plotting, y = Metal_conc), pch = 19, 
           color = "black",
           size = 2) +
  
  # lines for locations of sampled tributaries
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11), linetype = "dashed", color = "grey15", linewidth = 0.5) +
  
  coord_cartesian(x = c(1, 22.5), y = c(0, 200)) +
  scale_x_continuous(
    breaks = DA_x_breaks, labels = DA_x_labels, 
    expand = expansion(mult = c(0.035, 0.015))
  ) +
  # scale_y_continuous(
  #   trans = pseudo_log_trans(base = 10),
  #   breaks = c(0,1,10,100),
  #   labels = c(0,1,10,100),
  #   expand = expansion(mult = c(0.02,0.02))) +
    #sec.axis = dup_axis(name = NULL, labels = NULL) 
  annotation_logticks(sides = "lr") +
  labs(
    #x = "Relative Watershed Area",
    #y = "Metal Concentration",
    x = NULL,
    y = NULL,
    title = NULL
    #title = "Fe Area Plot - Unfiltered and Filtered"
  ) +
  theme_minimal() +
  DA_theme +
  theme(
    axis.text.y = element_blank(),
    axis.text.y.right = element_blank()
  )

SalmonR_Ni_area
```

## combo
```{r}
SalmonR_Ni_area_combo <- (
  Salmon_Ni_combined / SalmonR_Ni_area +
    plot_layout(ncol = 1, nrow = 3, heights = c(1, 1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA),
    legend.position = "none",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9),
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
    legend.spacing = unit(0.1, "cm")
  )

SalmonR_Ni_area_combo

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Ni area plus heat plot_no labels.png",
       SalmonR_Ni_area_combo, width = 3.6, height = 2.1, dpi = 300)
```

# Cd
## modifications
```{r}
SalmonR_Cd <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting, u_Cd_mcg_per_l, f_Cd_mcg_per_l, p_Cd_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

#view(SalmonR_Cd)
```

```{r}
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745", "SalmonR_Trib2_20230722_1911", "SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945", "SalmonR_Trib3_20230724_1140", "SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311", "SalmonR_Trib6_20230724_1428", "SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753", "SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927", "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927", "SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927", "SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

Cd_rel_data <- SalmonR_Cd %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(SalmonR_Cd %>%
              dplyr::select(RefID = SamplingEventID, 
                            ref_u_Cd = u_Cd_mcg_per_l,
                            ref_f_Cd = f_Cd_mcg_per_l,
                            ref_p_Cd = p_Cd_mcg_per_l),
            by = "RefID") %>%
  # change 0 p_Cd values to sqrt2/2 of 0.01 (Cd detection limit)
  mutate(across(
    .cols = c(p_Cd_mcg_per_l),
    .fns = ~ ifelse(. == 0, 0.007071, .)
  )) %>%
  mutate(
    rel_u_Cd = u_Cd_mcg_per_l / ref_u_Cd,
    rel_f_Cd = f_Cd_mcg_per_l / ref_f_Cd,
    rel_p_Cd = p_Cd_mcg_per_l / ref_p_Cd
  )

# # remove all values that are less than 1
# rel_data_mod <- rel_data %>%
#   mutate(across(
#     .cols = c(rel_u_Cd, rel_f_Cd, rel_p_Cd),
#     .fns = ~ ifelse(. < 1, 0, .)
#   ))

#view(Cd_rel_data)

```

```{r}
Cd_rel_data_to_join <- Cd_rel_data %>%
  dplyr::select(SamplingEventID, rel_u_Cd, rel_f_Cd, rel_p_Cd)

SalmonR_Cd_with_rel <- SalmonR_Cd %>%
  left_join(Cd_rel_data_to_join, by = "SamplingEventID")
```

```{r}
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

Cd_df_expanded <- full_sequence %>%
  left_join(Cd_rel_data, by = "Rel_Water_Area_plotting")

Cd_rel_data_to_plot <- Cd_df_expanded %>%
  dplyr::select(-c(u_Cd_mcg_per_l, f_Cd_mcg_per_l, p_Cd_mcg_per_l, ref_u_Cd, ref_f_Cd, ref_p_Cd)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Cd_Anaktok_salmon <- Cd_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(u_Cd_mcg_per_l, f_Cd_mcg_per_l, p_Cd_mcg_per_l, ref_u_Cd, ref_f_Cd, ref_p_Cd)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Cd_rel_data_to_plot <- Cd_rel_data_to_plot %>%
  rows_update(Cd_Anaktok_salmon, by = "Rel_Water_Area_plotting")

```

```{r}
Cd_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(4.35, 4.7, 5.6, 6.2, 6.3, 7.2, 7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12),
  rel_u_Cd = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
  rel_f_Cd = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
  rel_p_Cd = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
) %>%
  mutate(across(everything(), as.numeric))

Cd_rel_data_mod <- Cd_rel_data_to_plot %>%
  rows_update(Cd_mod_data, by = "Rel_Water_Area_plotting")
```

```{r}
Cd_rel_data_to_plot_interp <- Cd_rel_data_mod %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

Cd_rel_data_to_plot_interp[1:75, 6:8] <- 0

# keep only values greater than 1 to plot
f_Cd_rel_data_to_plot_interp <- Cd_rel_data_to_plot_interp %>%  filter(rel_f_Cd >= 1.01)
p_Cd_rel_data_to_plot_interp <- Cd_rel_data_to_plot_interp %>%  filter(rel_p_Cd >= 1.01)

```

Mainstem DF
```{r}
SalmonR_MS_Cd_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Cd_mcg_per_l, u_Cd_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Cd_mcg_per_l, u_Cd_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Cd_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

MS_f_Cd_area <- SalmonR_MS_Cd_area %>% filter(Metal_type == "f")
MS_u_Cd_area <- SalmonR_MS_Cd_area %>% filter(Metal_type == "u")

```

Tributary DF
```{r}
SalmonR_trib_Cd_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Cd_mcg_per_l, u_Cd_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Cd_mcg_per_l, u_Cd_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Cd_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

trib_f_Cd_area <- SalmonR_trib_Cd_area %>% filter(Metal_type == "f")
trib_u_Cd_area <- SalmonR_trib_Cd_area %>% filter(Metal_type == "u")

```

## trib heat plots
```{r}
f_Cd_heat <- ggplot(f_Cd_rel_data_to_plot_interp, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Cd)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() +
  DA_theme +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(),
        panel.grid = element_blank(), axis.text.x = element_blank(), legend.position = "top",
        legend.title = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm")  # make tick marks shorter
)

f_Cd_heat

p_Cd_heat <- ggplot(p_Cd_rel_data_to_plot_interp, aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_p_Cd)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "#301934") +
  labs(x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() +
  DA_theme +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(), panel.grid = element_blank(),
        axis.text.x = element_blank(), legend.position = "top",
        legend.margin = margin(2, 2, 0, 2), plot.margin = margin(0, 1, 1, 1),
        legend.title = element_blank())

p_Cd_heat

Salmon_Cd_combined <- p_Cd_heat / f_Cd_heat
Salmon_Cd_combined

```

```{r}
f_Cd_heat_legend <- ggpubr::get_legend(f_Cd_heat)

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/f_Cd heat legend.png",
       cowplot::ggdraw(f_Cd_heat_legend), width = 4, height = 2, dpi = 300)

p_Cd_heat_legend <- ggpubr::get_legend(p_Cd_heat)

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/p_Cd heat legend.png",
       cowplot::ggdraw(p_Cd_heat_legend), width = 4, height = 2, dpi = 300)

```

## Area plots
```{r}
SalmonR_Cd_area <- ggplot() +
  geom_line(data = MS_f_Cd_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc), 
            color = "#1d6e66", linewidth = 0.4) +
  
  # area plots
  geom_area(data = MS_u_Cd_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "grey30") +

  geom_line(data = MS_u_Cd_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc), 
            color = "grey28", linewidth = 0.5) +

  geom_area(data = MS_f_Cd_area, 
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#2daa9e") +

  # Mainstem points (check if Fe should be Ni)
  geom_point(
    data = MS_f_Cd_area,  # changed to Ni
    aes(x = Rel_Water_Area_plotting, y = Metal_conc),
    pch = 19, color = "black", size = 2
  ) +
  geom_point(
    data = MS_u_Cd_area,  # changed to Ni
    aes(x = Rel_Water_Area_plotting, y = Metal_conc),
    pch = 19, color = "black", size = 2
  ) +
  
  


  # tributary lines
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11), 
             linetype = "dashed", color = "grey15", linewidth = 0.5) +

  coord_cartesian(x = c(1, 22.5), y = c(0, 5.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels, 
                     expand = expansion(mult = c(0.035, 0.015))) +
  scale_y_continuous(breaks = c(0.001, 1, 2, 3, 4, 5, 6), labels = c(0, 1, 2, 3, 4, 5, 6), sec.axis = dup_axis()) +
  labs(
    x = NULL,
    y = NULL,
    title = NULL
  ) +
  theme_minimal() +
  theme(
    axis.text.y.left = element_blank(),
    axis.text.y.right = element_blank(),
    axis.ticks.length.y.right = unit(-0.1, "cm")  # make ticks point inside
  ) +
  DA_theme

SalmonR_Cd_area
```

## combo
```{r}
SalmonR_Cd_area_combo <- (
  Salmon_Cd_combined / SalmonR_Cd_area +
    plot_layout(ncol = 1, nrow = 3, heights = c(1, 1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA),
    legend.position = "none",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9),
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
    legend.spacing = unit(0.1, "cm")
  )

SalmonR_Cd_area_combo

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Cd area plus heat plot_no labels.png",
       SalmonR_Cd_area_combo, width = 3.575, height = 2.1, dpi = 300)
```


# Cu
## Data frames
```{r}
SalmonR_Cu <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting,
                u_Cu_mcg_per_l, f_Cu_mcg_per_l, p_Cu_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))
# view(SalmonR_Cu)
```

Mainstem DF
```{r}
SalmonR_MS_Cu_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Cu_mcg_per_l, u_Cu_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Cu_mcg_per_l, u_Cu_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Cu_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

MS_f_Cu_area <- SalmonR_MS_Cu_area %>% filter(Metal_type == "f")
MS_u_Cu_area <- SalmonR_MS_Cu_area %>% filter(Metal_type == "u")

```

Tributary DF
```{r}
SalmonR_trib_Cu_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Cu_mcg_per_l, u_Cu_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Cu_mcg_per_l, u_Cu_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Cu_mcg_per_l",   # fixed from Fe → Cu
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

trib_f_Cu_area <- SalmonR_trib_Cu_area %>% filter(Metal_type == "f")
trib_u_Cu_area <- SalmonR_trib_Cu_area %>% filter(Metal_type == "u")

```

Modifications for heat plots
```{r}
# Step 1: map tributary sample to nearest upstream MS reference
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745","SalmonR_Trib2_20230722_1911","SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945","SalmonR_Trib3_20230724_1140","SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311","SalmonR_Trib6_20230724_1428","SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753","SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

# Step 2: compute tributary:mainstem ratios
Cu_rel_data <- SalmonR_Cu %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(
    SalmonR_Cu %>%
      dplyr::select(RefID = SamplingEventID,
                    ref_u_Cu = u_Cu_mcg_per_l,
                    ref_f_Cu = f_Cu_mcg_per_l,
                    ref_p_Cu = p_Cu_mcg_per_l),
    by = "RefID"
  ) %>%
  mutate(
    rel_u_Cu = u_Cu_mcg_per_l / ref_u_Cu,
    rel_f_Cu = f_Cu_mcg_per_l / ref_f_Cu,
    rel_p_Cu = p_Cu_mcg_per_l / ref_p_Cu
  )

view(Cu_rel_data)

#should have 9 rows
```

```{r}
# Join relative concentrations back to the main Cu data
Cu_rel_data_to_join <- Cu_rel_data %>%
  dplyr::select(SamplingEventID, rel_u_Cu, rel_f_Cu, rel_p_Cu)

SalmonR_Cu_with_rel <- SalmonR_Cu %>%
  left_join(Cu_rel_data_to_join, by = "SamplingEventID")

view(SalmonR_Cu_with_rel)

# should have 19 rows
```

```{r}
# Create a dense x-axis and align values
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

Cu_df_expanded <- full_sequence %>%
  left_join(Cu_rel_data, by = "Rel_Water_Area_plotting")

Cu_rel_data_to_plot <- Cu_df_expanded %>%
  dplyr::select(-c(u_Cu_mcg_per_l, f_Cu_mcg_per_l, p_Cu_mcg_per_l,
                   ref_u_Cu, ref_f_Cu, ref_p_Cu)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Cu_Anaktok_salmon <- Cu_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(u_Cu_mcg_per_l, f_Cu_mcg_per_l, p_Cu_mcg_per_l,
                   ref_u_Cu, ref_f_Cu, ref_p_Cu)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Cu_rel_data_to_plot <- Cu_rel_data_to_plot %>%
  rows_update(Cu_Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(Cu_rel_data_to_plot)

```

Manual tweaks
```{r}
# set specific locations to 0 so that the values are 0 before the next tributary
Cu_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(4.35, 4.7, 5.6, 6.2, 6.3, 7.2, 7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12),
  rel_u_Cu = 0, rel_f_Cu = 0, rel_p_Cu = 0
) %>% mutate(across(everything(), as.numeric))

Cu_rel_data_mod <- Cu_rel_data_to_plot %>%
  rows_update(Cu_mod_data, by = "Rel_Water_Area_plotting")


# Optional single-point override for aesthetic control (ctrl+shift+c to un hide the lines)
Cu_rel_data_mod2 <- Cu_rel_data_mod %>%
  mutate(rel_f_Cu = dplyr::case_when(
    Rel_Water_Area_plotting == 4.75 ~ 15,
    TRUE ~ rel_f_Cu
  ))

# check what value was there before manually changing it to manually set the legend
f_Cu_val_4.75 <- Cu_rel_data_to_plot %>%
  filter(Rel_Water_Area_plotting == 4.75) %>%
  pull(rel_f_Cu)

p_Cu_high_val <- Cu_rel_data_to_plot %>%
  filter(Rel_Water_Area_plotting == 11.00) %>%
  pull(rel_p_Cu)

print(f_Cu_val_4.75)
print(p_Cu_high_val)
```

Interpolation and filtering
```{r}
Cu_rel_data_to_plot_interp <- Cu_rel_data_mod2 %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

# Zero out region before first tributary (adjust indices if your sequence changes)
Cu_rel_data_to_plot_interp[1:75, 6:8] <- 0

# Keep only >1 for heatmaps
f_Cu_rel_data_to_plot_interp <- Cu_rel_data_to_plot_interp %>% filter(rel_f_Cu >= 1.01)
p_Cu_rel_data_to_plot_interp <- Cu_rel_data_to_plot_interp %>% filter(rel_p_Cu >= 1.01)

```

## Trib heat plots
```{r}
# Filtered Cu heat
f_Cu_heat <- ggplot(f_Cu_rel_data_to_plot_interp,
                    aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Cu)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() + DA_theme +
  theme(axis.text.y = element_blank(),
        legend.position = "none",
        axis.ticks.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.title = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm"))

# Particulate Cu heat
p_Cu_heat <- ggplot(p_Cu_rel_data_to_plot_interp,
                    aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_p_Cu)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "#301934") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() + DA_theme +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "none",
        legend.margin = margin(2, 2, 0, 2),
        plot.margin = margin(0, 1, 1, 1),
        legend.title = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm"))

# Legends (optional saves)
# f_Cu_heat_legend <- ggpubr::get_legend(f_Cu_heat)
# ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/f_Cu heat legend.png", cowplot::ggdraw(f_Cu_heat_legend), width=1.5, height=1, dpi=300)
# 
# p_Cu_heat_legend <- ggpubr::get_legend(p_Cu_heat)
# ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/p_Cu heat legend.png", cowplot::ggdraw(p_Cu_heat_legend), width=1.5, height=1, dpi=300)

# Combine Cu heatmaps
Salmon_Cu_combined <- p_Cu_heat / f_Cu_heat
Salmon_Cu_combined

```

## Area plot
```{r}
SalmonR_Cu_area <- ggplot() +
  geom_area(data = MS_u_Cu_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "grey30") +
  geom_line(data = MS_u_Cu_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            color = "grey28", linewidth = 0.5) +
  geom_area(data = MS_f_Cu_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#2daa9e") +
  geom_line(data = MS_f_Cu_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            color = "#1d6e66", linewidth = 0.4) +
  # If you have MS_f_Cu_long like the Zn version, update the name; otherwise remove this layer
  geom_point(data = MS_f_Cu_area,
             aes(x = Rel_Water_Area_plotting, y = Metal_conc),
             pch = 19, color = "black", size = 2) +
  geom_point(data = MS_u_Cu_area,
             aes(x = Rel_Water_Area_plotting, y = Metal_conc),
             pch = 19, color = "black", size = 2) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
  coord_cartesian(x = c(1,22.5), y = c(0,23)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  scale_y_continuous(breaks = c(0,2.5,5,7.5,10,12.5,15,17.5,20,22.5,25), labels = c(0, "",5,"",10,"",15,"",20,"",25), sec.axis = dup_axis(), expand = expansion(mult = c(0.02, 0.02))) +
  # scale_y_log10(
  #   breaks = breaks,
  #   labels = parse(text = labels),
  #   expand = expansion(mult = c(0.02, 0.02)),
  #   sec.axis = dup_axis()
  # ) +
  #annotation_logticks(sides = "lr") +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  theme(axis.text.y.right = element_blank(),
        axis.text.y.left = element_blank()) +
  DA_theme

SalmonR_Cu_area
#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Cu area.png", SalmonR_Cu_area, width = 3.6, height = 2.1, dpi = 300)

```

## Combo
```{r}
SalmonR_Cu_area_combo <- (
  Salmon_Cu_combined / SalmonR_Cu_area +
  plot_layout(ncol = 1, nrow = 3, heights = c(1, 1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA),
    legend.position = "none",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9),
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
    legend.spacing = unit(0.1, "cm")
  )

SalmonR_Cu_area_combo
ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Cu area plus heat plot_with labels.png",SalmonR_Cu_area_combo, width = 3.6, height = 2.1, dpi = 300)

```

# Mn
## Data frames
```{r}
SalmonR_Mn <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting,
                u_Mn_mcg_per_l, f_Mn_mcg_per_l, p_Mn_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

SalmonR_Mn <- SalmonR_Mn %>%
  mutate(p_Mn_mcg_per_l = if_else(
    p_Mn_mcg_per_l == 0.000,
    (sqrt(2) / 2) * 0.1,
    p_Mn_mcg_per_l
  ))

# view(SalmonR_Mn)
```

Mainstem DF
```{r}
SalmonR_MS_Mn_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Mn_mcg_per_l, u_Mn_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Mn_mcg_per_l, u_Mn_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Mn_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

MS_f_Mn_area <- SalmonR_MS_Mn_area %>% filter(Metal_type == "f")
MS_u_Mn_area <- SalmonR_MS_Mn_area %>% filter(Metal_type == "u")

```

Tributary DF
```{r}
SalmonR_trib_Mn_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Mn_mcg_per_l, u_Mn_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Mn_mcg_per_l, u_Mn_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Mn_mcg_per_l",   # fixed from Fe → Cu
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

trib_f_Mn_area <- SalmonR_trib_Mn_area %>% filter(Metal_type == "f")
trib_u_Mn_area <- SalmonR_trib_Mn_area %>% filter(Metal_type == "u")

```

Modifications for heat plots
```{r}
# Step 1: map tributary sample to nearest upstream MS reference
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745","SalmonR_Trib2_20230722_1911","SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945","SalmonR_Trib3_20230724_1140","SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311","SalmonR_Trib6_20230724_1428","SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753","SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

# Step 2: compute tributary:mainstem ratios
Mn_rel_data <- SalmonR_Mn %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(
    SalmonR_Mn %>%
      dplyr::select(RefID = SamplingEventID,
                    ref_u_Mn = u_Mn_mcg_per_l,
                    ref_f_Mn = f_Mn_mcg_per_l,
                    ref_p_Mn = p_Mn_mcg_per_l),
    by = "RefID"
  ) %>%
  mutate(
    rel_u_Mn = u_Mn_mcg_per_l / ref_u_Mn,
    rel_f_Mn = f_Mn_mcg_per_l / ref_f_Mn,
    rel_p_Mn = p_Mn_mcg_per_l / ref_p_Mn
  )

view(Mn_rel_data)

#should have 9 rows
```

```{r}
# Join relative concentrations back to the main Cu data
Mn_rel_data_to_join <- Mn_rel_data %>%
  dplyr::select(SamplingEventID, rel_u_Mn, rel_f_Mn, rel_p_Mn)

SalmonR_Mn_with_rel <- SalmonR_Mn %>%
  left_join(Mn_rel_data_to_join, by = "SamplingEventID")

view(SalmonR_Mn_with_rel)

# should have 19 rows
```

```{r}
# Create a dense x-axis and align values
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

Mn_df_expanded <- full_sequence %>%
  left_join(Mn_rel_data, by = "Rel_Water_Area_plotting")

Mn_rel_data_to_plot <- Mn_df_expanded %>%
  dplyr::select(-c(u_Mn_mcg_per_l, f_Mn_mcg_per_l, p_Mn_mcg_per_l,
                   ref_u_Mn, ref_f_Mn, ref_p_Mn)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Mn_Anaktok_salmon <- Mn_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(u_Mn_mcg_per_l, f_Mn_mcg_per_l, p_Mn_mcg_per_l,
                   ref_u_Mn, ref_f_Mn, ref_p_Mn)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Mn_rel_data_to_plot <- Mn_rel_data_to_plot %>%
  rows_update(Mn_Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(Mn_rel_data_to_plot)

```

Manual tweaks
```{r}
# set specific locations to 0 so that the values are 0 before the next tributary
Mn_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(4.35, 4.7, 5.6, 6.2, 6.3, 7.2, 7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12),
  rel_u_Mn = 0, rel_f_Mn = 0, rel_p_Mn = 0
) %>% mutate(across(everything(), as.numeric))

Mn_rel_data_mod <- Mn_rel_data_to_plot %>%
  rows_update(Mn_mod_data, by = "Rel_Water_Area_plotting")


# Optional single-point override for aesthetic control (ctrl+shift+c to un hide the lines)
Mn_rel_data_mod2 <- Mn_rel_data_mod %>%
  mutate(rel_p_Mn = dplyr::case_when(
    Rel_Water_Area_plotting == 6.25 ~ 200,
    TRUE ~ rel_p_Mn
  ))

# check what value was there before manually changing it to manually set the legend
# f_Mn_val_4.75 <- Mn_rel_data_to_plot %>%
#   filter(Rel_Water_Area_plotting == 4.75) %>%
#   pull(rel_f_Mn)
# 
# p_Mn_high_val <- Mn_rel_data_to_plot %>%
#   filter(Rel_Water_Area_plotting == 11.00) %>%
#   pull(rel_p_Mn)
# 
# print(f_Mn_val_4.75)
# print(p_Mn_high_val)

```

Interpolation and filtering
```{r}
Mn_rel_data_to_plot_interp <- Mn_rel_data_mod2 %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

# Zero out region before first tributary (adjust indices if your sequence changes)
Mn_rel_data_to_plot_interp[1:75, 6:8] <- 0

# Keep only >1 for heatmaps
f_Mn_rel_data_to_plot_interp <- Mn_rel_data_to_plot_interp %>% filter(rel_f_Mn >= 1.01)
p_Mn_rel_data_to_plot_interp <- Mn_rel_data_to_plot_interp %>% filter(rel_p_Mn >= 1.01)

```

## Trib heat plots
```{r}
# Filtered Cu heat
f_Mn_heat <- ggplot(f_Mn_rel_data_to_plot_interp,
                    aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Mn)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() + DA_theme +
  theme(axis.text.y = element_blank(),
        legend.position = "none",
        axis.ticks.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.title = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm"))

# Particulate Cu heat
p_Mn_heat <- ggplot(p_Mn_rel_data_to_plot_interp,
                    aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_p_Mn)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "#301934") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() + DA_theme +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "none",
        legend.margin = margin(2, 2, 0, 2),
        plot.margin = margin(0, 1, 1, 1),
        legend.title = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm"))

# Legends (optional saves)
# f_Mn_heat_legend <- ggpubr::get_legend(f_Mn_heat)
# ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/f_Mn heat legend.png", cowplot::ggdraw(f_Mn_heat_legend), width=1.5, height=1, dpi=300)
# 
# p_Mn_heat_legend <- ggpubr::get_legend(p_Mn_heat)
# ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/p_Mn heat legend.png", cowplot::ggdraw(p_Mn_heat_legend), width=1.5, height=1, dpi=300)

# Combine Cu heatmaps
Salmon_Mn_combined <- p_Mn_heat / f_Mn_heat
Salmon_Mn_combined

```

## Area plot
```{r}
SalmonR_Mn_area <- ggplot() +
  geom_area(data = MS_u_Mn_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "grey30") +
  geom_line(data = MS_u_Mn_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            color = "grey28", linewidth = 0.5) +
  geom_area(data = MS_f_Mn_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#2daa9e") +
  geom_line(data = MS_f_Mn_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            color = "#1d6e66", linewidth = 0.4) +
  # If you have MS_f_Cu_long like the Zn version, update the name; otherwise remove this layer
  geom_point(data = MS_f_Mn_area,
             aes(x = Rel_Water_Area_plotting, y = Metal_conc),
             pch = 19, color = "black", size = 2) +
  geom_point(data = MS_u_Mn_area,
             aes(x = Rel_Water_Area_plotting, y = Metal_conc),
             pch = 19, color = "black", size = 2) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
  coord_cartesian(x = c(1,22.5), y = c(1,2000)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  #scale_y_continuous(breaks = c(0,10, 100,1000,1500), labels = c(0, 10,100,1000,1500), sec.axis = dup_axis(), expand = expansion(mult = c(0.02, 0.02))) +
  scale_y_log10(
    breaks = breaks,
    labels = parse(text = labels),
    expand = expansion(mult = c(0.02, 0.02)),
    sec.axis = dup_axis()
  ) +
  annotation_logticks(sides = "lr") +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  theme(axis.text.y.right = element_blank()
        ,axis.text.y.left = element_blank()
        ) +
  DA_theme

SalmonR_Mn_area
#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Mn area.png", SalmonR_Mn_area, width = 3.6, height = 2.1, dpi = 300)

```

## Combo
```{r}
SalmonR_Mn_area_combo <- (
  Salmon_Mn_combined / SalmonR_Mn_area +
  plot_layout(ncol = 1, nrow = 3, heights = c(1, 1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA),
    legend.position = "none",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9),
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
    legend.spacing = unit(0.1, "cm")
  )

SalmonR_Mn_area_combo
ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Mn area plus heat plot_without labels.png", SalmonR_Mn_area_combo, width = 3.6, height = 2.1, dpi = 300)

```

# Al
## Data frames
```{r}
SalmonR_Al <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting,
                u_Al_mcg_per_l, f_Al_mcg_per_l, p_Al_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

# view(SalmonR_Al)

```

Mainstem DF
```{r}
SalmonR_MS_Al_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Al_mcg_per_l, u_Al_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Al_mcg_per_l, u_Al_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Al_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

MS_f_Al_area <- SalmonR_MS_Al_area %>% filter(Metal_type == "f")
MS_u_Al_area <- SalmonR_MS_Al_area %>% filter(Metal_type == "u")

```

Tributary DF
```{r}
SalmonR_trib_Al_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Al_mcg_per_l, u_Al_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Al_mcg_per_l, u_Al_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Al_mcg_per_l",   # fixed from Fe → Cu
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

trib_f_Al_area <- SalmonR_trib_Al_area %>% filter(Metal_type == "f")
trib_u_Al_area <- SalmonR_trib_Al_area %>% filter(Metal_type == "u")
```

Modifications for heat plots
```{r}
# Step 1: map tributary sample to nearest upstream MS reference
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745","SalmonR_Trib2_20230722_1911","SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945","SalmonR_Trib3_20230724_1140","SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311","SalmonR_Trib6_20230724_1428","SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753","SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

# Step 2: compute tributary:mainstem ratios
Al_rel_data <- SalmonR_Al %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(
    SalmonR_Al %>%
      dplyr::select(RefID = SamplingEventID,
                    ref_u_Al = u_Al_mcg_per_l,
                    ref_f_Al = f_Al_mcg_per_l,
                    ref_p_Al = p_Al_mcg_per_l),
    by = "RefID"
  ) %>%
  mutate(
    rel_u_Al = u_Al_mcg_per_l / ref_u_Al,
    rel_f_Al = f_Al_mcg_per_l / ref_f_Al,
    rel_p_Al = p_Al_mcg_per_l / ref_p_Al
  )

view(Al_rel_data)

#should have 9 rows
```

```{r}
# Join relative concentrations back to the main Cu data
Al_rel_data_to_join <- Al_rel_data %>%
  dplyr::select(SamplingEventID, rel_u_Al, rel_f_Al, rel_p_Al)

SalmonR_Al_with_rel <- SalmonR_Al %>%
  left_join(Al_rel_data_to_join, by = "SamplingEventID")

view(SalmonR_Al_with_rel)

# should have 19 rows
```

```{r}
# Create a dense x-axis and align values
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

Al_df_expanded <- full_sequence %>%
  left_join(Al_rel_data, by = "Rel_Water_Area_plotting")

Al_rel_data_to_plot <- Al_df_expanded %>%
  dplyr::select(-c(u_Al_mcg_per_l, f_Al_mcg_per_l, p_Al_mcg_per_l,
                   ref_u_Al, ref_f_Al, ref_p_Al)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Al_Anaktok_salmon <- Al_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(u_Al_mcg_per_l, f_Al_mcg_per_l, p_Al_mcg_per_l,
                   ref_u_Al, ref_f_Al, ref_p_Al)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Al_rel_data_to_plot <- Al_rel_data_to_plot %>%
  rows_update(Al_Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(Al_rel_data_to_plot)

```

Manual tweaks
```{r}
# set specific locations to 0 so that the values are 0 before the next tributary
Al_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(4.35, 4.7, 5.6, 6.2, 6.3, 7.2, 7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12),
  rel_u_Al = 0, rel_f_Al = 0, rel_p_Al = 0
) %>% mutate(across(everything(), as.numeric))

Al_rel_data_mod <- Al_rel_data_to_plot %>%
  rows_update(Al_mod_data, by = "Rel_Water_Area_plotting")


# Optional single-point override for aesthetic control (ctrl+shift+c to un hide the lines)
Al_rel_data_mod2 <- Al_rel_data_mod %>%
  mutate(rel_f_Al = dplyr::case_when(
    Rel_Water_Area_plotting == 4.75 ~ 50,
    TRUE ~ rel_f_Al
  ))

# check what value was there before manually changing it to manually set the legend
f_Al_val_4.75 <- Al_rel_data_to_plot %>%
  filter(Rel_Water_Area_plotting == 4.75) %>%
  pull(rel_f_Al)

p_Al_high_val <- Al_rel_data_to_plot %>%
  filter(Rel_Water_Area_plotting == 11.00) %>%
  pull(rel_p_Al)

print(f_Al_val_4.75)
print(p_Al_high_val)

```

Interpolation and filtering
```{r}
Al_rel_data_to_plot_interp <- Al_rel_data_mod2 %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

# Zero out region before first tributary (adjust indices if your sequence changes)
Al_rel_data_to_plot_interp[1:75, 6:8] <- 0

# Keep only >1 for heatmaps
f_Al_rel_data_to_plot_interp <- Al_rel_data_to_plot_interp %>% filter(rel_f_Al >= 1.01)
p_Al_rel_data_to_plot_interp <- Al_rel_data_to_plot_interp %>% filter(rel_p_Al >= 1.01)
```

## Trib heat plots
```{r}
# Filtered Cu heat
f_Al_heat <- ggplot(f_Al_rel_data_to_plot_interp,
                    aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Al)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() + DA_theme +
  theme(axis.text.y = element_blank(),
        legend.position = "none",
        axis.ticks.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.title = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm"))

# Particulate Cu heat
p_Al_heat <- ggplot(p_Al_rel_data_to_plot_interp,
                    aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_p_Al)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "#301934") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() + DA_theme +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "none",
        legend.margin = margin(2, 2, 0, 2),
        plot.margin = margin(0, 1, 1, 1),
        legend.title = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm"))

# Legends (optional saves)
# f_Al_heat_legend <- ggpubr::get_legend(f_Al_heat)
# ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/f_Al heat legend.png", cowplot::ggdraw(f_Al_heat_legend), width=1.5, height=1, dpi=300)
# 
# p_Al_heat_legend <- ggpubr::get_legend(p_Al_heat)
# ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/p_Al heat legend.png", cowplot::ggdraw(p_Al_heat_legend), width=1.5, height=1, dpi=300)

# Combine Cu heatmaps
Salmon_Al_combined <- p_Al_heat / f_Al_heat
Salmon_Al_combined

```

## Area plot
```{r}
SalmonR_Al_area <- ggplot() +
  geom_area(data = MS_u_Al_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "grey30") +
  geom_line(data = MS_u_Al_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            color = "grey28", linewidth = 0.5) +
  geom_area(data = MS_f_Al_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#2daa9e") +
  geom_line(data = MS_f_Al_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            color = "#1d6e66", linewidth = 0.4) +
  # If you have MS_f_Cu_long like the Zn version, update the name; otherwise remove this layer
  geom_point(data = MS_f_Al_area,
             aes(x = Rel_Water_Area_plotting, y = Metal_conc),
             pch = 19, color = "black", size = 2) +
  geom_point(data = MS_u_Al_area,
             aes(x = Rel_Water_Area_plotting, y = Metal_conc),
             pch = 19, color = "black", size = 2) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
  
  coord_cartesian(x = c(1,22.5), y = c(1,6000)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  #scale_y_continuous(breaks = c(0,10, 100,1000,1500), labels = c(0, 10,100,1000,1500), sec.axis = dup_axis(), expand = expansion(mult = c(0.02, 0.02))) +
  scale_y_log10(
    breaks = breaks,
    labels = parse(text = labels),
    expand = expansion(mult = c(0.02, 0.02)),
    sec.axis = dup_axis()
  ) +
  annotation_logticks(sides = "lr") +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  theme(axis.text.y.right = element_blank()
        ,axis.text.y.left = element_blank()
        ) +
  DA_theme

SalmonR_Al_area
#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Al area.png", SalmonR_Al_area, width = 3.6, height = 2.1, dpi = 300)

```

## Combo
```{r}
SalmonR_Al_area_combo <- (
  Salmon_Al_combined / SalmonR_Al_area +
  plot_layout(ncol = 1, nrow = 3, heights = c(1, 1, 6), guides = "collect")
) 
  theme(
    plot.margin = margin(1, 1, 1, 1),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA),
    legend.position = "none",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9),
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
    legend.spacing = unit(0.1, "cm")
  )

SalmonR_Al_area_combo
ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Al area plus heat plot_without labels.png", SalmonR_Al_area_combo, width = 3.6, height = 2.15, dpi = 300)
```

# REE
## Data frames
```{r}
SalmonR_REE <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting,
                u_REE, f_REE, p_REE) %>%
  filter(!is.na(Rel_Water_Area_plotting))

SalmonR_REE <- SalmonR_REE %>%
  mutate(p_REE = if_else(
    p_REE == 0.000,
    (sqrt(2) / 2) * 0.01,
    p_REE
  ))

# view(SalmonR_REE)

```

Mainstem DF
```{r}
SalmonR_MS_REE_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_REE, u_REE) %>%
  pivot_longer(
    cols = c(f_REE, u_REE),
    names_to = "Metal_type",
    names_pattern = "^(.)_REE",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

MS_f_REE_area <- SalmonR_MS_REE_area %>% filter(Metal_type == "f")
MS_u_REE_area <- SalmonR_MS_REE_area %>% filter(Metal_type == "u")

```

Tributary DF
```{r}
SalmonR_trib_REE_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_REE, u_REE) %>%
  pivot_longer(
    cols = c(f_REE, u_REE),
    names_to = "Metal_type",
    names_pattern = "^(.)_REE", 
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

trib_f_REE_area <- SalmonR_trib_REE_area %>% filter(Metal_type == "f")
trib_u_REE_area <- SalmonR_trib_REE_area %>% filter(Metal_type == "u")
```

Modifications for heat plots
```{r}
# Step 1: map tributary sample to nearest upstream MS reference
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745","SalmonR_Trib2_20230722_1911","SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945","SalmonR_Trib3_20230724_1140","SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311","SalmonR_Trib6_20230724_1428","SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753","SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

# Step 2: compute tributary:mainstem ratios
REE_rel_data <- SalmonR_REE %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(
    SalmonR_REE %>%
      dplyr::select(RefID = SamplingEventID,
                    ref_u_REE = u_REE,
                    ref_f_REE = f_REE,
                    ref_p_REE = p_REE),
    by = "RefID"
  ) %>%
  mutate(
    rel_u_REE = u_REE / ref_u_REE,
    rel_f_REE = f_REE / ref_f_REE,
    rel_p_REE = p_REE / ref_p_REE
  )

view(REE_rel_data)

#should have 9 rows
```

```{r}
# Join relative concentrations back to the main REE data
REE_rel_data_to_join <- REE_rel_data %>%
  dplyr::select(SamplingEventID, rel_u_REE, rel_f_REE, rel_p_REE)

SalmonR_REE_with_rel <- SalmonR_REE %>%
  left_join(REE_rel_data_to_join, by = "SamplingEventID")

view(SalmonR_REE_with_rel)

# should have 19 rows
```

```{r}
# Create a dense x-axis and align values
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

REE_df_expanded <- full_sequence %>%
  left_join(REE_rel_data, by = "Rel_Water_Area_plotting")

REE_rel_data_to_plot <- REE_df_expanded %>%
  dplyr::select(-c(u_REE, f_REE, p_REE,
                   ref_u_REE, ref_f_REE, ref_p_REE)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

REE_Anaktok_salmon <- REE_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(u_REE, f_REE, p_REE,
                   ref_u_REE, ref_f_REE, ref_p_REE)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

REE_rel_data_to_plot <- REE_rel_data_to_plot %>%
  rows_update(REE_Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(REE_rel_data_to_plot)

```

Manual tweaks
```{r}
# set specific locations to 0 so that the values are 0 before the next tributary
REE_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(4.35, 4.7, 5.6, 6.2, 6.3, 7.2, 7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12),
  rel_u_REE = 0, rel_f_REE = 0, rel_p_REE = 0
) %>% mutate(across(everything(), as.numeric))

REE_rel_data_mod <- REE_rel_data_to_plot %>%
  rows_update(REE_mod_data, by = "Rel_Water_Area_plotting")

REE_rel_data_mod2 <- REE_rel_data_mod %>%
  mutate(rel_p_REE = dplyr::case_when(
    Rel_Water_Area_plotting == 11.00 ~ 15,
    TRUE ~ rel_p_REE
  )) %>%
  mutate(rel_f_REE = dplyr::case_when(
    Rel_Water_Area_plotting == 4.75 ~ 25,
    TRUE ~ rel_f_REE
  ))


# check what value was there before manually changing it to manually set the legend
# f_Al_val_4.75 <- Al_rel_data_to_plot %>%
#   filter(Rel_Water_Area_plotting == 4.75) %>%
#   pull(rel_f_Al)
# 
# p_Al_high_val <- Al_rel_data_to_plot %>%
#   filter(Rel_Water_Area_plotting == 11.00) %>%
#   pull(rel_p_Al)
# 
# print(f_Al_val_4.75)
# print(p_Al_high_val)

```

Interpolation and filtering
```{r}
REE_rel_data_to_plot_interp <- REE_rel_data_mod2 %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

REE_rel_data_to_plot_interp[1:75, 6:8] <- 0

f_REE_rel_data_to_plot_interp <- REE_rel_data_to_plot_interp %>% filter(rel_f_REE >= 1.01)
p_REE_rel_data_to_plot_interp <- REE_rel_data_to_plot_interp %>% filter(rel_p_REE >= 1.01)
```

## Trib heat plots
```{r}
# Filtered REE heat
f_REE_heat <- ggplot(f_REE_rel_data_to_plot_interp,
                     aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_REE)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() + DA_theme +
  theme(axis.text.y = element_blank(),
        legend.position = "top",
        axis.ticks.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.title = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm"))

# Particulate REE heat
p_REE_heat <- ggplot(p_REE_rel_data_to_plot_interp,
                     aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_p_REE)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "#301934") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() + DA_theme +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "top",
        legend.margin = margin(2, 2, 0, 2),
        plot.margin = margin(0, 1, 1, 1),
        legend.title = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm"))

# Combine REE heatmaps
Salmon_REE_combined <- p_REE_heat / f_REE_heat
Salmon_REE_combined

```

## Area plot
```{r}
SalmonR_REE_area <- ggplot() +
  geom_area(data = MS_u_REE_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "grey30") +
  geom_line(data = MS_u_REE_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            color = "grey28", linewidth = 0.5) +
  geom_area(data = MS_f_REE_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#2daa9e") +
  geom_line(data = MS_f_REE_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            color = "#1d6e66", linewidth = 0.4) +
  geom_point(data = MS_f_REE_area,
             aes(x = Rel_Water_Area_plotting, y = Metal_conc),
             pch = 19, color = "black", size = 2) +
  geom_point(data = MS_u_REE_area,
             aes(x = Rel_Water_Area_plotting, y = Metal_conc),
             pch = 19, color = "black", size = 2) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
  coord_cartesian(x = c(1,22.5), y = c(0,125)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  scale_y_continuous(breaks = c(0,12.5,25,37.5,50,62.5,75,87.5,100,112.5,125), labels = c(0,"","", "",50,"","","",100,"",""), sec.axis = dup_axis(), expand = expansion(mult = c(0.02, 0.02))) +
  # scale_y_log10(
  #   breaks = breaks,
  #   labels = parse(text = labels),
  #   expand = expansion(mult = c(0.02, 0.02)),
  #   sec.axis = dup_axis()
  # ) +
  # annotation_logticks(sides = "lr") +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  theme(axis.text.y.right = element_blank()
        ,axis.text.y.left = element_blank()
        ) +
  DA_theme

SalmonR_REE_area

#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/REE area.png", SalmonR_REE_area, width = 3.6, height = 2.1, dpi = 300)

```

## Combo
```{r}
SalmonR_REE_area_combo <- (
  Salmon_REE_combined / SalmonR_REE_area +
  plot_layout(ncol = 1, nrow = 3, heights = c(1, 1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA),
    legend.position = "none",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9),
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
    legend.spacing = unit(0.1, "cm")
  )

SalmonR_REE_area_combo
ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/REE area plus heat plot_without labels.png",SalmonR_REE_area_combo, width = 3.6, height = 2.1, dpi = 300)

```

# Co
## Data frames
```{r}
SalmonR_Co <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting,
                u_Co_mcg_per_l, f_Co_mcg_per_l, p_Co_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

SalmonR_Co <- SalmonR_Co %>%
  mutate(p_Co_mcg_per_l = if_else(
    p_Co_mcg_per_l == 0.000,
    (sqrt(2) / 2) * 0.01,
    p_Co_mcg_per_l
  ))

# view(SalmonR_Co)
```

```{r}
SalmonR_MS_Co_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Co_mcg_per_l, u_Co_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Co_mcg_per_l, u_Co_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Co",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

MS_f_Co_area <- SalmonR_MS_Co_area %>% filter(Metal_type == "f")
MS_u_Co_area <- SalmonR_MS_Co_area %>% filter(Metal_type == "u")

```

```{r}
SalmonR_trib_Co_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Co_mcg_per_l, u_Co_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Co_mcg_per_l, u_Co_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Co", 
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

trib_f_Co_area <- SalmonR_trib_Co_area %>% filter(Metal_type == "f")
trib_u_Co_area <- SalmonR_trib_Co_area %>% filter(Metal_type == "u")

```

## Trib heat plot
```{r}
# Step 1: map tributary sample to nearest upstream MS reference
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745","SalmonR_Trib2_20230722_1911","SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945","SalmonR_Trib3_20230724_1140","SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311","SalmonR_Trib6_20230724_1428","SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753","SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

# Step 2: compute tributary:mainstem ratios
Co_rel_data <- SalmonR_Co %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(
    SalmonR_Co %>%
      dplyr::select(RefID = SamplingEventID,
                    ref_u_Co = u_Co_mcg_per_l,
                    ref_f_Co = f_Co_mcg_per_l,
                    ref_p_Co = p_Co_mcg_per_l),
    by = "RefID"
  ) %>%
  mutate(
    rel_u_Co = u_Co_mcg_per_l / ref_u_Co,
    rel_f_Co = f_Co_mcg_per_l / ref_f_Co,
    rel_p_Co = p_Co_mcg_per_l / ref_p_Co
  )

view(Co_rel_data)

#should have 9 rows

```

```{r}
# Join relative concentrations back to the main Co data
Co_rel_data_to_join <- Co_rel_data %>%
  dplyr::select(SamplingEventID, rel_u_Co, rel_f_Co, rel_p_Co)

SalmonR_Co_with_rel <- SalmonR_Co %>%
  left_join(Co_rel_data_to_join, by = "SamplingEventID")

view(SalmonR_Co_with_rel)

# should have 19 rows
```

```{r}
# Create a dense x-axis and align values
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

Co_df_expanded <- full_sequence %>%
  left_join(Co_rel_data, by = "Rel_Water_Area_plotting")

Co_rel_data_to_plot <- Co_df_expanded %>%
  dplyr::select(-c(u_Co_mcg_per_l, f_Co_mcg_per_l, p_Co_mcg_per_l,
                   ref_u_Co, ref_f_Co, ref_p_Co)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Co_Anaktok_salmon <- Co_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(u_Co_mcg_per_l, f_Co_mcg_per_l, p_Co_mcg_per_l,
                   ref_u_Co, ref_f_Co, ref_p_Co)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Co_rel_data_to_plot <- Co_rel_data_to_plot %>%
  rows_update(Co_Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(Co_rel_data_to_plot)

```

```{r}
# set specific locations to 0 so that the values are 0 before the next tributary
Co_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(4.35, 4.7, 5.6, 6.2, 6.3, 7.2, 7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12),
  rel_u_Co = 0, rel_f_Co = 0, rel_p_Co = 0
) %>% mutate(across(everything(), as.numeric))

Co_rel_data_mod <- Co_rel_data_to_plot %>%
  rows_update(Co_mod_data, by = "Rel_Water_Area_plotting")

Co_rel_data_mod2 <- Co_rel_data_mod %>%
  mutate(rel_p_Co = dplyr::case_when(
    Rel_Water_Area_plotting == 9.00 ~ 400,
    TRUE ~ rel_p_Co
  )) %>%
  mutate(rel_p_Co = dplyr::case_when(
    Rel_Water_Area_plotting == 3.75 ~ 200,
    TRUE ~ rel_p_Co
  )) %>%
  mutate(rel_p_Co = dplyr::case_when(
    Rel_Water_Area_plotting == 6.35 ~ 60,
    TRUE ~ rel_p_Co
  )) %>%
  mutate(rel_p_Co = dplyr::case_when(
    Rel_Water_Area_plotting == 6.25 ~ 100,
    TRUE ~ rel_p_Co
  )) %>%
  mutate(rel_p_Co = dplyr::case_when(
    Rel_Water_Area_plotting == 11.00 ~ 20,
    TRUE ~ rel_p_Co
  )) %>%
  mutate(rel_f_Co = dplyr::case_when(
    Rel_Water_Area_plotting == 4.75 ~ 100,
    TRUE ~ rel_f_Co
  ))

# check what value was there before manually changing it to manually set the legend
# f_Co_val_4.75 <- Co_rel_data_to_plot %>% filter(Rel_Water_Area_plotting == 4.75) %>% pull(rel_f_Co)
# p_Co_high_val <- Co_rel_data_to_plot %>% filter(Rel_Water_Area_plotting == 11.00) %>% pull(rel_p_Co)
# print(f_Co_val_4.75); print(p_Co_high_val)

```

```{r}
Co_rel_data_to_plot_interp <- Co_rel_data_mod2 %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

Co_rel_data_to_plot_interp[1:75, 6:8] <- 0

f_Co_rel_data_to_plot_interp <- Co_rel_data_to_plot_interp %>% filter(rel_f_Co >= 1.01)
p_Co_rel_data_to_plot_interp <- Co_rel_data_to_plot_interp %>% filter(rel_p_Co >= 1.01)

```

```{r}
# Filtered Co heat
f_Co_heat <- ggplot(f_Co_rel_data_to_plot_interp,
                    aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Co)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() + DA_theme +
  theme(axis.text.y = element_blank(),
        legend.position = "top",
        axis.ticks.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.title = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm"))

# Particulate Co heat
p_Co_heat <- ggplot(p_Co_rel_data_to_plot_interp,
                    aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_p_Co)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "#301934") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() + DA_theme +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "top",
        legend.margin = margin(2, 2, 0, 2),
        plot.margin = margin(0, 1, 1, 1),
        legend.title = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm"))

# Combine Co heatmaps
Salmon_Co_combined <- p_Co_heat / f_Co_heat
Salmon_Co_combined

```

## Area plot
```{r}
SalmonR_Co_area <- ggplot() +
  geom_area(data = MS_u_Co_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "grey30") +
  geom_line(data = MS_u_Co_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            color = "grey28", linewidth = 0.5) +
  geom_area(data = MS_f_Co_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#2daa9e") +
  geom_line(data = MS_f_Co_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            color = "#1d6e66", linewidth = 0.4) +
  geom_point(data = MS_f_Co_area,
             aes(x = Rel_Water_Area_plotting, y = Metal_conc),
             pch = 21, fill = "white", color = "black", size = 2) +
  geom_point(data = MS_u_Co_area,
             aes(x = Rel_Water_Area_plotting, y = Metal_conc),
             pch = 19, color = "black", size = 2) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
  coord_cartesian(x = c(1,22.5), y = c(0,200)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  scale_y_continuous(breaks = c(0,25,50,75,100,125,150,175,200),
                     labels = c(0,"",50,"",100,"",150,"",200),
                     sec.axis = dup_axis(),
                     expand = expansion(mult = c(0.02, 0.02))) +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  theme(
    axis.text.y.right = element_blank(),
        axis.text.y.left = element_blank()
    ) +
  DA_theme

SalmonR_Co_area

#ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Co area_with labels.png", SalmonR_Co_area, width = 3.6, height = 2.1, dpi = 300)

```

## Combo
```{r}
SalmonR_Co_area_combo <- (
  Salmon_Co_combined / SalmonR_Co_area +
  plot_layout(ncol = 1, nrow = 3, heights = c(1, 1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA),
    legend.position = "none",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9),
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
    legend.spacing = unit(0.1, "cm")
  )

SalmonR_Co_area_combo

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Co area plus heat plot_without labels.png", SalmonR_Co_area_combo, width = 3.6, height = 2.1, dpi = 300)

```

```{r}

```

# Ba
## Data frames
```{r}
SalmonR_Ba <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting,
                u_Ba_mcg_per_l, f_Ba_mcg_per_l, p_Ba_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

SalmonR_Ba <- SalmonR_Ba %>%
  mutate(p_Ba_mcg_per_l = if_else(
    p_Ba_mcg_per_l == 0.000,
    (sqrt(2) / 2) * 0.01,
    p_Ba_mcg_per_l
  ))

# view(SalmonR_Ba)
```

```{r}
SalmonR_MS_Ba_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Ba_mcg_per_l, u_Ba_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Ba_mcg_per_l, u_Ba_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Ba_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

MS_f_Ba_area <- SalmonR_MS_Ba_area %>% filter(Metal_type == "f")
MS_u_Ba_area <- SalmonR_MS_Ba_area %>% filter(Metal_type == "u")

```

```{r}
SalmonR_trib_Ba_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Ba_mcg_per_l, u_Ba_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Ba_mcg_per_l, u_Ba_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Ba_mcg_per_l",   # fixed from Fe → Cu
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

trib_f_Ba_area <- SalmonR_trib_Ba_area %>% filter(Metal_type == "f")
trib_u_Ba_area <- SalmonR_trib_Ba_area %>% filter(Metal_type == "u")

```

## Trib heat plots
```{r}
# Step 1: map tributary sample to nearest upstream MS reference
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745","SalmonR_Trib2_20230722_1911","SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945","SalmonR_Trib3_20230724_1140","SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311","SalmonR_Trib6_20230724_1428","SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753","SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

# Step 2: compute tributary:mainstem ratios
Ba_rel_data <- SalmonR_Ba %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(
    SalmonR_Ba %>%
      dplyr::select(RefID = SamplingEventID,
                    ref_u_Ba = u_Ba_mcg_per_l,
                    ref_f_Ba = f_Ba_mcg_per_l,
                    ref_p_Ba = p_Ba_mcg_per_l),
    by = "RefID"
  ) %>%
  mutate(
    rel_u_Ba = u_Ba_mcg_per_l / ref_u_Ba,
    rel_f_Ba = f_Ba_mcg_per_l / ref_f_Ba,
    rel_p_Ba = p_Ba_mcg_per_l / ref_p_Ba
  )

view(Ba_rel_data)

#should have 9 rows

```

Join back to main df
```{r}
Ba_rel_data_to_join <- Ba_rel_data %>%
  dplyr::select(SamplingEventID, rel_u_Ba, rel_f_Ba, rel_p_Ba)

SalmonR_Ba_with_rel <- SalmonR_Ba %>%
  left_join(Ba_rel_data_to_join, by = "SamplingEventID")

view(SalmonR_Ba_with_rel)

# should have 19 rows
```

```{r}
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

Ba_df_expanded <- full_sequence %>%
  left_join(Ba_rel_data, by = "Rel_Water_Area_plotting")

Ba_rel_data_to_plot <- Ba_df_expanded %>%
  dplyr::select(-c(u_Ba_mcg_per_l, f_Ba_mcg_per_l, p_Ba_mcg_per_l,
                   ref_u_Ba, ref_f_Ba, ref_p_Ba)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Ba_Anaktok_salmon <- Ba_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(u_Ba_mcg_per_l, f_Ba_mcg_per_l, p_Ba_mcg_per_l,
                   ref_u_Ba, ref_f_Ba, ref_p_Ba)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Ba_rel_data_to_plot <- Ba_rel_data_to_plot %>%
  rows_update(Ba_Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(Ba_rel_data_to_plot)

```

```{r}
Ba_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(4.35, 4.7, 5.6, 6.2, 6.3, 7.2, 7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12),
  rel_u_Ba = 0, rel_f_Ba = 0, rel_p_Ba = 0
) %>% mutate(across(everything(), as.numeric))

Ba_rel_data_mod <- Ba_rel_data_to_plot %>%
  rows_update(Ba_mod_data, by = "Rel_Water_Area_plotting")

Ba_rel_data_mod2 <- Ba_rel_data_mod %>%
  mutate(rel_p_Ba = dplyr::case_when(
    Rel_Water_Area_plotting == 3.75 ~ 25,
    TRUE ~ rel_p_Ba
  ))
 
# f_Ba_val_4.75 <- Ba_rel_data_to_plot %>%
#   filter(Rel_Water_Area_plotting == 4.75) %>%
#   pull(rel_f_Ba)
# 
# p_Ba_high_val <- Ba_rel_data_to_plot %>%
#   filter(Rel_Water_Area_plotting == 11.00) %>%
#   pull(rel_p_Ba)
# 
# print(f_Ba_val_4.75)
# print(p_Ba_high_val)

```

```{r}
Ba_rel_data_to_plot_interp <- Ba_rel_data_mod2 %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

Ba_rel_data_to_plot_interp[1:75, 6:8] <- 0

f_Ba_rel_data_to_plot_interp <- Ba_rel_data_to_plot_interp %>% filter(rel_f_Ba >= 1.01)
p_Ba_rel_data_to_plot_interp <- Ba_rel_data_to_plot_interp %>% filter(rel_p_Ba >= 1.01)

```

```{r}
f_Ba_heat <- ggplot(f_Ba_rel_data_to_plot_interp,
                     aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Ba)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() + DA_theme +
  theme(axis.text.y = element_blank(),
        legend.position = "top",
        axis.ticks.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.title = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm"))

p_Ba_heat <- ggplot(p_Ba_rel_data_to_plot_interp,
                     aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_p_Ba)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "#301934") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() + DA_theme +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "top",
        legend.margin = margin(2, 2, 0, 2),
        plot.margin = margin(0, 1, 1, 1),
        legend.title = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm"))

Salmon_Ba_combined <- p_Ba_heat / f_Ba_heat
Salmon_Ba_combined

```

## Area plot
```{r}
SalmonR_Ba_area <- ggplot() +
  geom_area(data = MS_u_Ba_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "grey30") +
  geom_line(data = MS_u_Ba_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            color = "grey28", linewidth = 0.5) +
  geom_area(data = MS_f_Ba_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#2daa9e") +
  geom_line(data = MS_f_Ba_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            color = "#1d6e66", linewidth = 0.4) +
  geom_point(data = MS_f_Ba_area,
             aes(x = Rel_Water_Area_plotting, y = Metal_conc),
             pch = 19, color = "black", size = 2) +
  geom_point(data = MS_u_Ba_area,
             aes(x = Rel_Water_Area_plotting, y = Metal_conc),
             pch = 19, color = "black", size = 2) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
    coord_cartesian(x = c(1,22.5), y = c(0,37)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  scale_y_continuous(breaks = c(0,5,10,15,20,25,30,35), labels = c(0,"",10,"",20,"",30,""), sec.axis = dup_axis(), expand = expansion(mult = c(0.02, 0.02))) +
  # scale_y_log10(
  #   breaks = breaks,
  #   labels = parse(text = labels),
  #   expand = expansion(mult = c(0.02, 0.02)),
  #   sec.axis = dup_axis()
  # ) +
  # annotation_logticks(sides = "lr") +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  theme(axis.text.y.right = element_blank(),
        axis.text.y.left = element_blank()) +
  DA_theme

SalmonR_Ba_area

```

## Combo
```{r}
SalmonR_Ba_area_combo <- (
  Salmon_Ba_combined / SalmonR_Ba_area +
  plot_layout(ncol = 1, nrow = 3, heights = c(1, 1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA),
    legend.position = "none",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9),
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
    legend.spacing = unit(0.1, "cm")
  )

SalmonR_Ba_area_combo

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Ba area plus heat plot_without labels.png", SalmonR_Ba_area_combo, width = 3.6, height = 2.1, dpi = 300)
```

# Se
## Data frames
```{r}
SalmonR_Se <- SalmonR_2023_river_data %>%
  dplyr::select(SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting,
                u_Se_mcg_per_l, f_Se_mcg_per_l, p_Se_mcg_per_l) %>%
  filter(!is.na(Rel_Water_Area_plotting))

SalmonR_Se <- SalmonR_Se %>%
  mutate(p_Se_mcg_per_l = if_else(
    p_Se_mcg_per_l == 0.000,
    (sqrt(2) / 2) * 0.01,
    p_Se_mcg_per_l
  ))

# view(SalmonR_Se)

```

```{r}
SalmonR_MS_Se_area <- SalmonR_filtered_MS %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Se_mcg_per_l, u_Se_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Se_mcg_per_l, u_Se_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Se_mcg_per_l",
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

MS_f_Se_area <- SalmonR_MS_Se_area %>% filter(Metal_type == "f")
MS_u_Se_area <- SalmonR_MS_Se_area %>% filter(Metal_type == "u")

```

```{r}
SalmonR_trib_Se_area <- SalmonR_filtered_Trib %>%
  dplyr::select(SamplingEventID, Rel_Water_Area_plotting, f_Se_mcg_per_l, u_Se_mcg_per_l) %>%
  pivot_longer(
    cols = c(f_Se_mcg_per_l, u_Se_mcg_per_l),
    names_to = "Metal_type",
    names_pattern = "^(.)_Se_mcg_per_l",   # fixed from Fe → Cu
    values_to = "Metal_conc"
  ) %>%
  filter(!is.na(Metal_conc))

trib_f_Se_area <- SalmonR_trib_Se_area %>% filter(Metal_type == "f")
trib_u_Se_area <- SalmonR_trib_Se_area %>% filter(Metal_type == "u")

```

## Trib heat plots
```{r}
# Step 1: map tributary sample to nearest upstream MS reference
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745","SalmonR_Trib2_20230722_1911","SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945","SalmonR_Trib3_20230724_1140","SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311","SalmonR_Trib6_20230724_1428","SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753","SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

# Step 2: compute tributary:mainstem ratios
Se_rel_data <- SalmonR_Se %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(
    SalmonR_Se %>%
      dplyr::select(RefID = SamplingEventID,
                    ref_u_Se = u_Se_mcg_per_l,
                    ref_f_Se = f_Se_mcg_per_l,
                    ref_p_Se = p_Se_mcg_per_l),
    by = "RefID"
  ) %>%
  mutate(
    rel_u_Se = u_Se_mcg_per_l / ref_u_Se,
    rel_f_Se = f_Se_mcg_per_l / ref_f_Se,
    rel_p_Se = p_Se_mcg_per_l / ref_p_Se
  )

view(Se_rel_data)

#should have 9 rows

```

```{r}
Se_rel_data_to_join <- Se_rel_data %>%
  dplyr::select(SamplingEventID, rel_u_Se, rel_f_Se, rel_p_Se)

SalmonR_Se_with_rel <- SalmonR_Se %>%
  left_join(Se_rel_data_to_join, by = "SamplingEventID")

view(SalmonR_Se_with_rel)

# should have 19 rows

```

```{r}
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

Se_df_expanded <- full_sequence %>%
  left_join(Se_rel_data, by = "Rel_Water_Area_plotting")

Se_rel_data_to_plot <- Se_df_expanded %>%
  dplyr::select(-c(u_Se_mcg_per_l, f_Se_mcg_per_l, p_Se_mcg_per_l,
                   ref_u_Se, ref_f_Se, ref_p_Se)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Se_Anaktok_salmon <- Se_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(u_Se_mcg_per_l, f_Se_mcg_per_l, p_Se_mcg_per_l,
                   ref_u_Se, ref_f_Se, ref_p_Se)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Se_rel_data_to_plot <- Se_rel_data_to_plot %>%
  rows_update(Se_Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(Se_rel_data_to_plot)

```

```{r}
Se_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(4.35, 4.7, 5.6, 6.2, 6.3, 7.2, 7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12),
  rel_u_Se = 0, rel_f_Se = 0, rel_p_Se = 0
) %>% mutate(across(everything(), as.numeric))

Se_rel_data_mod <- Se_rel_data_to_plot %>%
  rows_update(Se_mod_data, by = "Rel_Water_Area_plotting")

Se_rel_data_mod2 <- Se_rel_data_mod %>%
  mutate(rel_f_Se = dplyr::case_when(
    Rel_Water_Area_plotting == 4.75 ~ 10,
    TRUE ~ rel_f_Se
  ))

# f_Se_val_4.75 <- Se_rel_data_to_plot %>%
#   filter(Rel_Water_Area_plotting == 4.75) %>%
#   pull(rel_f_Se)
# 
# p_Se_high_val <- Se_rel_data_to_plot %>%
#   filter(Rel_Water_Area_plotting == 11.00) %>%
#   pull(rel_p_Se)
# 
# print(f_Se_val_4.75)
# print(p_Se_high_val)

```

```{r}
Se_rel_data_to_plot_interp <- Se_rel_data_mod2 %>%
  mutate(across(
    .cols = where(is.numeric) & !matches("Rel_Water_Area_plotting"),
    .fns = ~ na.approx(., x = Rel_Water_Area_plotting, na.rm = FALSE, rule = 2)
  ))

Se_rel_data_to_plot_interp[1:75, 6:8] <- 0

f_Se_rel_data_to_plot_interp <- Se_rel_data_to_plot_interp %>% filter(rel_f_Se >= 1.01)
p_Se_rel_data_to_plot_interp <- Se_rel_data_to_plot_interp %>% filter(rel_p_Se >= 1.01)

```

```{r}
f_Se_heat <- ggplot(f_Se_rel_data_to_plot_interp,
                     aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_f_Se)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() + DA_theme +
  theme(axis.text.y = element_blank(),
        legend.position = "top",
        axis.ticks.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.title = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm"))

p_Se_heat <- ggplot(p_Se_rel_data_to_plot_interp,
                     aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_p_Se)) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_gradient(low = "white", high = "#301934") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  theme_minimal() + DA_theme +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "top",
        legend.margin = margin(2, 2, 0, 2),
        plot.margin = margin(0, 1, 1, 1),
        legend.title = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm"))

Salmon_Se_combined <- p_Se_heat / f_Se_heat
Salmon_Se_combined
```

## Area plot
```{r}
SalmonR_Se_area <- ggplot() +
  geom_area(data = MS_u_Se_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "grey30") +
  geom_line(data = MS_u_Se_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            color = "grey28", linewidth = 0.5) +
  geom_area(data = MS_f_Se_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            fill = "#2daa9e") +
  geom_line(data = MS_f_Se_area,
            aes(x = Rel_Water_Area_plotting, y = Metal_conc),
            color = "#1d6e66", linewidth = 0.4) +
  geom_point(data = MS_f_Se_area,
             aes(x = Rel_Water_Area_plotting, y = Metal_conc),
             pch = 19, color = "black", size = 2) +
  geom_point(data = MS_u_Se_area,
             aes(x = Rel_Water_Area_plotting, y = Metal_conc),
             pch = 19, color = "black", size = 2) +
  geom_vline(xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
             linetype = "dashed", color = "grey15", linewidth = 0.5) +
    coord_cartesian(x = c(1,22.5), y = c(0,18)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  scale_y_continuous(breaks = c(0,2.5,5,7.5,10,12.5,15,17.5), labels = c(0,"",5,"",10,"",15,""), sec.axis = dup_axis(), expand = expansion(mult = c(0.02, 0.02))) +
  # scale_y_log10(
  #   breaks = breaks,
  #   labels = parse(text = labels),
  #   expand = expansion(mult = c(0.02, 0.02)),
  #   sec.axis = dup_axis()
  # ) +
  # annotation_logticks(sides = "lr") +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  theme(axis.text.y.right = element_blank(),
        axis.text.y.left = element_blank()) +
  DA_theme

SalmonR_Se_area

```

## combo
```{r}
SalmonR_Se_area_combo <- (
  Salmon_Se_combined / SalmonR_Se_area +
  plot_layout(ncol = 1, nrow = 3, heights = c(1, 1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA),
    legend.position = "none",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9),
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
    legend.spacing = unit(0.1, "cm")
  )

SalmonR_Se_area_combo

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Se area plus heat plot_without labels.png", SalmonR_Se_area_combo, width = 3.6, height = 2.1, dpi = 300)
```


# Alkalinity
## Data frames
```{r}
SalmonR_Alk <- SalmonR_2023_river_data %>%
  dplyr::select(
    SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting,
    Alk_mgCaCO3_per_l
  ) %>%
  filter(!is.na(Rel_Water_Area_plotting))

# view(SalmonR_Alk)

```

```{r}
SalmonR_MS_Alk_area <- SalmonR_filtered_MS %>%
  dplyr::select(
    SamplingEventID,
    Rel_Water_Area_plotting,
    Alk_mgCaCO3_per_l
  ) %>%
  pivot_longer(
    cols = Alk_mgCaCO3_per_l,
    names_to = "type",
    values_to = "conc"
  ) %>%
  filter(!is.na(conc))
```

```{r}
SalmonR_trib_Alk_area <- SalmonR_filtered_Trib %>%
  dplyr::select(
    SamplingEventID,
    Rel_Water_Area_plotting,
    Alk_mgCaCO3_per_l
  ) %>%
  pivot_longer(
    cols = Alk_mgCaCO3_per_l,
    names_to = "type",
    values_to = "conc"
  ) %>%
  filter(!is.na(conc))
```

```{r}
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745","SalmonR_Trib2_20230722_1911","SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945","SalmonR_Trib3_20230724_1140","SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311","SalmonR_Trib6_20230724_1428","SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753","SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)

Alk_rel_data <- SalmonR_Alk %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(
    SalmonR_Alk %>%
      dplyr::select(
        RefID = SamplingEventID,
        ref_Alk = Alk_mgCaCO3_per_l
      ),
    by = "RefID"
  ) %>%
  mutate(
    rel_Alk = Alk_mgCaCO3_per_l / ref_Alk
  )

view(Alk_rel_data)
# should have 9 rows

```

```{r}
Alk_rel_data_to_join <- Alk_rel_data %>%
  dplyr::select(SamplingEventID, rel_Alk)

SalmonR_Alk_with_rel <- SalmonR_Alk %>%
  left_join(Alk_rel_data_to_join, by = "SamplingEventID")

view(SalmonR_Alk_with_rel)
# should have 19 rows

```

```{r}
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

Alk_df_expanded <- full_sequence %>%
  left_join(Alk_rel_data, by = "Rel_Water_Area_plotting")

Alk_rel_data_to_plot <- Alk_df_expanded %>%
  dplyr::select(-c(Alk_mgCaCO3_per_l, ref_Alk)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Alk_Anaktok_salmon <- Alk_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(Alk_mgCaCO3_per_l, ref_Alk)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

Alk_rel_data_to_plot <- Alk_rel_data_to_plot %>%
  rows_update(Alk_Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(Alk_rel_data_to_plot)

```

```{r}
Alk_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(
    4.35, 4.7, 5.6, 6.2, 6.3, 7.2,
    7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12
  ),
  rel_Alk = 0
) %>% mutate(across(everything(), as.numeric))

Alk_rel_data_mod <- Alk_rel_data_to_plot %>%
  rows_update(Alk_mod_data, by = "Rel_Water_Area_plotting")

# Alk_rel_data_mod2 <- Alk_rel_data_mod %>%
#   mutate(rel_Alk = dplyr::case_when(
#     Rel_Water_Area_plotting == 4.75 ~ 10,
#     TRUE ~ rel_Alk
#   ))

```

```{r}
Alk_rel_data_to_plot_interp <- Alk_rel_data_mod %>%
  mutate(rel_Alk = na.approx(
    rel_Alk,
    x = Rel_Water_Area_plotting,
    na.rm = FALSE,
    rule = 2
  ))

Alk_rel_data_to_plot_interp[1:75, "rel_Alk"] <- 0

f_Alk_rel_data_to_plot_interp <- Alk_rel_data_to_plot_interp %>%
  filter(rel_Alk >= 1.01)

```

## Trib heat plot
```{r}
trib_Alk_heat <- ggplot(
  f_Alk_rel_data_to_plot_interp,
  aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_Alk)
) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(
    xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
    linetype = "dashed", color = "black", linewidth = 0.5
  ) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(
    breaks = DA_x_breaks,
    labels = DA_x_labels,
    expand = expansion(mult = c(0.035, 0.015))
  ) +
  theme_minimal() + DA_theme +
  theme(
    axis.text.y = element_blank(),
    legend.position = "top",
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.title = element_blank(),
    axis.ticks.length.x = unit(0.1, "cm")
  )

trib_Alk_heat

```

## Area plot
```{r}
SalmonR_Alk_area <- ggplot() +
  geom_area(data = SalmonR_MS_Alk_area,
            aes(x = Rel_Water_Area_plotting, y = conc),
            fill = "#2daa9e") +
  geom_line(data = SalmonR_MS_Alk_area,
            aes(x = Rel_Water_Area_plotting, y = conc),
            color = "#1d6e66", linewidth = 0.4) +
  geom_point(data = SalmonR_MS_Alk_area,
             aes(x = Rel_Water_Area_plotting, y = conc),
             pch = 19, color = "black", size = 2) +
  geom_vline(
    xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
    linetype = "dashed", color = "grey15", linewidth = 0.5
  ) +
  coord_cartesian(x = c(1,22.5), y = c(0,190)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  scale_y_continuous(breaks = c(0,25,50,75,100,125,150,175,200), labels = c(0,"",50,"",100,"",150,"",200), sec.axis = dup_axis(), expand = expansion(mult = c(0.02, 0.02))) +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  theme(axis.text.y.right = element_blank(),
        axis.text.y.left = element_blank()) +
  DA_theme

SalmonR_Alk_area

```

## Combo
```{r}
SalmonR_Alk_area_combo <- (
  trib_Alk_heat / SalmonR_Alk_area +
  plot_layout(ncol = 1, nrow = 2, heights = c(1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    legend.position = "none",
    legend.text = element_text(size = 8),       # smaller legend labels
    legend.title = element_text(size = 9),      # smaller legend title
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
  legend.spacing = unit(0.1, "cm"), # smaller boxes
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA)
  )

SalmonR_Alk_area_combo

ggsave("C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/Alk area plus heat plot_without labels.png", SalmonR_Alk_area_combo, width = 3.6, height = 1.8, dpi = 300)
```

# DIC
## Data frames
```{r}
SalmonR_DIC <- SalmonR_2023_river_data %>%
  dplyr::select(
    SamplingEventID, New_Grouping, Hyd_Classification, Rel_Water_Area_plotting,
    DIC_mgC_per_l
  ) %>%
  filter(!is.na(Rel_Water_Area_plotting))

# view(SalmonR_DIC)
```

```{r}
SalmonR_MS_DIC_area <- SalmonR_filtered_MS %>%
  dplyr::select(
    SamplingEventID,
    Rel_Water_Area_plotting,
    DIC_mgC_per_l
  ) %>%
  pivot_longer(
    cols = DIC_mgC_per_l,
    names_to = "type",
    values_to = "conc"
  ) %>%
  filter(!is.na(conc))

```

```{r}
SalmonR_trib_DIC_area <- SalmonR_filtered_Trib %>%
  dplyr::select(
    SamplingEventID,
    Rel_Water_Area_plotting,
    DIC_mgC_per_l
  ) %>%
  pivot_longer(
    cols = DIC_mgC_per_l,
    names_to = "type",
    values_to = "conc"
  ) %>%
  filter(!is.na(conc))
```

```{r}
ref_map <- tibble(
  SamplingEventID = c(
    "SalmonR_Trib1_20230722_1745","SalmonR_Trib2_20230722_1911","SheepC_1_20230719_0923",
    "Anaktok_1_20230723_1945","SalmonR_Trib3_20230724_1140","SalmonR_Trib4_20230724_1155",
    "SalmonR_Trib5_20230724_1311","SalmonR_Trib6_20230724_1428","SalmonR_Trib7_20230724_1453"
  ),
  RefID = c(
    "SalmonR_MS_above_Trib1_20230722_1753","SalmonR_MS_above_Trib2_20230722_1915",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_at_SheepC_20230719_0927",
    "SalmonR_MS_at_SheepC_20230719_0927","SalmonR_MS_above_Trib6_20230724_1439",
    "SalmonR_MS_above_Trib6_20230724_1439"
  )
)
```

```{r}
DIC_rel_data <- SalmonR_DIC %>%
  inner_join(ref_map, by = "SamplingEventID") %>%
  relocate(RefID, .after = SamplingEventID) %>%
  left_join(
    SalmonR_DIC %>%
      dplyr::select(
        RefID = SamplingEventID,
        ref_DIC = DIC_mgC_per_l
      ),
    by = "RefID"
  ) %>%
  mutate(
    rel_DIC = DIC_mgC_per_l / ref_DIC
  )

view(DIC_rel_data)
# should have 9 rows

```

```{r}
DIC_rel_data_to_join <- DIC_rel_data %>%
  dplyr::select(SamplingEventID, rel_DIC)

SalmonR_DIC_with_rel <- SalmonR_DIC %>%
  left_join(DIC_rel_data_to_join, by = "SamplingEventID")

view(SalmonR_DIC_with_rel)
# should have 19 rows

```

```{r}
full_sequence <- data.frame(Rel_Water_Area_plotting = seq(0, 22.5, by = 0.05))

DIC_df_expanded <- full_sequence %>%
  left_join(DIC_rel_data, by = "Rel_Water_Area_plotting")

DIC_rel_data_to_plot <- DIC_df_expanded %>%
  dplyr::select(-c(DIC_mgC_per_l, ref_DIC)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

DIC_Anaktok_salmon <- DIC_rel_data %>%
  filter(Rel_Water_Area_plotting == 6.35) %>%
  dplyr::select(-c(DIC_mgC_per_l, ref_DIC)) %>%
  mutate(Rel_Water_Area_plotting = round(as.numeric(Rel_Water_Area_plotting), 2))

DIC_rel_data_to_plot <- DIC_rel_data_to_plot %>%
  rows_update(DIC_Anaktok_salmon, by = "Rel_Water_Area_plotting")

view(DIC_rel_data_to_plot)

```

```{r}
DIC_mod_data <- data.frame(
  Rel_Water_Area_plotting = c(
    4.35, 4.7, 5.6, 6.2, 6.3, 7.2,
    7.95, 8.05, 8.6, 8.95, 9.9, 10.75, 10.95, 12
  ),
  rel_DIC = 0
) %>% mutate(across(everything(), as.numeric))

DIC_rel_data_mod <- DIC_rel_data_to_plot %>%
  rows_update(DIC_mod_data, by = "Rel_Water_Area_plotting")

```

```{r}
DIC_rel_data_to_plot_interp <- DIC_rel_data_mod %>%
  mutate(rel_DIC = na.approx(
    rel_DIC,
    x = Rel_Water_Area_plotting,
    na.rm = FALSE,
    rule = 2
  ))

DIC_rel_data_to_plot_interp[1:75, "rel_DIC"] <- 0

f_DIC_rel_data_to_plot_interp <- DIC_rel_data_to_plot_interp %>%
  filter(rel_DIC >= 1.01)

```

```{r}
trib_DIC_heat <- ggplot(
  f_DIC_rel_data_to_plot_interp,
  aes(x = Rel_Water_Area_plotting, y = 1, fill = rel_DIC)
) +
  geom_tile(color = NA, width = 0.05) +
  geom_vline(
    xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
    linetype = "dashed", color = "black", linewidth = 0.5
  ) +
  scale_fill_gradient(low = "white", high = "darkred") +
  labs(title = NULL, x = NULL, y = NULL, fill = "Tributary:Mainstem") +
  coord_cartesian(x = c(1, 22.5)) +
  scale_x_continuous(
    breaks = DA_x_breaks,
    labels = DA_x_labels,
    expand = expansion(mult = c(0.035, 0.015))
  ) +
  theme_minimal() + DA_theme +
  theme(
    axis.text.y = element_blank(),
    legend.position = "top",
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.title = element_blank(),
    axis.ticks.length.x = unit(0.1, "cm")
  )

trib_DIC_heat

```

```{r}
SalmonR_DIC_area <- ggplot() +
  geom_area(data = SalmonR_MS_DIC_area,
            aes(x = Rel_Water_Area_plotting, y = conc),
            fill = "#2daa9e") +
  geom_line(data = SalmonR_MS_DIC_area,
            aes(x = Rel_Water_Area_plotting, y = conc),
            color = "#1d6e66", linewidth = 0.4) +
  geom_point(data = SalmonR_MS_DIC_area,
             aes(x = Rel_Water_Area_plotting, y = conc),
             pch = 19, color = "black", size = 2) +
  geom_vline(
    xintercept = c(3.75, 6.35, 4.75, 6.25, 8.00, 8.10, 9.0, 10.8, 11),
    linetype = "dashed", color = "grey15", linewidth = 0.5
  ) +
  coord_cartesian(x = c(1,22.5), y = c(0,45)) +
  scale_x_continuous(breaks = DA_x_breaks, labels = DA_x_labels,
                     expand = expansion(mult = c(0.035, 0.015))) +
  scale_y_continuous(
    breaks = c(0,5,10,15,20,25,30,35,40,45),
    labels = c(0,"",10,"",20,"",30,"",40,""),
    sec.axis = dup_axis(),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  labs(x = NULL, y = NULL, title = NULL) +
  theme_minimal() +
  theme(axis.text.y.right = element_blank()
        #axis.text.y.left = element_blank()
        ) +
  DA_theme

SalmonR_DIC_area

```

## Combo
```{r}
SalmonR_DIC_area_combo <- (
  trib_DIC_heat / SalmonR_DIC_area +
  plot_layout(ncol = 1, nrow = 2, heights = c(1, 6), guides = "collect")
) &
  theme(
    plot.margin = margin(1, 1, 1, 1),
    legend.position = "none",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9),
    legend.key.size = unit(0.4, "cm"),
    legend.margin = margin(2, 2, 0, 2),
    legend.spacing = unit(0.1, "cm"),
    panel.background = element_rect(fill = NA, color = NA),
    plot.background = element_rect(fill = NA, color = NA)
  )

SalmonR_DIC_area_combo

ggsave(
  "C:/Users/tevinger/Box/Poulin Lab ETOX/Project Folders/Alaska BITE_HEAT (Taylor Evinger)/Evinger Manuscripts/Ferrum Manuscript/Figures/03_Downstream Analysis/DIC area plus heat plot_with labels.png",
  SalmonR_DIC_area_combo,
  width = 3.6,
  height = 1.8,
  dpi = 300
)
```
